/* esm.sh - esbuild bundle(langchain@0.0.73/embeddings) deno production */
import __Process$ from "https://deno.land/std@0.177.0/node/process.ts";import{Configuration as Q,OpenAIApi as Z}from"/v120/openai@3.2.1/deno/openai.mjs";import{isNode as q}from"/v120/browser-or-node@2.1.1/deno/browser-or-node.mjs";import f from"/v120/axios@1.4.0/deno/axios.mjs";var m="text/event-stream";async function I(e,t){let r=e.getReader(),n;for(;!(n=await r.read()).done;)t(n.value)}function P(e){let t,r,n,i=!1;return function(o){t===void 0?(t=o,r=0,n=-1):t=S(t,o);let s=t.length,u=0;for(;r<s;){i&&(t[r]===10&&(u=++r),i=!1);let l=-1;for(;r<s&&l===-1;++r)switch(t[r]){case 58:n===-1&&(n=r-u);break;case 13:i=!0;case 10:l=r;break}if(l===-1)break;e(t.subarray(u,l),n),u=r,n=-1}u===s?t=void 0:u!==0&&(t=t.subarray(u),r-=u)}}function v(e,t,r){let n=E(),i=new TextDecoder;return function(o,s){if(o.length===0)e?.(n),n=E();else if(s>0){let u=i.decode(o.subarray(0,s)),l=s+(o[s+1]===32?2:1),c=i.decode(o.subarray(l));switch(u){case"data":n.data=n.data?n.data+`
`+c:c;break;case"event":n.event=c;break;case"id":t?.(n.id=c);break;case"retry":{let N=parseInt(c,10);Number.isNaN(N)||r?.(n.retry=N);break}}}}}function S(e,t){let r=new Uint8Array(e.length+t.length);return r.set(e),r.set(t,e.length),r}function E(){return{data:"",event:"",id:"",retry:void 0}}function C(e){try{return JSON.stringify(e)}catch{return e}}function D(e,t,r){let{validateStatus:n}=r.config;!r.status||!n||n(r.status)?e(r):t(h(`Request failed with status code ${r.status} and body ${typeof r.data=="string"?r.data:C(r.data)}`,r.config,null,r.request,r))}function _(e){return/^([a-z][a-z\d+\-.]*:)?\/\//i.test(e)}function T(e,t){return t?e.replace(/\/+$/,"")+"/"+t.replace(/^\/+/,""):e}function z(e){return encodeURIComponent(e).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}function j(e,t,r){if(!t)return e;var n;if(r)n=r(t);else if(W(t))n=t.toString();else{var i=[];x(t,function(s,u){s===null||typeof s>"u"||(R(s)?u=`${u}[]`:s=[s],x(s,function(c){U(c)?c=c.toISOString():$(c)&&(c=JSON.stringify(c)),i.push(`${z(u)}=${z(c)}`)}))}),n=i.join("&")}if(n){var a=e.indexOf("#");a!==-1&&(e=e.slice(0,a)),e+=(e.indexOf("?")===-1?"?":"&")+n}return e}function k(e,t){return e&&!_(t)?T(e,t):t}function K(e){return typeof e>"u"}function $(e){return e!==null&&typeof e=="object"}function U(e){return toString.call(e)==="[object Date]"}function W(e){return toString.call(e)==="[object URLSearchParams]"}function R(e){return Array.isArray(e)}function x(e,t){if(!(e===null||typeof e>"u"))if(typeof e!="object"&&(e=[e]),R(e))for(var r=0,n=e.length;r<n;r++)t.call(null,e[r],r,e);else for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.call(null,e[i],i,e)}function L(e){return toString.call(e)==="[object FormData]"}function M(){return typeof navigator<"u"&&(navigator.product==="ReactNative"||navigator.product==="NativeScript"||navigator.product==="NS")?!1:typeof document<"u"&&typeof document<"u"}async function A(e){let t=V(e),r=await B(t,e);return new Promise((n,i)=>{r instanceof Error?i(r):Object.prototype.toString.call(e.settle)==="[object Function]"?e.settle(n,i,r):D(n,i,r)})}async function B(e,t){let r;try{r=await fetch(e)}catch(a){return a&&a.name==="AbortError"?h("Request aborted",t,"ECONNABORTED",e):a&&a.name==="TimeoutError"?h("Request timeout",t,"ECONNABORTED",e):h("Network Error",t,"ERR_NETWORK",e)}let n={};r.headers.forEach((a,o)=>{n[o]=a});let i={ok:r.ok,status:r.status,statusText:r.statusText,headers:n,config:t,request:e};if(r.status>=200&&r.status!==204)if(t.responseType==="stream"){let a=r.headers.get("content-type");if(!a?.startsWith(m)){if(r.status>=400)return a?.startsWith("application/json")?(i.data=await r.json(),i):(i.data=await r.text(),i);throw new Error(`Expected content-type to be ${m}, Actual: ${a}`)}await I(r.body,P(v(t.onmessage)))}else switch(t.responseType){case"arraybuffer":i.data=await r.arrayBuffer();break;case"blob":i.data=await r.blob();break;case"json":i.data=await r.json();break;case"formData":i.data=await r.formData();break;default:i.data=await r.text();break}return i}function V(e){let t=new Headers(e.headers);if(e.auth){let o=e.auth.username||"",s=e.auth.password?decodeURI(encodeURIComponent(e.auth.password)):"";t.set("Authorization",`Basic ${btoa(`${o}:${s}`)}`)}let r=e.method.toUpperCase(),n={headers:t,method:r};r!=="GET"&&r!=="HEAD"&&(n.body=e.data,L(n.body)&&M()&&t.delete("Content-Type")),e.mode&&(n.mode=e.mode),e.cache&&(n.cache=e.cache),e.integrity&&(n.integrity=e.integrity),e.redirect&&(n.redirect=e.redirect),e.referrer&&(n.referrer=e.referrer),e.timeout&&e.timeout>0&&(n.signal=AbortSignal.timeout(e.timeout)),e.signal&&(n.signal=e.signal),K(e.withCredentials)||(n.credentials=e.withCredentials?"include":"omit"),e.responseType==="stream"&&n.headers.set("Accept",m);let i=k(e.baseURL,e.url),a=j(i,e.params,e.paramsSerializer);return new Request(a,n)}function h(e,t,r,n,i){if(f.AxiosError&&typeof f.AxiosError=="function")return new f.AxiosError(e,f.AxiosError[r],t,n,i);let a=new Error(e);return Y(a,t,r,n,i)}function Y(e,t,r,n,i){return e.config=t,r&&(e.code=r),e.request=n,e.response=i,e.isAxiosError=!0,e.toJSON=function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:this.config,code:this.code,status:this.response&&this.response.status?this.response.status:null}},e}var b=(e,t)=>e.reduce((r,n,i)=>{let a=Math.floor(i/t),o=r[a]||[];return r[a]=o.concat([n]),r},[]);import F from"/v120/p-retry@4.6.2/deno/p-retry.mjs";import w from"/v120/p-queue@6.6.2/deno/p-queue.mjs";var J=[400,401,403,404,405,406,407,408,409],y=class{constructor(t){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=t.maxConcurrency??1/0,this.maxRetries=t.maxRetries??6;let r="default"in w?w.default:w;this.queue=new r({concurrency:this.maxConcurrency})}call(t,...r){return this.queue.add(()=>F(()=>t(...r).catch(n=>{throw n instanceof Error?n:new Error(n)}),{onFailedAttempt(n){if(n.message.startsWith("Cancel")||n.message.startsWith("TimeoutError")||n.message.startsWith("AbortError")||n?.code==="ECONNABORTED")throw n;let i=n?.response?.status;if(i&&J.includes(+i))throw n},retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}fetch(...t){return this.call(()=>fetch(...t).then(r=>r.ok?r:Promise.reject(r)))}};var d=class{constructor(t){Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.caller=new y(t??{})}};var O=class extends d{constructor(t,r){super(t??{}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:"text-embedding-ada-002"}),Object.defineProperty(this,"batchSize",{enumerable:!0,configurable:!0,writable:!0,value:512}),Object.defineProperty(this,"stripNewLines",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiVersion",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiInstanceName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiDeploymentName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"clientConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let n=t?.openAIApiKey??(typeof __Process$<"u"?__Process$.env?.OPENAI_API_KEY:void 0),i=t?.azureOpenAIApiKey??(typeof __Process$<"u"?__Process$.env?.AZURE_OPENAI_API_KEY:void 0);if(!i&&!n)throw new Error("(Azure) OpenAI API key not found");let a=t?.azureOpenAIApiInstanceName??(typeof __Process$<"u"?__Process$.env?.AZURE_OPENAI_API_INSTANCE_NAME:void 0),o=(t?.azureOpenAIApiEmbeddingsDeploymentName||t?.azureOpenAIApiDeploymentName)??(typeof __Process$<"u"?__Process$.env?.AZURE_OPENAI_API_EMBEDDINGS_DEPLOYMENT_NAME||__Process$.env?.AZURE_OPENAI_API_DEPLOYMENT_NAME:void 0),s=t?.azureOpenAIApiVersion??(typeof __Process$<"u"?__Process$.env?.AZURE_OPENAI_API_VERSION:void 0);if(this.modelName=t?.modelName??this.modelName,this.batchSize=t?.batchSize??this.batchSize,this.stripNewLines=t?.stripNewLines??this.stripNewLines,this.timeout=t?.timeout,this.azureOpenAIApiVersion=s,this.azureOpenAIApiKey=i,this.azureOpenAIApiInstanceName=a,this.azureOpenAIApiDeploymentName=o,this.azureOpenAIApiKey){if(!this.azureOpenAIApiInstanceName)throw new Error("Azure OpenAI API instance name not found");if(!this.azureOpenAIApiDeploymentName)throw new Error("Azure OpenAI API deployment name not found");if(!this.azureOpenAIApiVersion)throw new Error("Azure OpenAI API version not found")}this.clientConfig={apiKey:n,...r}}async embedDocuments(t){let r=b(this.stripNewLines?t.map(i=>i.replaceAll(`
`," ")):t,this.batchSize),n=[];for(let i=0;i<r.length;i+=1){let a=r[i],{data:o}=await this.embeddingWithRetry({model:this.modelName,input:a});for(let s=0;s<a.length;s+=1)n.push(o.data[s].embedding)}return n}async embedQuery(t){let{data:r}=await this.embeddingWithRetry({model:this.modelName,input:this.stripNewLines?t.replaceAll(`
`," "):t});return r.data[0].embedding}async embeddingWithRetry(t){if(!this.client){let n=this.azureOpenAIApiKey?`https://${this.azureOpenAIApiInstanceName}.openai.azure.com/openai/deployments/${this.azureOpenAIApiDeploymentName}`:this.clientConfig.basePath,i=new Q({...this.clientConfig,basePath:n,baseOptions:{timeout:this.timeout,adapter:q?void 0:A,...this.clientConfig.baseOptions}});this.client=new Z(i)}let r={};return this.azureOpenAIApiKey&&(r.headers={"api-key":this.azureOpenAIApiKey,...r.headers},r.params={"api-version":this.azureOpenAIApiVersion,...r.params}),this.caller.call(this.client.createEmbedding.bind(this.client),t,r)}};var p=class extends d{constructor(t){super(t??{}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:"small"}),Object.defineProperty(this,"batchSize",{enumerable:!0,configurable:!0,writable:!0,value:48}),Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let r=t?.apiKey||(typeof __Process$<"u"?__Process$.env?.COHERE_API_KEY:void 0);if(!r)throw new Error("Cohere API key not found");this.modelName=t?.modelName??this.modelName,this.batchSize=t?.batchSize??this.batchSize,this.apiKey=r}async embedDocuments(t){await this.maybeInitClient();let r=b(t,this.batchSize),n=[];for(let i=0;i<r.length;i+=1){let a=r[i],{body:o}=await this.embeddingWithRetry({model:this.modelName,texts:a});for(let s=0;s<a.length;s+=1)n.push(o.embeddings[s])}return n}async embedQuery(t){await this.maybeInitClient();let{body:r}=await this.embeddingWithRetry({model:this.modelName,texts:[t]});return r.embeddings[0]}async embeddingWithRetry(t){return await this.maybeInitClient(),this.caller.call(this.client.embed.bind(this.client),t)}async maybeInitClient(){if(!this.client){let{cohere:t}=await p.imports();this.client=t,this.client.init(this.apiKey)}}static async imports(){try{let{default:t}=await import("/v120/cohere-ai@5.1.0/deno/cohere-ai.mjs");return{cohere:t}}catch{throw new Error("Please install cohere-ai as a dependency with, e.g. `yarn add cohere-ai`")}}};var g=class extends d{constructor(t){super(t??{})}embedDocuments(t){return Promise.resolve(t.map(()=>[.1,.2,.3,.4]))}embedQuery(t){return Promise.resolve([.1,.2,.3,.4])}};export{p as CohereEmbeddings,d as Embeddings,g as FakeEmbeddings,O as OpenAIEmbeddings};
//# sourceMappingURL=embeddings.js.map