/* esm.sh - esbuild bundle(langchain@0.0.73/llms/openai) deno production */
import __Process$ from "https://deno.land/std@0.177.0/node/process.ts";var Xe=Object.defineProperty;var h=(i,e)=>()=>(i&&(e=i(i=0)),e);var xe=(i,e)=>{for(var t in e)Xe(i,t,{get:e[t],enumerable:!0})};async function Ne(i,e){let t=i.getReader(),r;for(;!(r=await t.read()).done;)e(r.value)}function ke(i){let e,t,r,n=!1;return function(s){e===void 0?(e=s,t=0,r=-1):e=et(e,s);let o=e.length,u=0;for(;t<o;){n&&(e[t]===10&&(u=++t),n=!1);let p=-1;for(;t<o&&p===-1;++t)switch(e[t]){case 58:r===-1&&(r=t-u);break;case 13:n=!0;case 10:p=t;break}if(p===-1)break;i(e.subarray(u,p),r),u=t,r=-1}u===o?e=void 0:u!==0&&(e=e.subarray(u),t-=u)}}function Le(i,e,t){let r=Te(),n=new TextDecoder;return function(s,o){if(s.length===0)i?.(r),r=Te();else if(o>0){let u=n.decode(s.subarray(0,o)),p=o+(s[o+1]===32?2:1),c=n.decode(s.subarray(p));switch(u){case"data":r.data=r.data?r.data+`
`+c:c;break;case"event":r.event=c;break;case"id":e?.(r.id=c);break;case"retry":{let l=parseInt(c,10);Number.isNaN(l)||t?.(r.retry=l);break}}}}}function et(i,e){let t=new Uint8Array(i.length+e.length);return t.set(i),t.set(e,i.length),t}function Te(){return{data:"",event:"",id:"",retry:void 0}}var B,je=h(()=>{B="text/event-stream"});import V from"/v120/axios@1.4.0/deno/axios.mjs";function tt(i){try{return JSON.stringify(i)}catch{return i}}function rt(i,e,t){let{validateStatus:r}=t.config;!t.status||!r||r(t.status)?i(t):e(Y(`Request failed with status code ${t.status} and body ${typeof t.data=="string"?t.data:tt(t.data)}`,t.config,null,t.request,t))}function nt(i){return/^([a-z][a-z\d+\-.]*:)?\/\//i.test(i)}function it(i,e){return e?i.replace(/\/+$/,"")+"/"+e.replace(/^\/+/,""):i}function Me(i){return encodeURIComponent(i).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}function at(i,e,t){if(!e)return i;var r;if(t)r=t(e);else if(lt(e))r=e.toString();else{var n=[];ze(e,function(o,u){o===null||typeof o>"u"||($e(o)?u=`${u}[]`:o=[o],ze(o,function(c){ct(c)?c=c.toISOString():ut(c)&&(c=JSON.stringify(c)),n.push(`${Me(u)}=${Me(c)}`)}))}),r=n.join("&")}if(r){var a=i.indexOf("#");a!==-1&&(i=i.slice(0,a)),i+=(i.indexOf("?")===-1?"?":"&")+r}return i}function st(i,e){return i&&!nt(e)?it(i,e):e}function ot(i){return typeof i>"u"}function ut(i){return i!==null&&typeof i=="object"}function ct(i){return toString.call(i)==="[object Date]"}function lt(i){return toString.call(i)==="[object URLSearchParams]"}function $e(i){return Array.isArray(i)}function ze(i,e){if(!(i===null||typeof i>"u"))if(typeof i!="object"&&(i=[i]),$e(i))for(var t=0,r=i.length;t<r;t++)e.call(null,i[t],t,i);else for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&e.call(null,i[n],n,i)}function pt(i){return toString.call(i)==="[object FormData]"}function ht(){return typeof navigator<"u"&&(navigator.product==="ReactNative"||navigator.product==="NativeScript"||navigator.product==="NS")?!1:typeof document<"u"&&typeof document<"u"}async function E(i){let e=mt(i),t=await dt(e,i);return new Promise((r,n)=>{t instanceof Error?n(t):Object.prototype.toString.call(i.settle)==="[object Function]"?i.settle(r,n,t):rt(r,n,t)})}async function dt(i,e){let t;try{t=await fetch(i)}catch(a){return a&&a.name==="AbortError"?Y("Request aborted",e,"ECONNABORTED",i):a&&a.name==="TimeoutError"?Y("Request timeout",e,"ECONNABORTED",i):Y("Network Error",e,"ERR_NETWORK",i)}let r={};t.headers.forEach((a,s)=>{r[s]=a});let n={ok:t.ok,status:t.status,statusText:t.statusText,headers:r,config:e,request:i};if(t.status>=200&&t.status!==204)if(e.responseType==="stream"){let a=t.headers.get("content-type");if(!a?.startsWith(B)){if(t.status>=400)return a?.startsWith("application/json")?(n.data=await t.json(),n):(n.data=await t.text(),n);throw new Error(`Expected content-type to be ${B}, Actual: ${a}`)}await Ne(t.body,ke(Le(e.onmessage)))}else switch(e.responseType){case"arraybuffer":n.data=await t.arrayBuffer();break;case"blob":n.data=await t.blob();break;case"json":n.data=await t.json();break;case"formData":n.data=await t.formData();break;default:n.data=await t.text();break}return n}function mt(i){let e=new Headers(i.headers);if(i.auth){let s=i.auth.username||"",o=i.auth.password?decodeURI(encodeURIComponent(i.auth.password)):"";e.set("Authorization",`Basic ${btoa(`${s}:${o}`)}`)}let t=i.method.toUpperCase(),r={headers:e,method:t};t!=="GET"&&t!=="HEAD"&&(r.body=i.data,pt(r.body)&&ht()&&e.delete("Content-Type")),i.mode&&(r.mode=i.mode),i.cache&&(r.cache=i.cache),i.integrity&&(r.integrity=i.integrity),i.redirect&&(r.redirect=i.redirect),i.referrer&&(r.referrer=i.referrer),i.timeout&&i.timeout>0&&(r.signal=AbortSignal.timeout(i.timeout)),i.signal&&(r.signal=i.signal),ot(i.withCredentials)||(r.credentials=i.withCredentials?"include":"omit"),i.responseType==="stream"&&r.headers.set("Accept",B);let n=st(i.baseURL,i.url),a=at(n,i.params,i.paramsSerializer);return new Request(a,r)}function Y(i,e,t,r,n){if(V.AxiosError&&typeof V.AxiosError=="function")return new V.AxiosError(i,V.AxiosError[t],e,r,n);let a=new Error(i);return ft(a,e,t,r,n)}function ft(i,e,t,r,n){return i.config=e,t&&(i.code=t),i.request=r,i.response=n,i.isAxiosError=!0,i.toJSON=function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:this.config,code:this.code,status:this.response&&this.response.status?this.response.status:null}},i}var J=h(()=>{je()});var ue,Ce=h(()=>{ue=(i,e)=>i.reduce((t,r,n)=>{let a=Math.floor(n/e),s=t[a]||[];return t[a]=s.concat([r]),t},[])});import bt from"/v120/object-hash@3.0.0/deno/object-hash.mjs";var ce,Se=h(()=>{ce=(...i)=>bt(i.join("_"))});var X,z,Z,R,F,G,Q,K=h(()=>{X="__run",z=class{constructor(e){Object.defineProperty(this,"text",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.text=e}},Z=class extends z{_getType(){return"human"}},R=class extends z{_getType(){return"ai"}},F=class extends z{_getType(){return"system"}},G=class extends z{constructor(e,t){super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=t}_getType(){return"generic"}},Q=class{}});var yt,$,Re=h(()=>{Se();K();yt=new Map,$=class extends Q{constructor(e){super(),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.cache=e??new Map}lookup(e,t){return Promise.resolve(this.cache.get(ce(e,t))??null)}async update(e,t,r){this.cache.set(ce(e,t),r)}static global(){return new $(yt)}}});import gt from"/v120/p-retry@4.6.2/deno/p-retry.mjs";import le from"/v120/p-queue@6.6.2/deno/p-queue.mjs";var wt,ee,Ke=h(()=>{wt=[400,401,403,404,405,406,407,408,409],ee=class{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6;let t="default"in le?le.default:le;this.queue=new t({concurrency:this.maxConcurrency})}call(e,...t){return this.queue.add(()=>gt(()=>e(...t).catch(r=>{throw r instanceof Error?r:new Error(r)}),{onFailedAttempt(r){if(r.message.startsWith("Cancel")||r.message.startsWith("TimeoutError")||r.message.startsWith("AbortError")||r?.code==="ECONNABORTED")throw r;let n=r?.response?.status;if(n&&wt.includes(+n))throw r},retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}fetch(...e){return this.call(()=>fetch(...e).then(t=>t.ok?t:Promise.reject(t)))}}});var L,At,pe,De,te=h(()=>{L=i=>i.startsWith("gpt-3.5-turbo-")?"gpt-3.5-turbo":i.startsWith("gpt-4-32k-")?"gpt-4-32k":i.startsWith("gpt-4-")?"gpt-4":i,At=i=>{switch(L(i)){case"gpt-3.5-turbo":return 4096;case"gpt-4-32k":return 32768;case"gpt-4":return 8192;case"text-davinci-003":return 4097;case"text-curie-001":return 2048;case"text-babbage-001":return 2048;case"text-ada-001":return 2048;case"code-davinci-002":return 8e3;case"code-cushman-001":return 2048;default:return 4097}},pe=async()=>{try{let{encoding_for_model:i}=await import("/v120/@dqbd/tiktoken@1.0.7/deno/tiktoken.mjs");return{encoding_for_model:i}}catch(i){return console.log(i),{encoding_for_model:null}}},De=async({prompt:i,modelName:e})=>{let{encoding_for_model:t}=await pe(),r=Math.ceil(i.length/4);try{if(t){let a=t(L(e));r=a.encode(i).length,a.free()}}catch(a){console.warn("Failed to calculate number of tokens with tiktoken, falling back to approximate count",a)}return At(e)-r}});function Ue(i,e="Human",t="AI"){let r=[];for(let n of i){let a;if(n._getType()==="human")a=e;else if(n._getType()==="ai")a=t;else if(n._getType()==="system")a="System";else if(n._getType()==="generic")a=n.role;else throw new Error(`Got unsupported message type: ${n}`);r.push(`${a}: ${n.text}`)}return r.join(`
`)}var He=h(()=>{});import*as We from"/v120/uuid@9.0.0/deno/uuid.mjs";var he,T,de=h(()=>{he=class{},T=class extends he{constructor(e){super(),Object.defineProperty(this,"ignoreLLM",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreChain",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreAgent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),e&&(this.ignoreLLM=e.ignoreLLM??this.ignoreLLM,this.ignoreChain=e.ignoreChain??this.ignoreChain,this.ignoreAgent=e.ignoreAgent??this.ignoreAgent)}copy(){return new this.constructor(this)}static fromMethods(e){class t extends T{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:We.v4()}),Object.assign(this,e)}}return new t}}});var D,re,me=h(()=>{de();D=class extends T{constructor(){super(),Object.defineProperty(this,"session",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"runMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map})}copy(){return this}async newSession(e){let t={start_time:Date.now(),name:e},r=await this.persistSession(t);return this.session=r,r}_addChildRun(e,t){if(t.type==="llm")e.child_llm_runs.push(t);else if(t.type==="chain")e.child_chain_runs.push(t);else if(t.type==="tool")e.child_tool_runs.push(t);else throw new Error("Invalid run type")}_startTrace(e){if(e.parent_uuid){let t=this.runMap.get(e.parent_uuid);if(t)if(t.type==="tool"||t.type==="chain")this._addChildRun(t,e);else throw new Error("Caller run can only be a tool or chain");else throw new Error(`Caller run ${e.parent_uuid} not found`)}this.runMap.set(e.uuid,e)}async _endTrace(e){if(!e.parent_uuid)await this.persistRun(e);else{let t=this.runMap.get(e.parent_uuid);if(t===void 0)throw new Error(`Parent run ${e.parent_uuid} not found`);t.child_execution_order=Math.max(t.child_execution_order,e.child_execution_order)}this.runMap.delete(e.uuid)}_getExecutionOrder(e){if(e===void 0)return 1;let t=this.runMap.get(e);if(t===void 0)throw new Error(`Parent run ${e} not found`);return t.child_execution_order+1}async handleLLMStart(e,t,r,n){this.session===void 0&&(this.session=await this.loadDefaultSession());let a=this._getExecutionOrder(n),s={uuid:r,parent_uuid:n,start_time:Date.now(),end_time:0,serialized:e,prompts:t,session_id:this.session.id,execution_order:a,child_execution_order:a,type:"llm"};this._startTrace(s),await this.onLLMStart?.(s)}async handleLLMEnd(e,t){let r=this.runMap.get(t);if(!r||r?.type!=="llm")throw new Error("No LLM run to end.");let n=r;n.end_time=Date.now(),n.response=e,await this.onLLMEnd?.(n),await this._endTrace(n)}async handleLLMError(e,t){let r=this.runMap.get(t);if(!r||r?.type!=="llm")throw new Error("No LLM run to end.");let n=r;n.end_time=Date.now(),n.error=e.message,await this.onLLMError?.(n),await this._endTrace(n)}async handleChainStart(e,t,r,n){this.session===void 0&&(this.session=await this.loadDefaultSession());let a=this._getExecutionOrder(n),s={uuid:r,parent_uuid:n,start_time:Date.now(),end_time:0,serialized:e,inputs:t,session_id:this.session.id,execution_order:a,child_execution_order:a,type:"chain",child_llm_runs:[],child_chain_runs:[],child_tool_runs:[]};this._startTrace(s),await this.onChainStart?.(s)}async handleChainEnd(e,t){let r=this.runMap.get(t);if(!r||r?.type!=="chain")throw new Error("No chain run to end.");let n=r;n.end_time=Date.now(),n.outputs=e,await this.onChainEnd?.(n),await this._endTrace(n)}async handleChainError(e,t){let r=this.runMap.get(t);if(!r||r?.type!=="chain")throw new Error("No chain run to end.");let n=r;n.end_time=Date.now(),n.error=e.message,await this.onChainError?.(n),await this._endTrace(n)}async handleToolStart(e,t,r,n){this.session===void 0&&(this.session=await this.loadDefaultSession());let a=this._getExecutionOrder(n),s={uuid:r,parent_uuid:n,start_time:Date.now(),end_time:0,serialized:e,tool_input:t,session_id:this.session.id,execution_order:a,child_execution_order:a,type:"tool",action:JSON.stringify(e),child_llm_runs:[],child_chain_runs:[],child_tool_runs:[]};this._startTrace(s),await this.onToolStart?.(s)}async handleToolEnd(e,t){let r=this.runMap.get(t);if(!r||r?.type!=="tool")throw new Error("No tool run to end");let n=r;n.end_time=Date.now(),n.output=e,await this.onToolEnd?.(n),await this._endTrace(n)}async handleToolError(e,t){let r=this.runMap.get(t);if(!r||r?.type!=="tool")throw new Error("No tool run to end");let n=r;n.end_time=Date.now(),n.error=e.message,await this.onToolError?.(n),await this._endTrace(n)}async handleAgentAction(e,t){let r=this.runMap.get(t);if(!r||r?.type!=="chain")return;let n=r;n.actions=n.actions||[],n.actions.push(e),await this.onAgentAction?.(r)}},re=class extends D{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"langchain_tracer"}),Object.defineProperty(this,"endpoint",{enumerable:!0,configurable:!0,writable:!0,value:(typeof __Process$<"u"?__Process$.env?.LANGCHAIN_ENDPOINT:void 0)||"http://localhost:8000"}),Object.defineProperty(this,"headers",{enumerable:!0,configurable:!0,writable:!0,value:{"Content-Type":"application/json"}}),typeof __Process$<"u"&&__Process$.env?.LANGCHAIN_API_KEY&&(this.headers["x-api-key"]=__Process$.env?.LANGCHAIN_API_KEY)}async persistRun(e){let t;e.type==="llm"?t=`${this.endpoint}/llm-runs`:e.type==="chain"?t=`${this.endpoint}/chain-runs`:t=`${this.endpoint}/tool-runs`;let r=await fetch(t,{method:"POST",headers:this.headers,body:JSON.stringify(e)});r.ok||console.error(`Failed to persist run: ${r.status} ${r.statusText}`)}async persistSession(e){let t=`${this.endpoint}/sessions`,r=await fetch(t,{method:"POST",headers:this.headers,body:JSON.stringify(e)});return r.ok?{id:(await r.json()).id,...e}:(console.error(`Failed to persist session: ${r.status} ${r.statusText}, using default session.`),{id:1,...e})}async loadSession(e){let t=`${this.endpoint}/sessions?name=${e}`;return this._handleSessionResponse(t)}async loadDefaultSession(){let e=`${this.endpoint}/sessions?name=default`;return this._handleSessionResponse(e)}async _handleSessionResponse(e){let t=await fetch(e,{method:"GET",headers:this.headers}),r;if(!t.ok)return console.error(`Failed to load session: ${t.status} ${t.statusText}`),r={id:1,start_time:Date.now()},this.session=r,r;let n=await t.json();return n.length===0?(r={id:1,start_time:Date.now()},this.session=r,r):([r]=n,this.session=r,r)}}});import qe from"/v120/ansi-styles@5.2.0/deno/ansi-styles.mjs";function w(i,e){return`${i.open}${e}${i.close}`}function N(i,e){try{return JSON.stringify(i,null,2)}catch{return e}}function C(i){let e=i.end_time-i.start_time;return e<1e3?`${e}ms`:`${(e/1e3).toFixed(2)}s`}var v,U,Be=h(()=>{me();({color:v}=qe),U=class extends D{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"console_callback_handler"}),Object.defineProperty(this,"i",{enumerable:!0,configurable:!0,writable:!0,value:0})}persistSession(e){return Promise.resolve({...e,id:this.i++})}persistRun(e){return Promise.resolve()}loadDefaultSession(){return this.newSession()}loadSession(e){return this.newSession(e)}getParents(e){let t=[],r=e;for(;r.parent_uuid;){let n=this.runMap.get(r.parent_uuid);if(n)t.push(n),r=n;else break}return t}getBreadcrumbs(e){let r=[...this.getParents(e).reverse(),e].map((n,a,s)=>{let o=`${n.execution_order}:${n.type}:${n.serialized?.name}`;return a===s.length-1?w(qe.bold,o):o}).join(" > ");return w(v.grey,r)}onChainStart(e){let t=this.getBreadcrumbs(e);console.log(`${w(v.green,"[chain/start]")} [${t}] Entering Chain run with input: ${N(e.inputs,"[inputs]")}`)}onChainEnd(e){let t=this.getBreadcrumbs(e);console.log(`${w(v.cyan,"[chain/end]")} [${t}] [${C(e)}] Exiting Chain run with output: ${N(e.outputs,"[outputs]")}`)}onChainError(e){let t=this.getBreadcrumbs(e);console.log(`${w(v.red,"[chain/error]")} [${t}] [${C(e)}] Chain run errored with error: ${N(e.error,"[error]")}`)}onLLMStart(e){let t=this.getBreadcrumbs(e);console.log(`${w(v.green,"[llm/start]")} [${t}] Entering LLM run with input: ${N({prompts:e.prompts.map(r=>r.trim())},"[inputs]")}`)}onLLMEnd(e){let t=this.getBreadcrumbs(e);console.log(`${w(v.cyan,"[llm/end]")} [${t}] [${C(e)}] Exiting LLM run with output: ${N(e.response,"[response]")}`)}onLLMError(e){let t=this.getBreadcrumbs(e);console.log(`${w(v.red,"[llm/error]")} [${t}] [${C(e)}] LLM run errored with error: ${N(e.error,"[error]")}`)}onToolStart(e){let t=this.getBreadcrumbs(e);console.log(`${w(v.green,"[tool/start]")} [${t}] Entering Tool run with input: "${e.tool_input?.trim()}"`)}onToolEnd(e){let t=this.getBreadcrumbs(e);console.log(`${w(v.cyan,"[tool/end]")} [${t}] [${C(e)}] Exiting Tool run with output: "${e.output?.trim()}"`)}onToolError(e){let t=this.getBreadcrumbs(e);console.log(`${w(v.red,"[tool/error]")} [${t}] [${C(e)}] Tool run errored with error: ${N(e.error,"[error]")}`)}onAgentAction(e){let t=this.getBreadcrumbs(e);console.log(`${w(v.blue,"[agent/action]")} [${t}] Agent selected action: ${N(e.actions[e.actions.length-1],"[action]")}`)}}});async function Ve(i){let e=new re;return i?await e.loadSession(i):await e.loadDefaultSession(),e}var Ye=h(()=>{me()});import{v4 as ne}from"/v120/uuid@9.0.0/deno/uuid.mjs";function Je(i){return"name"in i?i:T.fromMethods(i)}var fe,H,be,ye,ge,A,we=h(()=>{de();Be();Ye();fe=class{setHandler(e){return this.setHandlers([e])}},H=class{constructor(e,t,r,n){Object.defineProperty(this,"runId",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:n})}async handleText(e){await Promise.all(this.handlers.map(async t=>{try{await t.handleText?.(e,this.runId,this._parentRunId)}catch(r){console.error(`Error in handler ${t.constructor.name}, handleText: ${r}`)}}))}},be=class extends H{async handleLLMNewToken(e){await Promise.all(this.handlers.map(async t=>{if(!t.ignoreLLM)try{await t.handleLLMNewToken?.(e,this.runId,this._parentRunId)}catch(r){console.error(`Error in handler ${t.constructor.name}, handleLLMNewToken: ${r}`)}}))}async handleLLMError(e){await Promise.all(this.handlers.map(async t=>{if(!t.ignoreLLM)try{await t.handleLLMError?.(e,this.runId,this._parentRunId)}catch(r){console.error(`Error in handler ${t.constructor.name}, handleLLMError: ${r}`)}}))}async handleLLMEnd(e){await Promise.all(this.handlers.map(async t=>{if(!t.ignoreLLM)try{await t.handleLLMEnd?.(e,this.runId,this._parentRunId)}catch(r){console.error(`Error in handler ${t.constructor.name}, handleLLMEnd: ${r}`)}}))}},ye=class extends H{getChild(){let e=new A(this.runId);return e.setHandlers(this.inheritableHandlers),e}async handleChainError(e){await Promise.all(this.handlers.map(async t=>{if(!t.ignoreChain)try{await t.handleChainError?.(e,this.runId,this._parentRunId)}catch(r){console.error(`Error in handler ${t.constructor.name}, handleChainError: ${r}`)}}))}async handleChainEnd(e){await Promise.all(this.handlers.map(async t=>{if(!t.ignoreChain)try{await t.handleChainEnd?.(e,this.runId,this._parentRunId)}catch(r){console.error(`Error in handler ${t.constructor.name}, handleChainEnd: ${r}`)}}))}async handleAgentAction(e){await Promise.all(this.handlers.map(async t=>{if(!t.ignoreAgent)try{await t.handleAgentAction?.(e,this.runId,this._parentRunId)}catch(r){console.error(`Error in handler ${t.constructor.name}, handleAgentAction: ${r}`)}}))}async handleAgentEnd(e){await Promise.all(this.handlers.map(async t=>{if(!t.ignoreAgent)try{await t.handleAgentEnd?.(e,this.runId,this._parentRunId)}catch(r){console.error(`Error in handler ${t.constructor.name}, handleAgentEnd: ${r}`)}}))}},ge=class extends H{getChild(){let e=new A(this.runId);return e.setHandlers(this.inheritableHandlers),e}async handleToolError(e){await Promise.all(this.handlers.map(async t=>{if(!t.ignoreAgent)try{await t.handleToolError?.(e,this.runId,this._parentRunId)}catch(r){console.error(`Error in handler ${t.constructor.name}, handleToolError: ${r}`)}}))}async handleToolEnd(e){await Promise.all(this.handlers.map(async t=>{if(!t.ignoreAgent)try{await t.handleToolEnd?.(e,this.runId,this._parentRunId)}catch(r){console.error(`Error in handler ${t.constructor.name}, handleToolEnd: ${r}`)}}))}},A=class extends fe{constructor(e){super(),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"callback_manager"}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.handlers=[],this.inheritableHandlers=[],this._parentRunId=e}async handleLLMStart(e,t,r=ne()){return await Promise.all(this.handlers.map(async n=>{if(!n.ignoreLLM)try{await n.handleLLMStart?.(e,t,r,this._parentRunId)}catch(a){console.error(`Error in handler ${n.constructor.name}, handleLLMStart: ${a}`)}})),new be(r,this.handlers,this.inheritableHandlers,this._parentRunId)}async handleChainStart(e,t,r=ne()){return await Promise.all(this.handlers.map(async n=>{if(!n.ignoreChain)try{await n.handleChainStart?.(e,t,r,this._parentRunId)}catch(a){console.error(`Error in handler ${n.constructor.name}, handleChainStart: ${a}`)}})),new ye(r,this.handlers,this.inheritableHandlers,this._parentRunId)}async handleToolStart(e,t,r=ne()){return await Promise.all(this.handlers.map(async n=>{if(!n.ignoreAgent)try{await n.handleToolStart?.(e,t,r,this._parentRunId)}catch(a){console.error(`Error in handler ${n.constructor.name}, handleToolStart: ${a}`)}})),new ge(r,this.handlers,this.inheritableHandlers,this._parentRunId)}addHandler(e,t=!0){this.handlers.push(e),t&&this.inheritableHandlers.push(e)}removeHandler(e){this.handlers=this.handlers.filter(t=>t!==e),this.inheritableHandlers=this.inheritableHandlers.filter(t=>t!==e)}setHandlers(e,t=!0){this.handlers=[],this.inheritableHandlers=[];for(let r of e)this.addHandler(r,t)}copy(e=[],t=!0){let r=new A(this._parentRunId);for(let n of this.handlers){let a=this.inheritableHandlers.includes(n);r.addHandler(n,a)}for(let n of e)r.handlers.filter(a=>a.name==="console_callback_handler").some(a=>a.name===n.name)||r.addHandler(n,t);return r}static fromHandlers(e){class t extends T{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:ne()}),Object.assign(this,e)}}let r=new this;return r.addHandler(new t),r}static async configure(e,t,r){let n;(e||t)&&(Array.isArray(e)||!e?(n=new A,n.setHandlers(e?.map(Je)??[],!0)):n=e,n=n.copy(Array.isArray(t)?t.map(Je):t?.handlers,!1));let a=typeof __Process$<"u"?__Process$.env?.LANGCHAIN_TRACING!==void 0:!1;if(r?.verbose||a){if(n||(n=new A),r?.verbose&&!n.handlers.some(s=>s.name===U.prototype.name)){let s=new U;n.addHandler(s,!0)}if(a&&!n.handlers.some(s=>s.name==="langchain_tracer")){let s=typeof __Process$<"u"?__Process$.env?.LANGCHAIN_SESSION:void 0;n.addHandler(await Ve(s),!0)}}return n}}});var ie,Ze=h(()=>{K();Ae();He();we();ie=class extends S{constructor(e){super(e)}async generate(e,t,r){let n=[],a=[],s=e.map(c=>Ue(c)),u=await(await A.configure(r,this.callbacks,{verbose:this.verbose}))?.handleLLMStart({name:this._llmType()},s);try{let c=await Promise.all(e.map(l=>this._generate(l,t,u)));for(let l of c)l.llmOutput&&a.push(l.llmOutput),n.push(l.generations)}catch(c){throw await u?.handleLLMError(c),c}let p={generations:n,llmOutput:a.length?this._combineLLMOutput?.(...a):void 0};return await u?.handleLLMEnd(p),Object.defineProperty(p,X,{value:u?{runId:u?.runId}:void 0,configurable:!0}),p}_modelType(){return"base_chat_model"}async generatePrompt(e,t,r){let n=e.map(a=>a.toChatMessages());return this.generate(n,t,r)}async call(e,t,r){return(await this.generate([e],t,r)).generations[0][0].message}async callPrompt(e,t,r){let n=e.toChatMessages();return this.call(n,t,r)}}});var Fe={};xe(Fe,{ChatOpenAI:()=>_e});import{isNode as _t}from"/v120/browser-or-node@2.1.1/deno/browser-or-node.mjs";import{Configuration as Pt,OpenAIApi as Ot}from"/v120/openai@3.2.1/deno/openai.mjs";function vt(i){switch(i){case"system":return"system";case"ai":return"assistant";case"human":return"user";default:throw new Error(`Unknown message type: ${i}`)}}function Et(i,e){switch(i){case"user":return new Z(e);case"assistant":return new R(e);case"system":return new F(e);default:return new G(e,i??"unknown")}}var _e,Ge=h(()=>{J();Ze();K();te();_e=class extends ie{constructor(e,t){super(e??{}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"frequencyPenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"presencePenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"logitBias",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:"gpt-3.5-turbo"}),Object.defineProperty(this,"modelKwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiVersion",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiInstanceName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiDeploymentName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"clientConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let r=e?.openAIApiKey??(typeof __Process$<"u"?__Process$.env?.OPENAI_API_KEY:void 0),n=e?.azureOpenAIApiKey??(typeof __Process$<"u"?__Process$.env?.AZURE_OPENAI_API_KEY:void 0);if(!n&&!r)throw new Error("(Azure) OpenAI API key not found");let a=e?.azureOpenAIApiInstanceName??(typeof __Process$<"u"?__Process$.env?.AZURE_OPENAI_API_INSTANCE_NAME:void 0),s=e?.azureOpenAIApiDeploymentName??(typeof __Process$<"u"?__Process$.env?.AZURE_OPENAI_API_DEPLOYMENT_NAME:void 0),o=e?.azureOpenAIApiVersion??(typeof __Process$<"u"?__Process$.env?.AZURE_OPENAI_API_VERSION:void 0);if(this.modelName=e?.modelName??this.modelName,this.modelKwargs=e?.modelKwargs??{},this.timeout=e?.timeout,this.temperature=e?.temperature??this.temperature,this.topP=e?.topP??this.topP,this.frequencyPenalty=e?.frequencyPenalty??this.frequencyPenalty,this.presencePenalty=e?.presencePenalty??this.presencePenalty,this.maxTokens=e?.maxTokens,this.n=e?.n??this.n,this.logitBias=e?.logitBias,this.stop=e?.stop,this.streaming=e?.streaming??!1,this.azureOpenAIApiVersion=o,this.azureOpenAIApiKey=n,this.azureOpenAIApiInstanceName=a,this.azureOpenAIApiDeploymentName=s,this.streaming&&this.n>1)throw new Error("Cannot stream results when n > 1");if(this.azureOpenAIApiKey){if(!this.azureOpenAIApiInstanceName)throw new Error("Azure OpenAI API instance name not found");if(!this.azureOpenAIApiDeploymentName)throw new Error("Azure OpenAI API deployment name not found");if(!this.azureOpenAIApiVersion)throw new Error("Azure OpenAI API version not found")}this.clientConfig={apiKey:r,...t}}invocationParams(){return{model:this.modelName,temperature:this.temperature,top_p:this.topP,frequency_penalty:this.frequencyPenalty,presence_penalty:this.presencePenalty,max_tokens:this.maxTokens===-1?void 0:this.maxTokens,n:this.n,logit_bias:this.logitBias,stop:this.stop,stream:this.streaming,...this.modelKwargs}}_identifyingParams(){return{model_name:this.modelName,...this.invocationParams(),...this.clientConfig}}identifyingParams(){return this._identifyingParams()}async _generate(e,t,r){let n=Array.isArray(t)?t:t?.stop,a=Array.isArray(t)?{}:t?.options??{},s={};if(this.stop&&n)throw new Error("Stop found in input and default params");let o=this.invocationParams();o.stop=n??o.stop;let u=e.map(m=>({role:vt(m._getType()),content:m.text,name:m.name})),p=o.stream?await new Promise((m,b)=>{let f,M=!1,_=!1;this.completionWithRetry({...o,messages:u},{...a,adapter:E,responseType:"stream",onmessage:I=>{if(I.data?.trim?.()==="[DONE]"){if(_)return;_=!0,m(f)}else{let x=JSON.parse(I.data);f||(f={id:x.id,object:x.object,created:x.created,model:x.model,choices:[]});for(let y of x.choices)if(y!=null){let P=f.choices.find(k=>k.index===y.index);P||(P={index:y.index,finish_reason:y.finish_reason??void 0},f.choices[y.index]=P),P.message||(P.message={role:y.delta?.role,content:y.delta?.content??""}),P.message.content+=y.delta?.content??"",r?.handleLLMNewToken(y.delta?.content??"")}!_&&x.choices.every(y=>y.finish_reason!=null)&&(_=!0,m(f))}}}).catch(I=>{M||(M=!0,b(I))})}):await this.completionWithRetry({...o,messages:u},a),{completion_tokens:c,prompt_tokens:l,total_tokens:d}=p.usage??{};c&&(s.completionTokens=(s.completionTokens??0)+c),l&&(s.promptTokens=(s.promptTokens??0)+l),d&&(s.totalTokens=(s.totalTokens??0)+d);let g=[];for(let m of p.choices){let b=m.message?.role??void 0,f=m.message?.content??"";g.push({text:f,message:Et(b,f)})}return{generations:g,llmOutput:{tokenUsage:s}}}async getNumTokensFromMessages(e){let t=0,r=0,n=0;L(this.modelName)==="gpt-3.5-turbo"?(r=4,n=-1):L(this.modelName).startsWith("gpt-4")&&(r=3,n=1);let a=await Promise.all(e.map(async s=>{let u=await this.getNumTokens(s.text)+r+(s.name?n:0);return t+=u,u}));return{totalCount:t,countPerMessage:a}}async completionWithRetry(e,t){if(!this.client){let n=this.azureOpenAIApiKey?`https://${this.azureOpenAIApiInstanceName}.openai.azure.com/openai/deployments/${this.azureOpenAIApiDeploymentName}`:this.clientConfig.basePath,a=new Pt({...this.clientConfig,basePath:n,baseOptions:{timeout:this.timeout,...this.clientConfig.baseOptions}});this.client=new Ot(a)}let r={adapter:_t?void 0:E,...this.clientConfig.baseOptions,...t};return this.azureOpenAIApiKey&&(r.headers={"api-key":this.azureOpenAIApiKey,...r.headers},r.params={"api-version":this.azureOpenAIApiVersion,...r.params}),this.caller.call(this.client.createChatCompletion.bind(this.client),e,r).then(n=>n.data)}_llmType(){return"openai"}_combineLLMOutput(...e){return e.reduce((t,r)=>(r&&r.tokenUsage&&(t.tokenUsage.completionTokens+=r.tokenUsage.completionTokens??0,t.tokenUsage.promptTokens+=r.tokenUsage.promptTokens??0,t.tokenUsage.totalTokens+=r.tokenUsage.totalTokens??0),t),{tokenUsage:{completionTokens:0,promptTokens:0,totalTokens:0}})}}});var It,Pe,S,Ae=h(()=>{Ke();te();It=()=>!1,Pe=class{constructor(e){Object.defineProperty(this,"verbose",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"callbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.verbose=e.verbose??It(),this.callbacks=e.callbacks}},S=class extends Pe{constructor(e){super({verbose:e.verbose,callbacks:e.callbacks??e.callbackManager}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_encoding",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_registry",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.caller=new ee(e??{})}async getNumTokens(e){let t=Math.ceil(e.length/4);try{if(!this._encoding){let{encoding_for_model:r}=await pe();r&&(this._encoding=r("modelName"in this?L(this.modelName):"gpt2"),this._registry=new FinalizationRegistry(n=>n.free()),this._registry.register(this,this._encoding))}this._encoding&&(t=this._encoding.encode(e).length)}catch(r){console.warn("Failed to calculate number of tokens with tiktoken, falling back to approximate count",r)}return t}_identifyingParams(){return{}}serialize(){return{...this._identifyingParams(),_type:this._llmType(),_model:this._modelType()}}static async deserialize(e){let{_type:t,_model:r,...n}=e;if(r&&r!=="base_chat_model")throw new Error(`Cannot load LLM with model ${r}`);let a={openai:(await Promise.resolve().then(()=>(Ge(),Fe))).ChatOpenAI}[t];if(a===void 0)throw new Error(`Cannot load  LLM with type ${t}`);return new a(n)}}});var W,ae,Oe=h(()=>{Re();K();Ae();we();W=class extends S{constructor({cache:e,concurrency:t,...r}){super(t?{maxConcurrency:t,...r}:r),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),typeof e=="object"?this.cache=e:e?this.cache=$.global():this.cache=void 0}async generatePrompt(e,t,r){let n=e.map(a=>a.toString());return this.generate(n,t,r)}async _generateUncached(e,t,r){let a=await(await A.configure(r,this.callbacks,{verbose:this.verbose}))?.handleLLMStart({name:this._llmType()},e),s;try{s=await this._generate(e,t,a)}catch(o){throw await a?.handleLLMError(o),o}return await a?.handleLLMEnd(s),Object.defineProperty(s,X,{value:a?{runId:a?.runId}:void 0,configurable:!0}),s}async generate(e,t,r){if(!Array.isArray(e))throw new Error("Argument 'prompts' is expected to be a string[]");if(!this.cache)return this._generateUncached(e,t,r);let{cache:n}=this,a=this.serialize();a.stop=t;let s=`${Object.entries(a).sort()}`,o=[],u=await Promise.all(e.map(async(c,l)=>{let d=await n.lookup(c,s);return d||o.push(l),d})),p={};if(o.length>0){let c=await this._generateUncached(o.map(l=>e[l]),t,r);await Promise.all(c.generations.map(async(l,d)=>{let g=o[d];return u[g]=l,n.update(e[g],s,l)})),p=c.llmOutput??{}}return{generations:u,llmOutput:p}}async call(e,t,r){let{generations:n}=await this.generate([e],t,r);return n[0][0].text}_identifyingParams(){return{}}serialize(){return{...this._identifyingParams(),_type:this._llmType(),_model:this._modelType()}}_modelType(){return"base_llm"}static async deserialize(e){let{_type:t,_model:r,...n}=e;if(r&&r!=="base_llm")throw new Error(`Cannot load LLM with model ${r}`);let a={openai:(await Promise.resolve().then(()=>(ve(),Qe))).OpenAI}[t];if(a===void 0)throw new Error(`Cannot load  LLM with type ${t}`);return new a(n)}},ae=class extends W{async _generate(e,t,r){let n=[];for(let a=0;a<e.length;a+=1){let s=await this._call(e[a],t,r);n.push([{text:s}])}return{generations:n}}}});import{isNode as xt}from"/v120/browser-or-node@2.1.1/deno/browser-or-node.mjs";import{Configuration as Tt,OpenAIApi as Nt}from"/v120/openai@3.2.1/deno/openai.mjs";var j,se,Ee=h(()=>{J();Oe();j=class extends ae{constructor(e,t){super(e??{}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"frequencyPenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"presencePenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"logitBias",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:"gpt-3.5-turbo"}),Object.defineProperty(this,"prefixMessages",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modelKwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"azureOpenAIApiVersion",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiInstanceName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiDeploymentName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"clientConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let r=e?.openAIApiKey??(typeof __Process$<"u"?__Process$.env?.OPENAI_API_KEY:void 0),n=e?.azureOpenAIApiKey??(typeof __Process$<"u"?__Process$.env?.AZURE_OPENAI_API_KEY:void 0);if(!n&&!r)throw new Error("(Azure) OpenAI API key not found");let a=e?.azureOpenAIApiInstanceName??(typeof __Process$<"u"?__Process$.env?.AZURE_OPENAI_API_INSTANCE_NAME:void 0),s=e?.azureOpenAIApiDeploymentName??(typeof __Process$<"u"?__Process$.env?.AZURE_OPENAI_API_DEPLOYMENT_NAME:void 0),o=e?.azureOpenAIApiVersion??(typeof __Process$<"u"?__Process$.env?.AZURE_OPENAI_API_VERSION:void 0);if(this.modelName=e?.modelName??this.modelName,this.prefixMessages=e?.prefixMessages??this.prefixMessages,this.modelKwargs=e?.modelKwargs??{},this.timeout=e?.timeout,this.temperature=e?.temperature??this.temperature,this.topP=e?.topP??this.topP,this.frequencyPenalty=e?.frequencyPenalty??this.frequencyPenalty,this.presencePenalty=e?.presencePenalty??this.presencePenalty,this.n=e?.n??this.n,this.logitBias=e?.logitBias,this.maxTokens=e?.maxTokens,this.stop=e?.stop,this.streaming=e?.streaming??!1,this.azureOpenAIApiVersion=o,this.azureOpenAIApiKey=n,this.azureOpenAIApiInstanceName=a,this.azureOpenAIApiDeploymentName=s,this.streaming&&this.n>1)throw new Error("Cannot stream results when n > 1");if(this.azureOpenAIApiKey){if(!this.azureOpenAIApiInstanceName)throw new Error("Azure OpenAI API instance name not found");if(!this.azureOpenAIApiDeploymentName)throw new Error("Azure OpenAI API deployment name not found");if(!this.azureOpenAIApiVersion)throw new Error("Azure OpenAI API version not found")}this.clientConfig={apiKey:r,...t}}invocationParams(){return{model:this.modelName,temperature:this.temperature,top_p:this.topP,frequency_penalty:this.frequencyPenalty,presence_penalty:this.presencePenalty,n:this.n,logit_bias:this.logitBias,max_tokens:this.maxTokens===-1?void 0:this.maxTokens,stop:this.stop,stream:this.streaming,...this.modelKwargs}}_identifyingParams(){return{model_name:this.modelName,...this.invocationParams(),...this.clientConfig}}identifyingParams(){return{model_name:this.modelName,...this.invocationParams(),...this.clientConfig}}formatMessages(e){let t={role:"user",content:e};return this.prefixMessages?[...this.prefixMessages,t]:[t]}async _call(e,t,r){let n=Array.isArray(t)?t:t?.stop,a=Array.isArray(t)?{}:t?.options??{};if(this.stop&&n)throw new Error("Stop found in input and default params");let s=this.invocationParams();return s.stop=n??s.stop,(s.stream?await new Promise((u,p)=>{let c,l=!1,d=!1;this.completionWithRetry({...s,messages:this.formatMessages(e)},{...a,adapter:E,responseType:"stream",onmessage:g=>{if(g.data?.trim?.()==="[DONE]"){if(d)return;d=!0,u(c)}else{let m=JSON.parse(g.data);c||(c={id:m.id,object:m.object,created:m.created,model:m.model,choices:[]});for(let b of m.choices)if(b!=null){let f=c.choices.find(M=>M.index===b.index);f||(f={index:b.index,finish_reason:b.finish_reason??void 0},c.choices.push(f)),f.message||(f.message={role:b.delta?.role,content:b.delta?.content??""}),f.message.content+=b.delta?.content??"",r?.handleLLMNewToken(b.delta?.content??"")}!d&&m.choices.every(b=>b.finish_reason!=null)&&(d=!0,u(c))}}}).catch(g=>{l||(l=!0,p(g))})}):await this.completionWithRetry({...s,messages:this.formatMessages(e)},a)).choices[0].message?.content??""}async completionWithRetry(e,t){if(!this.client){let n=this.azureOpenAIApiKey?`https://${this.azureOpenAIApiInstanceName}.openai.azure.com/openai/deployments/${this.azureOpenAIApiDeploymentName}`:this.clientConfig.basePath,a=new Tt({...this.clientConfig,basePath:n,baseOptions:{timeout:this.timeout,...this.clientConfig.baseOptions}});this.client=new Nt(a)}let r={adapter:xt?void 0:E,...this.clientConfig.baseOptions,...t};return this.azureOpenAIApiKey&&(r.headers={"api-key":this.azureOpenAIApiKey,...r.headers},r.params={"api-version":this.azureOpenAIApiVersion,...r.params}),this.caller.call(this.client.createChatCompletion.bind(this.client),e,r).then(n=>n.data)}_llmType(){return"openai"}},se=class extends j{constructor(e){if(super(e),Object.defineProperty(this,"promptLayerApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"plTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.plTags=e?.plTags??[],this.promptLayerApiKey=e?.promptLayerApiKey??(typeof __Process$<"u"?__Process$.env?.PROMPTLAYER_API_KEY:void 0),!this.promptLayerApiKey)throw new Error("Missing PromptLayer API key")}async completionWithRetry(e,t){if(e.stream)return super.completionWithRetry(e,t);let r=Date.now(),n=await super.completionWithRetry(e),a=Date.now();return await this.caller.call(fetch,"https://api.promptlayer.com/track-request",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({function_name:"openai.ChatCompletion.create",args:[],kwargs:{engine:e.model,messages:e.messages},tags:this.plTags??[],request_response:n,request_start_time:Math.floor(r/1e3),request_end_time:Math.floor(a/1e3),api_key:this.promptLayerApiKey})}),n}}});var Qe={};xe(Qe,{OpenAI:()=>oe,OpenAIChat:()=>j,PromptLayerOpenAI:()=>Ie,PromptLayerOpenAIChat:()=>se});import{isNode as kt}from"/v120/browser-or-node@2.1.1/deno/browser-or-node.mjs";import{Configuration as Lt,OpenAIApi as jt}from"/v120/openai@3.2.1/deno/openai.mjs";var oe,Ie,ve=h(()=>{J();Ce();Oe();te();Ee();Ee();oe=class extends W{constructor(e,t){if(e?.modelName?.startsWith("gpt-3.5-turbo")||e?.modelName?.startsWith("gpt-4")||e?.modelName?.startsWith("gpt-4-32k"))return new j(e,t);super(e??{}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:.7}),Object.defineProperty(this,"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:256}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"frequencyPenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"presencePenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"bestOf",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"logitBias",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:"text-davinci-003"}),Object.defineProperty(this,"modelKwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"batchSize",{enumerable:!0,configurable:!0,writable:!0,value:20}),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"azureOpenAIApiVersion",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiInstanceName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiDeploymentName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"clientConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let r=e?.openAIApiKey??(typeof __Process$<"u"?__Process$.env?.OPENAI_API_KEY:void 0),n=e?.azureOpenAIApiKey??(typeof __Process$<"u"?__Process$.env?.AZURE_OPENAI_API_KEY:void 0);if(!n&&!r)throw new Error("(Azure) OpenAI API key not found");let a=e?.azureOpenAIApiInstanceName??(typeof __Process$<"u"?__Process$.env?.AZURE_OPENAI_API_INSTANCE_NAME:void 0),s=(e?.azureOpenAIApiCompletionsDeploymentName||e?.azureOpenAIApiDeploymentName)??(typeof __Process$<"u"?__Process$.env?.AZURE_OPENAI_API_COMPLETIONS_DEPLOYMENT_NAME||__Process$.env?.AZURE_OPENAI_API_DEPLOYMENT_NAME:void 0),o=e?.azureOpenAIApiVersion??(typeof __Process$<"u"?__Process$.env?.AZURE_OPENAI_API_VERSION:void 0);if(this.modelName=e?.modelName??this.modelName,this.modelKwargs=e?.modelKwargs??{},this.batchSize=e?.batchSize??this.batchSize,this.timeout=e?.timeout,this.temperature=e?.temperature??this.temperature,this.maxTokens=e?.maxTokens??this.maxTokens,this.topP=e?.topP??this.topP,this.frequencyPenalty=e?.frequencyPenalty??this.frequencyPenalty,this.presencePenalty=e?.presencePenalty??this.presencePenalty,this.n=e?.n??this.n,this.bestOf=e?.bestOf??this.bestOf,this.logitBias=e?.logitBias,this.stop=e?.stop,this.streaming=e?.streaming??!1,this.azureOpenAIApiVersion=o,this.azureOpenAIApiKey=n,this.azureOpenAIApiInstanceName=a,this.azureOpenAIApiDeploymentName=s,this.streaming&&this.n>1)throw new Error("Cannot stream results when n > 1");if(this.streaming&&this.bestOf>1)throw new Error("Cannot stream results when bestOf > 1");if(this.azureOpenAIApiKey){if(!this.azureOpenAIApiInstanceName)throw new Error("Azure OpenAI API instance name not found");if(!this.azureOpenAIApiDeploymentName)throw new Error("Azure OpenAI API deployment name not found");if(!this.azureOpenAIApiVersion)throw new Error("Azure OpenAI API version not found")}this.clientConfig={apiKey:r,...t}}invocationParams(){return{model:this.modelName,temperature:this.temperature,max_tokens:this.maxTokens,top_p:this.topP,frequency_penalty:this.frequencyPenalty,presence_penalty:this.presencePenalty,n:this.n,best_of:this.bestOf,logit_bias:this.logitBias,stop:this.stop,stream:this.streaming,...this.modelKwargs}}_identifyingParams(){return{model_name:this.modelName,...this.invocationParams(),...this.clientConfig}}identifyingParams(){return this._identifyingParams()}async _generate(e,t,r){let n=Array.isArray(t)?t:t?.stop,a=Array.isArray(t)?{}:t?.options??{},s=ue(e,this.batchSize),o=[],u={};if(this.stop&&n)throw new Error("Stop found in input and default params");let p=this.invocationParams();if(p.stop=n??p.stop,p.max_tokens===-1){if(e.length!==1)throw new Error("max_tokens set to -1 not supported for multiple inputs");p.max_tokens=await De({prompt:e[0],modelName:this.modelName})}for(let l=0;l<s.length;l+=1){let d=p.stream?await new Promise((f,M)=>{let _=[],I,x=!1,y=!1;this.completionWithRetry({...p,prompt:s[l]},{...a,adapter:E,responseType:"stream",onmessage:P=>{if(P.data?.trim?.()==="[DONE]"){if(y)return;y=!0,f({...I,choices:_})}else{let k=JSON.parse(P.data);I||(I={id:k.id,object:k.object,created:k.created,model:k.model});for(let O of k.choices)if(O!=null&&O.index!=null){_[O.index]||(_[O.index]={});let q=_[O.index];q.text=(q.text??"")+(O.text??""),q.finish_reason=O.finish_reason,q.logprobs=O.logprobs,r?.handleLLMNewToken(O.text??"")}!y&&_.every(O=>O.finish_reason!=null)&&(y=!0,f({...I,choices:_}))}}}).catch(P=>{x||(x=!0,M(P))})}):await this.completionWithRetry({...p,prompt:s[l]},a);o.push(...d.choices);let{completion_tokens:g,prompt_tokens:m,total_tokens:b}=d.usage??{};g&&(u.completionTokens=(u.completionTokens??0)+g),m&&(u.promptTokens=(u.promptTokens??0)+m),b&&(u.totalTokens=(u.totalTokens??0)+b)}return{generations:ue(o,this.n).map(l=>l.map(d=>({text:d.text??"",generationInfo:{finishReason:d.finish_reason,logprobs:d.logprobs}}))),llmOutput:{tokenUsage:u}}}async completionWithRetry(e,t){if(!this.client){let n=this.azureOpenAIApiKey?`https://${this.azureOpenAIApiInstanceName}.openai.azure.com/openai/deployments/${this.azureOpenAIApiDeploymentName}`:this.clientConfig.basePath,a=new Lt({...this.clientConfig,basePath:n,baseOptions:{timeout:this.timeout,...this.clientConfig.baseOptions}});this.client=new jt(a)}let r={adapter:kt?void 0:E,...this.clientConfig.baseOptions,...t};return this.azureOpenAIApiKey&&(r.headers={"api-key":this.azureOpenAIApiKey,...r.headers},r.params={"api-version":this.azureOpenAIApiVersion,...r.params}),this.caller.call(this.client.createCompletion.bind(this.client),e,r).then(n=>n.data)}_llmType(){return"openai"}},Ie=class extends oe{constructor(e){if(super(e),Object.defineProperty(this,"promptLayerApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"plTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.plTags=e?.plTags??[],this.promptLayerApiKey=e?.promptLayerApiKey??(typeof __Process$<"u"?__Process$.env?.PROMPTLAYER_API_KEY:void 0),!this.promptLayerApiKey)throw new Error("Missing PromptLayer API key")}async completionWithRetry(e,t){if(e.stream)return super.completionWithRetry(e,t);let r=Date.now(),n=await super.completionWithRetry(e),a=Date.now();return await this.caller.call(fetch,"https://api.promptlayer.com/track-request",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({function_name:"openai.Completion.create",args:[],kwargs:{engine:e.model,prompt:e.prompt},tags:this.plTags??[],request_response:n,request_start_time:Math.floor(r/1e3),request_end_time:Math.floor(a/1e3),api_key:this.promptLayerApiKey})}),n}}});ve();export{oe as OpenAI,j as OpenAIChat,Ie as PromptLayerOpenAI,se as PromptLayerOpenAIChat};
//# sourceMappingURL=openai.js.map