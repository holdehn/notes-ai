/* esm.sh - esbuild bundle(@supabase/realtime-js@2.7.2/dist/module/RealtimePresence) deno production */
var _;(function(d){d.SYNC="sync",d.JOIN="join",d.LEAVE="leave"})(_||(_={}));var p=class{constructor(e,c){this.channel=e,this.state={},this.pendingDiffs=[],this.joinRef=null,this.caller={onJoin:()=>{},onLeave:()=>{},onSync:()=>{}};let r=c?.events||{state:"presence_state",diff:"presence_diff"};this.channel._on(r.state,{},t=>{let{onJoin:n,onLeave:o,onSync:s}=this.caller;this.joinRef=this.channel._joinRef(),this.state=p.syncState(this.state,t,n,o),this.pendingDiffs.forEach(f=>{this.state=p.syncDiff(this.state,f,n,o)}),this.pendingDiffs=[],s()}),this.channel._on(r.diff,{},t=>{let{onJoin:n,onLeave:o,onSync:s}=this.caller;this.inPendingSyncState()?this.pendingDiffs.push(t):(this.state=p.syncDiff(this.state,t,n,o),s())}),this.onJoin((t,n,o)=>{this.channel._trigger("presence",{event:"join",key:t,currentPresences:n,newPresences:o})}),this.onLeave((t,n,o)=>{this.channel._trigger("presence",{event:"leave",key:t,currentPresences:n,leftPresences:o})}),this.onSync(()=>{this.channel._trigger("presence",{event:"sync"})})}static syncState(e,c,r,t){let n=this.cloneDeep(e),o=this.transformState(c),s={},f={};return this.map(n,(i,h)=>{o[i]||(f[i]=h)}),this.map(o,(i,h)=>{let a=n[i];if(a){let v=h.map(l=>l.presence_ref),u=a.map(l=>l.presence_ref),g=h.filter(l=>u.indexOf(l.presence_ref)<0),m=a.filter(l=>v.indexOf(l.presence_ref)<0);g.length>0&&(s[i]=g),m.length>0&&(f[i]=m)}else s[i]=h}),this.syncDiff(n,{joins:s,leaves:f},r,t)}static syncDiff(e,c,r,t){let{joins:n,leaves:o}={joins:this.transformState(c.joins),leaves:this.transformState(c.leaves)};return r||(r=()=>{}),t||(t=()=>{}),this.map(n,(s,f)=>{var i;let h=(i=e[s])!==null&&i!==void 0?i:[];if(e[s]=this.cloneDeep(f),h.length>0){let a=e[s].map(u=>u.presence_ref),v=h.filter(u=>a.indexOf(u.presence_ref)<0);e[s].unshift(...v)}r(s,h,f)}),this.map(o,(s,f)=>{let i=e[s];if(!i)return;let h=f.map(a=>a.presence_ref);i=i.filter(a=>h.indexOf(a.presence_ref)<0),e[s]=i,t(s,i,f),i.length===0&&delete e[s]}),e}static map(e,c){return Object.getOwnPropertyNames(e).map(r=>c(r,e[r]))}static transformState(e){return e=this.cloneDeep(e),Object.getOwnPropertyNames(e).reduce((c,r)=>{let t=e[r];return"metas"in t?c[r]=t.metas.map(n=>(n.presence_ref=n.phx_ref,delete n.phx_ref,delete n.phx_ref_prev,n)):c[r]=t,c},{})}static cloneDeep(e){return JSON.parse(JSON.stringify(e))}onJoin(e){this.caller.onJoin=e}onLeave(e){this.caller.onLeave=e}onSync(e){this.caller.onSync=e}inPendingSyncState(){return!this.joinRef||this.joinRef!==this.channel._joinRef()}};export{_ as REALTIME_PRESENCE_LISTEN_EVENTS,p as default};
//# sourceMappingURL=RealtimePresence.js.map