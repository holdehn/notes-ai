/* esm.sh - esbuild bundle(langchain@0.0.52/chat_models/openai) deno production */
import __Process$ from "https://deno.land/std@0.177.0/node/process.ts";var me=Object.defineProperty;var u=(n,e)=>()=>(n&&(e=n(n=0)),e);var fe=(n,e)=>{for(var r in e)me(n,r,{get:e[r],enumerable:!0})};async function B(n,e){let r=n.getReader(),t;for(;!(t=await r.read()).done;)e(t.value)}function Y(n){let e,r,t,s=!1;return function(c){e===void 0?(e=c,r=0,t=-1):e=ye(e,c);let o=e.length,i=0;for(;r<o;){s&&(e[r]===10&&(i=++r),s=!1);let d=-1;for(;r<o&&d===-1;++r)switch(e[r]){case 58:t===-1&&(t=r-i);break;case 13:s=!0;case 10:d=r;break}if(d===-1)break;n(e.subarray(i,d),t),i=r,t=-1}i===o?e=void 0:i!==0&&(e=e.subarray(i),r-=i)}}function Q(n,e,r){let t=J(),s=new TextDecoder;return function(c,o){if(c.length===0)n?.(t),t=J();else if(o>0){let i=s.decode(c.subarray(0,o)),d=o+(c[o+1]===32?2:1),l=s.decode(c.subarray(d));switch(i){case"data":t.data=t.data?t.data+`
`+l:l;break;case"event":t.event=l;break;case"id":e?.(t.id=l);break;case"retry":{let h=parseInt(l,10);Number.isNaN(h)||r?.(t.retry=h);break}}}}}function ye(n,e){let r=new Uint8Array(n.length+e.length);return r.set(n),r.set(e,n.length),r}function J(){return{data:"",event:"",id:"",retry:void 0}}var v,X=u(()=>{v="text/event-stream"});import L from"/v118/axios@1.4.0/deno/axios.mjs";function ge(n,e,r){let{validateStatus:t}=r.config;!r.status||!t||t(r.status)?n(r):e(re(`Request failed with status code ${r.status}`,r.config,null,r.request,r))}function be(n){return/^([a-z][a-z\d+\-.]*:)?\/\//i.test(n)}function we(n,e){return e?n.replace(/\/+$/,"")+"/"+e.replace(/^\/+/,""):n}function Z(n){return encodeURIComponent(n).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}function _e(n,e,r){if(!e)return n;var t;if(r)t=r(e);else if(Pe(e))t=e.toString();else{var s=[];ee(e,function(o,i){o===null||typeof o>"u"||(te(o)?i=`${i}[]`:o=[o],ee(o,function(l){Ee(l)?l=l.toISOString():Te(l)&&(l=JSON.stringify(l)),s.push(`${Z(i)}=${Z(l)}`)}))}),t=s.join("&")}if(t){var a=n.indexOf("#");a!==-1&&(n=n.slice(0,a)),n+=(n.indexOf("?")===-1?"?":"&")+t}return n}function ke(n,e){return n&&!be(e)?we(n,e):e}function xe(n){return typeof n>"u"}function Te(n){return n!==null&&typeof n=="object"}function Ee(n){return toString.call(n)==="[object Date]"}function Pe(n){return toString.call(n)==="[object URLSearchParams]"}function te(n){return Array.isArray(n)}function ee(n,e){if(!(n===null||typeof n>"u"))if(typeof n!="object"&&(n=[n]),te(n))for(var r=0,t=n.length;r<t;r++)e.call(null,n[r],r,n);else for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&e.call(null,n[s],s,n)}function ve(n){return toString.call(n)==="[object FormData]"}function Le(){return typeof navigator<"u"&&(navigator.product==="ReactNative"||navigator.product==="NativeScript"||navigator.product==="NS")?!1:typeof document<"u"&&typeof document<"u"}async function D(n){let e=Ae(n),r=await Oe(e,n);return new Promise((t,s)=>{r instanceof Error?s(r):Object.prototype.toString.call(n.settle)==="[object Function]"?n.settle(t,s,r):ge(t,s,r)})}async function Oe(n,e){let r;try{r=await fetch(n)}catch{return re("Network Error",e,"ERR_NETWORK",n)}let t={ok:r.ok,status:r.status,statusText:r.statusText,headers:new Headers(r.headers),config:e,request:n};if(r.status>=200&&r.status!==204)if(e.responseType==="stream"){let s=r.headers.get("content-type");if(!s?.startsWith(v))throw new Error(`Expected content-type to be ${v}, Actual: ${s}`);await B(r.body,Y(Q(e.onmessage)))}else switch(e.responseType){case"arraybuffer":t.data=await r.arrayBuffer();break;case"blob":t.data=await r.blob();break;case"json":t.data=await r.json();break;case"formData":t.data=await r.formData();break;default:t.data=await r.text();break}return t}function Ae(n){let e=new Headers(n.headers);if(n.auth){let c=n.auth.username||"",o=n.auth.password?decodeURI(encodeURIComponent(n.auth.password)):"";e.set("Authorization",`Basic ${btoa(`${c}:${o}`)}`)}let r=n.method.toUpperCase(),t={headers:e,method:r};r!=="GET"&&r!=="HEAD"&&(t.body=n.data,ve(t.body)&&Le()&&e.delete("Content-Type")),n.mode&&(t.mode=n.mode),n.cache&&(t.cache=n.cache),n.integrity&&(t.integrity=n.integrity),n.redirect&&(t.redirect=n.redirect),n.referrer&&(t.referrer=n.referrer),n.timeout&&n.timeout>0&&(t.signal=AbortSignal.timeout(n.timeout)),n.signal&&(t.signal=n.signal),xe(n.withCredentials)||(t.credentials=n.withCredentials?"include":"omit"),n.responseType==="stream"&&t.headers.set("Accept",v);let s=ke(n.baseURL,n.url),a=_e(s,n.params,n.paramsSerializer);return new Request(a,t)}function re(n,e,r,t,s){if(L.AxiosError&&typeof L.AxiosError=="function")return new L.AxiosError(n,L.AxiosError[r],e,t,s);let a=new Error(n);return Ne(a,e,r,t,s)}function Ne(n,e,r,t,s){return n.config=e,r&&(n.code=r),n.request=t,n.response=s,n.isAxiosError=!0,n.toJSON=function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:this.config,code:this.code,status:this.response&&this.response.status?this.response.status:null}},n}var ne=u(()=>{X()});var b,O,_,A,N,I=u(()=>{b=class{constructor(e){Object.defineProperty(this,"text",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.text=e}},O=class extends b{_getType(){return"human"}},_=class extends b{_getType(){return"ai"}},A=class extends b{_getType(){return"system"}},N=class extends b{constructor(e,r){super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=r}_getType(){return"generic"}}});var R,y,H,k,x,C=u(()=>{R=class{},y=class extends R{constructor(e){super(),Object.defineProperty(this,"alwaysVerbose",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreLLM",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreChain",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreAgent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),e&&(this.alwaysVerbose=e.alwaysVerbose??this.alwaysVerbose,this.ignoreLLM=e.ignoreLLM??this.ignoreLLM,this.ignoreChain=e.ignoreChain??this.ignoreChain,this.ignoreAgent=e.ignoreAgent??this.ignoreAgent)}},H=class extends y{setHandler(e){return this.setHandlers([e])}},k=class extends H{constructor(){super(),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.handlers=[]}async handleLLMStart(e,r,t){await Promise.all(this.handlers.map(async s=>{if(!s.ignoreLLM&&(t||s.alwaysVerbose))try{await s.handleLLMStart?.(e,r)}catch(a){console.error(`Error in handler ${s.constructor.name}, handleLLMStart: ${a}`)}}))}async handleLLMNewToken(e,r){await Promise.all(this.handlers.map(async t=>{if(!t.ignoreLLM&&(r||t.alwaysVerbose))try{await t.handleLLMNewToken?.(e)}catch(s){console.error(`Error in handler ${t.constructor.name}, handleLLMNewToken: ${s}`)}}))}async handleLLMError(e,r){await Promise.all(this.handlers.map(async t=>{if(!t.ignoreLLM&&(r||t.alwaysVerbose))try{await t.handleLLMError?.(e)}catch(s){console.error(`Error in handler ${t.constructor.name}, handleLLMError: ${s}`)}}))}async handleLLMEnd(e,r){await Promise.all(this.handlers.map(async t=>{if(!t.ignoreLLM&&(r||t.alwaysVerbose))try{await t.handleLLMEnd?.(e)}catch(s){console.error(`Error in handler ${t.constructor.name}, handleLLMEnd: ${s}`)}}))}async handleChainStart(e,r,t){await Promise.all(this.handlers.map(async s=>{if(!s.ignoreChain&&(t||s.alwaysVerbose))try{await s.handleChainStart?.(e,r)}catch(a){console.error(`Error in handler ${s.constructor.name}, handleChainStart: ${a}`)}}))}async handleChainError(e,r){await Promise.all(this.handlers.map(async t=>{if(!t.ignoreChain&&(r||t.alwaysVerbose))try{await t.handleChainError?.(e)}catch(s){console.error(`Error in handler ${t.constructor.name}, handleChainError: ${s}`)}}))}async handleChainEnd(e,r){await Promise.all(this.handlers.map(async t=>{if(!t.ignoreChain&&(r||t.alwaysVerbose))try{await t.handleChainEnd?.(e)}catch(s){console.error(`Error in handler ${t.constructor.name}, handleChainEnd: ${s}`)}}))}async handleToolStart(e,r,t){await Promise.all(this.handlers.map(async s=>{if(!s.ignoreAgent&&(t||s.alwaysVerbose))try{await s.handleToolStart?.(e,r)}catch(a){console.error(`Error in handler ${s.constructor.name}, handleToolStart: ${a}`)}}))}async handleToolError(e,r){await Promise.all(this.handlers.map(async t=>{if(!t.ignoreAgent&&(r||t.alwaysVerbose))try{await t.handleToolError?.(e)}catch(s){console.error(`Error in handler ${t.constructor.name}, handleToolError: ${s}`)}}))}async handleToolEnd(e,r){await Promise.all(this.handlers.map(async t=>{if(!t.ignoreAgent&&(r||t.alwaysVerbose))try{await t.handleToolEnd?.(e)}catch(s){console.error(`Error in handler ${t.constructor.name}, handleToolEnd: ${s}`)}}))}async handleText(e,r){await Promise.all(this.handlers.map(async t=>{if(r||t.alwaysVerbose)try{await t.handleText?.(e)}catch(s){console.error(`Error in handler ${t.constructor.name}, handleText: ${s}`)}}))}async handleAgentAction(e,r){await Promise.all(this.handlers.map(async t=>{if(!t.ignoreAgent&&(r||t.alwaysVerbose))try{await t.handleAgentAction?.(e)}catch(s){console.error(`Error in handler ${t.constructor.name}, handleAgentAction: ${s}`)}}))}async handleAgentEnd(e,r){await Promise.all(this.handlers.map(async t=>{if(!t.ignoreAgent&&(r||t.alwaysVerbose))try{await t.handleAgentEnd?.(e)}catch(s){console.error(`Error in handler ${t.constructor.name}, handleAgentEnd: ${s}`)}}))}addHandler(e){this.handlers.push(e)}removeHandler(e){this.handlers=this.handlers.filter(r=>r!==e)}setHandlers(e){this.handlers=e}static fromHandlers(e){class r extends y{constructor(){super(),Object.defineProperty(this,"alwaysVerbose",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.assign(this,e)}}let t=new this;return t.addHandler(new r),t}},x=class extends y{async handleChainStart(e){console.log(`Entering new ${e.name} chain...`)}async handleChainEnd(e){console.log("Finished chain.")}async handleAgentAction(e){console.log(e.log)}async handleToolEnd(e){console.log(e)}async handleText(e){console.log(e)}async handleAgentEnd(e){console.log(e.log)}}});var V,T,U=u(()=>{C();V=class extends y{constructor(){super(),Object.defineProperty(this,"session",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stack",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"executionOrder",{enumerable:!0,configurable:!0,writable:!0,value:1}),this.alwaysVerbose=!0}async newSession(e){let r={start_time:Date.now(),name:e},t=await this.persistSession(r);return this.session=t,t}_addChildRun(e,r){if(r.type==="llm")e.child_llm_runs.push(r);else if(r.type==="chain")e.child_chain_runs.push(r);else if(r.type==="tool")e.child_tool_runs.push(r);else throw new Error("Invalid run type")}_startTrace(e){if(this.executionOrder+=1,this.stack.length>0){if(!(this.stack.at(-1)?.type==="tool"||this.stack.at(-1)?.type==="chain"))throw new Error("Nested run can only be logged for tool or chain");let r=this.stack.at(-1);this._addChildRun(r,e)}this.stack.push(e)}async _endTrace(){let e=this.stack.pop();this.stack.length===0&&e&&(this.executionOrder=1,await this.persistRun(e))}async handleLLMStart(e,r,t){this.session===void 0&&(this.session=await this.loadDefaultSession());let s={start_time:Date.now(),end_time:0,serialized:e,prompts:r,session_id:this.session.id,execution_order:this.executionOrder,type:"llm"};this._startTrace(s)}async handleLLMEnd(e,r){if(this.stack.length===0||this.stack.at(-1)?.type!=="llm")throw new Error("No LLM run to end.");let t=this.stack.at(-1);t.end_time=Date.now(),t.response=e,await this._endTrace()}async handleLLMError(e,r){if(this.stack.length===0||this.stack.at(-1)?.type!=="llm")throw new Error("No LLM run to end.");let t=this.stack.at(-1);t.end_time=Date.now(),t.error=e.message,await this._endTrace()}async handleChainStart(e,r,t){this.session===void 0&&(this.session=await this.loadDefaultSession());let s={start_time:Date.now(),end_time:0,serialized:e,inputs:r,session_id:this.session.id,execution_order:this.executionOrder,type:"chain",child_llm_runs:[],child_chain_runs:[],child_tool_runs:[]};this._startTrace(s)}async handleChainEnd(e,r){if(this.stack.length===0||this.stack.at(-1)?.type!=="chain")throw new Error("No chain run to end.");let t=this.stack.at(-1);t.end_time=Date.now(),t.outputs=e,await this._endTrace()}async handleChainError(e,r){if(this.stack.length===0||this.stack.at(-1)?.type!=="chain")throw new Error("No chain run to end.");let t=this.stack.at(-1);t.end_time=Date.now(),t.error=e.message,await this._endTrace()}async handleToolStart(e,r,t){this.session===void 0&&(this.session=await this.loadDefaultSession());let s={start_time:Date.now(),end_time:0,serialized:e,tool_input:r,session_id:this.session.id,execution_order:this.executionOrder,type:"tool",action:JSON.stringify(e),child_llm_runs:[],child_chain_runs:[],child_tool_runs:[]};this._startTrace(s)}async handleToolEnd(e,r){if(this.stack.length===0||this.stack.at(-1)?.type!=="tool")throw new Error("No tool run to end");let t=this.stack.at(-1);t.end_time=Date.now(),t.output=e,await this._endTrace()}async handleToolError(e,r){if(this.stack.length===0||this.stack.at(-1)?.type!=="tool")throw new Error("No tool run to end.");let t=this.stack.at(-1);t.end_time=Date.now(),t.error=e.message,await this._endTrace()}},T=class extends V{constructor(){super(),Object.defineProperty(this,"endpoint",{enumerable:!0,configurable:!0,writable:!0,value:(typeof __Process$<"u"?__Process$.env.LANGCHAIN_ENDPOINT:void 0)||"http://localhost:8000"}),Object.defineProperty(this,"headers",{enumerable:!0,configurable:!0,writable:!0,value:{"Content-Type":"application/json"}}),typeof __Process$<"u"&&__Process$.env.LANGCHAIN_API_KEY&&(this.headers["x-api-key"]=__Process$.env.LANGCHAIN_API_KEY)}async persistRun(e){let r;e.type==="llm"?r=`${this.endpoint}/llm-runs`:e.type==="chain"?r=`${this.endpoint}/chain-runs`:r=`${this.endpoint}/tool-runs`;let t=await fetch(r,{method:"POST",headers:this.headers,body:JSON.stringify(e)});t.ok||console.error(`Failed to persist run: ${t.status} ${t.statusText}`)}async persistSession(e){let r=`${this.endpoint}/sessions`,t=await fetch(r,{method:"POST",headers:this.headers,body:JSON.stringify(e)});return t.ok?{id:(await t.json()).id,...e}:(console.error(`Failed to persist session: ${t.status} ${t.statusText}, using default session.`),{id:1,...e})}async loadSession(e){let r=`${this.endpoint}/sessions?name=${e}`;return this._handleSessionResponse(r)}async loadDefaultSession(){let e=`${this.endpoint}/sessions?name=default`;return this._handleSessionResponse(e)}async _handleSessionResponse(e){let r=await fetch(e,{method:"GET",headers:this.headers}),t;if(!r.ok)return console.error(`Failed to load session: ${r.status} ${r.statusText}`),t={id:1,start_time:Date.now()},this.session=t,t;let s=await r.json();return s.length===0?(t={id:1,start_time:Date.now()},this.session=t,t):([t]=s,this.session=t,t)}}});function z(){return p.getInstance()}var p,se=u(()=>{U();C();p=class extends k{constructor(){super()}static getInstance(){return p.instance||(p.instance=new p,p.instance.addHandler(new x),typeof __Process$<"u"&&__Process$.env.LANGCHAIN_HANDLER==="langchain"&&p.instance.addHandler(new T)),p.instance}}});var ae=u(()=>{C();U();se()});import Ce from"/v118/p-retry@4.6.2/deno/p-retry.mjs";import F from"/v118/p-queue@6.6.2/deno/p-queue.mjs";var $,oe=u(()=>{$=class{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6;let r="default"in F?F.default:F;this.queue=new r({concurrency:this.maxConcurrency})}call(e,...r){return this.queue.add(()=>Ce(()=>e(...r).catch(t=>{throw t instanceof Error?t:new Error(t)}),{retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}}});var E,ie,q=u(()=>{E=n=>n.startsWith("gpt-3.5-turbo-")?"gpt-3.5-turbo":n.startsWith("gpt-4-32k-")?"gpt-4-32k":n.startsWith("gpt-4-")?"gpt-4":n,ie=async()=>{try{let{encoding_for_model:n}=await import("/v118/@dqbd/tiktoken@1.0.7/deno/tiktoken.mjs");return{encoding_for_model:n}}catch(n){return console.log(n),{encoding_for_model:null}}}});var $e,S,ce=u(()=>{ae();oe();q();$e=()=>!1,S=class{constructor(e){Object.defineProperty(this,"verbose",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"callbackManager",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_encoding",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_registry",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.verbose=e.verbose??(e.callbackManager?!0:$e()),this.callbackManager=e.callbackManager??z(),this.caller=new $(e??{})}async getNumTokens(e){let r=Math.ceil(e.length/4);try{if(!this._encoding){let{encoding_for_model:t}=await ie();t&&(this._encoding=t("modelName"in this?E(this.modelName):"gpt2"),this._registry=new FinalizationRegistry(s=>s.free()),this._registry.register(this,this._encoding))}this._encoding&&(r=this._encoding.encode(e).length)}catch(t){console.warn("Failed to calculate number of tokens with tiktoken, falling back to approximate count",t)}return r}_identifyingParams(){return{}}serialize(){return{...this._identifyingParams(),_type:this._llmType(),_model:this._modelType()}}static async deserialize(e){let{_type:r,_model:t,...s}=e;if(t&&t!=="base_chat_model")throw new Error(`Cannot load LLM with model ${t}`);let a={openai:(await Promise.resolve().then(()=>(W(),le))).ChatOpenAI}[r];if(a===void 0)throw new Error(`Cannot load  LLM with type ${r}`);return new a(s)}}});function ue(n,e="Human",r="AI"){let t=[];for(let s of n){let a;if(s._getType()==="human")a=e;else if(s._getType()==="ai")a=r;else if(s._getType()==="system")a="System";else if(s._getType()==="generic")a=s.role;else throw new Error(`Got unsupported message type: ${s}`);t.push(`${a}: ${s.text}`)}return t.join(`
`)}var he=u(()=>{});var M,de=u(()=>{I();ce();he();M=class extends S{constructor({...e}){super(e)}async generate(e,r){let t=[],s=[],a=e.map(o=>ue(o));await this.callbackManager.handleLLMStart({name:this._llmType()},a,this.verbose);try{for(let o of e){let i=await this._generate(o,r);i.llmOutput&&s.push(i.llmOutput),t.push(i.generations)}}catch(o){throw await this.callbackManager.handleLLMError(o,this.verbose),o}let c={generations:t,llmOutput:s.length?this._combineLLMOutput?.(...s):void 0};return await this.callbackManager.handleLLMEnd(c,this.verbose),c}_modelType(){return"base_chat_model"}async generatePrompt(e,r){let t=e.map(s=>s.toChatMessages());return this.generate(t,r)}async call(e,r){return(await this.generate([e],r)).generations[0][0].message}async callPrompt(e,r){let t=e.toChatMessages();return this.call(t,r)}}});var le={};fe(le,{ChatOpenAI:()=>K});import{Configuration as Se,OpenAIApi as Me}from"/v118/openai@3.2.1/deno/openai.mjs";function je(n){switch(n){case"system":return"system";case"ai":return"assistant";case"human":return"user";default:throw new Error(`Unknown message type: ${n}`)}}function De(n,e){switch(n){case"user":return new O(e);case"assistant":return new _(e);case"system":return new A(e);default:return new N(e,n??"unknown")}}var K,W=u(()=>{ne();de();I();q();K=class extends M{constructor(e,r){super(e??{}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"frequencyPenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"presencePenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"logitBias",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:"gpt-3.5-turbo"}),Object.defineProperty(this,"modelKwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"clientConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let t=e?.openAIApiKey??(typeof __Process$<"u"?__Process$.env.OPENAI_API_KEY:void 0);if(!t)throw new Error("OpenAI API key not found");if(this.modelName=e?.modelName??this.modelName,this.modelKwargs=e?.modelKwargs??{},this.timeout=e?.timeout,this.temperature=e?.temperature??this.temperature,this.topP=e?.topP??this.topP,this.frequencyPenalty=e?.frequencyPenalty??this.frequencyPenalty,this.presencePenalty=e?.presencePenalty??this.presencePenalty,this.maxTokens=e?.maxTokens,this.n=e?.n??this.n,this.logitBias=e?.logitBias,this.stop=e?.stop,this.streaming=e?.streaming??!1,this.streaming&&this.n>1)throw new Error("Cannot stream results when n > 1");this.clientConfig={apiKey:t,...r}}invocationParams(){return{model:this.modelName,temperature:this.temperature,top_p:this.topP,frequency_penalty:this.frequencyPenalty,presence_penalty:this.presencePenalty,max_tokens:this.maxTokens,n:this.n,logit_bias:this.logitBias,stop:this.stop,stream:this.streaming,...this.modelKwargs}}_identifyingParams(){return{model_name:this.modelName,...this.invocationParams(),...this.clientConfig}}identifyingParams(){return this._identifyingParams()}async _generate(e,r){let t={};if(this.stop&&r)throw new Error("Stop found in input and default params");let s=this.invocationParams();s.stop=r??s.stop;let a=e.map(h=>({role:je(h._getType()),content:h.text,name:h.name})),c=s.stream?await new Promise((h,j)=>{let m,G=!1;this.completionWithRetry({...s,messages:a},{responseType:"stream",onmessage:P=>{if(P.data?.trim?.()==="[DONE]")h(m);else{let w=JSON.parse(P.data);m||(m={id:w.id,object:w.object,created:w.created,model:w.model,choices:[]});let f=w.choices[0];if(f!=null){let g=m.choices.find(pe=>pe.index===f.index);g||(g={index:f.index,finish_reason:f.finish_reason??void 0},m.choices.push(g)),g.message||(g.message={role:f.delta?.role,content:f.delta?.content??""}),g.message.content+=f.delta?.content??"",this.callbackManager.handleLLMNewToken(f.delta?.content??"",!0)}}}}).catch(P=>{G||(G=!0,j(P))})}):await this.completionWithRetry({...s,messages:a}),{completion_tokens:o,prompt_tokens:i,total_tokens:d}=c.usage??{};o&&(t.completionTokens=(t.completionTokens??0)+o),i&&(t.promptTokens=(t.promptTokens??0)+i),d&&(t.totalTokens=(t.totalTokens??0)+d);let l=[];for(let h of c.choices){let j=h.message?.role??void 0,m=h.message?.content??"";l.push({text:m,message:De(j,m)})}return{generations:l,llmOutput:{tokenUsage:t}}}async getNumTokensFromMessages(e){let r=0,t=0,s=0;E(this.modelName)==="gpt-3.5-turbo"?(t=4,s=-1):E(this.modelName).startsWith("gpt-4")&&(t=3,s=1);let a=await Promise.all(e.map(async c=>{let i=await this.getNumTokens(c.text)+t+(c.name?s:0);return r+=i,i}));return{totalCount:r,countPerMessage:a}}async completionWithRetry(e,r){if(!this.client){let t=new Se({...this.clientConfig,baseOptions:{timeout:this.timeout,adapter:D,...this.clientConfig.baseOptions}});this.client=new Me(t)}return this.caller.call(this.client.createChatCompletion.bind(this.client),e,r).then(t=>t.data)}_llmType(){return"openai"}_combineLLMOutput(...e){return e.reduce((r,t)=>(t&&t.tokenUsage&&(r.tokenUsage.completionTokens+=t.tokenUsage.completionTokens??0,r.tokenUsage.promptTokens+=t.tokenUsage.promptTokens??0,r.tokenUsage.totalTokens+=t.tokenUsage.totalTokens??0),r),{tokenUsage:{completionTokens:0,promptTokens:0,totalTokens:0}})}}});W();export{K as ChatOpenAI};
//# sourceMappingURL=openai.js.map