/* esm.sh - esbuild bundle(langchain@0.0.67/embeddings) deno production */
import __Process$ from "https://deno.land/std@0.177.0/node/process.ts";import{Configuration as H,OpenAIApi as Y}from"/v119/openai@3.2.1/deno/openai.mjs";import h from"/v119/axios@1.4.0/deno/axios.mjs";var f="text/event-stream";async function A(e,t){let r=e.getReader(),i;for(;!(i=await r.read()).done;)t(i.value)}function v(e){let t,r,i,n=!1;return function(o){t===void 0?(t=o,r=0,i=-1):t=T(t,o);let s=t.length,u=0;for(;r<s;){n&&(t[r]===10&&(u=++r),n=!1);let d=-1;for(;r<s&&d===-1;++r)switch(t[r]){case 58:i===-1&&(i=r-u);break;case 13:n=!0;case 10:d=r;break}if(d===-1)break;e(t.subarray(u,d),i),u=r,i=-1}u===s?t=void 0:u!==0&&(t=t.subarray(u),r-=u)}}function S(e,t,r){let i=x(),n=new TextDecoder;return function(o,s){if(o.length===0)e?.(i),i=x();else if(s>0){let u=n.decode(o.subarray(0,s)),d=s+(o[s+1]===32?2:1),c=n.decode(o.subarray(d));switch(u){case"data":i.data=i.data?i.data+`
`+c:c;break;case"event":i.event=c;break;case"id":t?.(i.id=c);break;case"retry":{let O=parseInt(c,10);Number.isNaN(O)||r?.(i.retry=O);break}}}}}function T(e,t){let r=new Uint8Array(e.length+t.length);return r.set(e),r.set(t,e.length),r}function x(){return{data:"",event:"",id:"",retry:void 0}}function I(e){try{return JSON.stringify(e)}catch{return e}}function k(e,t,r){let{validateStatus:i}=r.config;!r.status||!i||i(r.status)?e(r):t(p(`Request failed with status code ${r.status} and body ${typeof r.data=="string"?r.data:I(r.data)}`,r.config,null,r.request,r))}function j(e){return/^([a-z][a-z\d+\-.]*:)?\/\//i.test(e)}function z(e,t){return t?e.replace(/\/+$/,"")+"/"+t.replace(/^\/+/,""):e}function P(e){return encodeURIComponent(e).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}function D(e,t,r){if(!t)return e;var i;if(r)i=r(t);else if(L(t))i=t.toString();else{var n=[];R(t,function(s,u){s===null||typeof s>"u"||(C(s)?u=`${u}[]`:s=[s],R(s,function(c){B(c)?c=c.toISOString():K(c)&&(c=JSON.stringify(c)),n.push(`${P(u)}=${P(c)}`)}))}),i=n.join("&")}if(i){var a=e.indexOf("#");a!==-1&&(e=e.slice(0,a)),e+=(e.indexOf("?")===-1?"?":"&")+i}return e}function W(e,t){return e&&!j(t)?z(e,t):t}function $(e){return typeof e>"u"}function K(e){return e!==null&&typeof e=="object"}function B(e){return toString.call(e)==="[object Date]"}function L(e){return toString.call(e)==="[object URLSearchParams]"}function C(e){return Array.isArray(e)}function R(e,t){if(!(e===null||typeof e>"u"))if(typeof e!="object"&&(e=[e]),C(e))for(var r=0,i=e.length;r<i;r++)t.call(null,e[r],r,e);else for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.call(null,e[n],n,e)}function U(e){return toString.call(e)==="[object FormData]"}function _(){return typeof navigator<"u"&&(navigator.product==="ReactNative"||navigator.product==="NativeScript"||navigator.product==="NS")?!1:typeof document<"u"&&typeof document<"u"}async function w(e){let t=J(e),r=await F(t,e);return new Promise((i,n)=>{r instanceof Error?n(r):Object.prototype.toString.call(e.settle)==="[object Function]"?e.settle(i,n,r):k(i,n,r)})}async function F(e,t){let r;try{r=await fetch(e)}catch(a){return a&&a.name==="AbortError"?p("Request aborted",t,"ECONNABORTED",e):a&&a.name==="TimeoutError"?p("Request timeout",t,"ECONNABORTED",e):p("Network Error",t,"ERR_NETWORK",e)}let i={};r.headers.forEach((a,o)=>{i[o]=a});let n={ok:r.ok,status:r.status,statusText:r.statusText,headers:i,config:t,request:e};if(r.status>=200&&r.status!==204)if(t.responseType==="stream"){let a=r.headers.get("content-type");if(!a?.startsWith(f)){if(r.status>=400)return a?.startsWith("application/json")?(n.data=await r.json(),n):(n.data=await r.text(),n);throw new Error(`Expected content-type to be ${f}, Actual: ${a}`)}await A(r.body,v(S(t.onmessage)))}else switch(t.responseType){case"arraybuffer":n.data=await r.arrayBuffer();break;case"blob":n.data=await r.blob();break;case"json":n.data=await r.json();break;case"formData":n.data=await r.formData();break;default:n.data=await r.text();break}return n}function J(e){let t=new Headers(e.headers);if(e.auth){let o=e.auth.username||"",s=e.auth.password?decodeURI(encodeURIComponent(e.auth.password)):"";t.set("Authorization",`Basic ${btoa(`${o}:${s}`)}`)}let r=e.method.toUpperCase(),i={headers:t,method:r};r!=="GET"&&r!=="HEAD"&&(i.body=e.data,U(i.body)&&_()&&t.delete("Content-Type")),e.mode&&(i.mode=e.mode),e.cache&&(i.cache=e.cache),e.integrity&&(i.integrity=e.integrity),e.redirect&&(i.redirect=e.redirect),e.referrer&&(i.referrer=e.referrer),e.timeout&&e.timeout>0&&(i.signal=AbortSignal.timeout(e.timeout)),e.signal&&(i.signal=e.signal),$(e.withCredentials)||(i.credentials=e.withCredentials?"include":"omit"),e.responseType==="stream"&&i.headers.set("Accept",f);let n=W(e.baseURL,e.url),a=D(n,e.params,e.paramsSerializer);return new Request(a,i)}function p(e,t,r,i,n){if(h.AxiosError&&typeof h.AxiosError=="function")return new h.AxiosError(e,h.AxiosError[r],t,i,n);let a=new Error(e);return M(a,t,r,i,n)}function M(e,t,r,i,n){return e.config=t,r&&(e.code=r),e.request=i,e.response=n,e.isAxiosError=!0,e.toJSON=function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:this.config,code:this.code,status:this.response&&this.response.status?this.response.status:null}},e}var b=(e,t)=>e.reduce((r,i,n)=>{let a=Math.floor(n/t),o=r[a]||[];return r[a]=o.concat([i]),r},[]);import Q from"/v119/p-retry@4.6.2/deno/p-retry.mjs";import g from"/v119/p-queue@6.6.2/deno/p-queue.mjs";var q=[400,401,403,404,405,406,407,408,409],y=class{constructor(t){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=t.maxConcurrency??1/0,this.maxRetries=t.maxRetries??6;let r="default"in g?g.default:g;this.queue=new r({concurrency:this.maxConcurrency})}call(t,...r){return this.queue.add(()=>Q(()=>t(...r).catch(i=>{throw i instanceof Error?i:new Error(i)}),{onFailedAttempt(i){if(i.message.startsWith("Cancel")||i.message.startsWith("TimeoutError")||i.message.startsWith("AbortError")||i?.code==="ECONNABORTED")throw i;let n=i?.response?.status;if(n&&q.includes(+n))throw i},retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}fetch(...t){return this.call(()=>fetch(...t).then(r=>r.ok?r:Promise.reject(r)))}};var l=class{constructor(t){Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.caller=new y(t??{})}};var E=class extends l{constructor(t,r){super(t??{}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:"text-embedding-ada-002"}),Object.defineProperty(this,"batchSize",{enumerable:!0,configurable:!0,writable:!0,value:512}),Object.defineProperty(this,"stripNewLines",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"clientConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let i=t?.openAIApiKey??(typeof __Process$<"u"?__Process$.env.OPENAI_API_KEY:void 0);if(!i)throw new Error("OpenAI API key not found");this.modelName=t?.modelName??this.modelName,this.batchSize=t?.batchSize??this.batchSize,this.stripNewLines=t?.stripNewLines??this.stripNewLines,this.timeout=t?.timeout,this.clientConfig={apiKey:i,...r}}async embedDocuments(t){let r=b(this.stripNewLines?t.map(n=>n.replaceAll(`
`," ")):t,this.batchSize),i=[];for(let n=0;n<r.length;n+=1){let a=r[n],{data:o}=await this.embeddingWithRetry({model:this.modelName,input:a});for(let s=0;s<a.length;s+=1)i.push(o.data[s].embedding)}return i}async embedQuery(t){let{data:r}=await this.embeddingWithRetry({model:this.modelName,input:this.stripNewLines?t.replaceAll(`
`," "):t});return r.data[0].embedding}async embeddingWithRetry(t){if(!this.client){let r=new H({...this.clientConfig,baseOptions:{timeout:this.timeout,adapter:w,...this.clientConfig.baseOptions}});this.client=new Y(r)}return this.caller.call(this.client.createEmbedding.bind(this.client),t)}};var m=class extends l{constructor(t){super(t??{}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:"small"}),Object.defineProperty(this,"batchSize",{enumerable:!0,configurable:!0,writable:!0,value:48}),Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let r=t?.apiKey||(typeof __Process$<"u"?__Process$.env?.COHERE_API_KEY:void 0);if(!r)throw new Error("Cohere API key not found");this.modelName=t?.modelName??this.modelName,this.batchSize=t?.batchSize??this.batchSize,this.apiKey=r}async embedDocuments(t){await this.maybeInitClient();let r=b(t,this.batchSize),i=[];for(let n=0;n<r.length;n+=1){let a=r[n],{body:o}=await this.embeddingWithRetry({model:this.modelName,texts:t});for(let s=0;s<a.length;s+=1)i.push(o.embeddings[s])}return i}async embedQuery(t){await this.maybeInitClient();let{body:r}=await this.embeddingWithRetry({model:this.modelName,texts:[t]});return r.embeddings[0]}async embeddingWithRetry(t){return await this.maybeInitClient(),this.caller.call(this.client.embed.bind(this.client),t)}async maybeInitClient(){if(!this.client){let{cohere:t}=await m.imports();this.client=t,this.client.init(this.apiKey)}}static async imports(){try{let{default:t}=await import("/v119/cohere-ai@5.1.0/deno/cohere-ai.mjs");return{cohere:t}}catch{throw new Error("Please install cohere-ai as a dependency with, e.g. `yarn add cohere-ai`")}}};var N=class extends l{constructor(t){super(t??{})}embedDocuments(t){return Promise.resolve(t.map(()=>[.1,.2,.3,.4]))}embedQuery(t){return Promise.resolve([.1,.2,.3,.4])}};export{m as CohereEmbeddings,l as Embeddings,N as FakeEmbeddings,E as OpenAIEmbeddings};
//# sourceMappingURL=embeddings.js.map