/* esm.sh - esbuild bundle(langchain@0.0.95/chat_models/openai) deno production */
import __Process$ from "https://deno.land/std@0.177.1/node/process.ts";var at=Object.defineProperty;var p=(n,e)=>()=>(n&&(e=n(n=0)),e);var it=(n,e)=>{for(var t in e)at(n,t,{get:e[t],enumerable:!0})};async function Ee(){return ae===void 0&&(ae={library:"langchain-js",runtime:ct()}),ae}function m(n){try{return typeof __Process$<"u"?__Process$.env?.[n]:void 0}catch{return}}var st,ot,ut,Oe,ie,ct,ae,R=p(()=>{st=()=>typeof document<"u"&&typeof window.document<"u",ot=()=>typeof globalThis=="object"&&globalThis.constructor&&globalThis.constructor.name==="DedicatedWorkerGlobalScope",ut=()=>typeof document<"u"&&window.name==="nodejs"||typeof navigator<"u"&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom")),Oe=()=>typeof Deno<"u",ie=()=>typeof __Process$<"u"&&typeof __Process$.versions<"u"&&typeof __Process$.versions.node<"u"&&!Oe(),ct=()=>{let n;return st()?n="browser":ie()?n="node":ot()?n="webworker":ut()?n="jsdom":Oe()?n="deno":n="other",n}});async function Pe(n,e){let t=n.getReader();for(;;){let r=await t.read();if(r.done){e(new Uint8Array,!0);break}e(r.value)}}function ke(n){let e,t,r,a=!1;return function(o,s){if(s){n(o,0,!0);return}e===void 0?(e=o,t=0,r=-1):e=lt(e,o);let c=e.length,l=0;for(;t<c;){a&&(e[t]===10&&(l=++t),a=!1);let u=-1;for(;t<c&&u===-1;++t)switch(e[t]){case 58:r===-1&&(r=t-l);break;case 13:a=!0;case 10:u=t;break}if(u===-1)break;n(e.subarray(l,u),r),l=t,r=-1}l===c?e=void 0:l!==0&&(e=e.subarray(l),t-=l)}}function Ie(n,e,t){let r=se(),a=new TextDecoder;return function(o,s,c){if(c){dt(r)||(n?.(r),r=se());return}if(o.length===0)n?.(r),r=se();else if(s>0){let l=a.decode(o.subarray(0,s)),u=s+(o[s+1]===32?2:1),d=a.decode(o.subarray(u));switch(l){case"data":r.data=r.data?r.data+`
`+d:d;break;case"event":r.event=d;break;case"id":e?.(r.id=d);break;case"retry":{let h=parseInt(d,10);Number.isNaN(h)||t?.(r.retry=h);break}}}}}function lt(n,e){let t=new Uint8Array(n.length+e.length);return t.set(n),t.set(e,n.length),t}function se(){return{data:"",event:"",id:"",retry:void 0}}function dt(n){return n.data===""&&n.event===""&&n.id===""&&n.retry===void 0}var U,Ne=p(()=>{U="text/event-stream"});import J from"/v126/axios@1.4.0/deno/axios.mjs";function pt(n){try{return JSON.stringify(n)}catch{return n}}function ht(n,e,t){let{validateStatus:r}=t.config;!t.status||!r||r(t.status)?n(t):e(q(`Request failed with status code ${t.status} and body ${typeof t.data=="string"?t.data:pt(t.data)}`,t.config,null,t.request,t))}function mt(n){return/^([a-z][a-z\d+\-.]*:)?\/\//i.test(n)}function ft(n,e){return e?n.replace(/\/+$/,"")+"/"+e.replace(/^\/+/,""):n}function Le(n){return encodeURIComponent(n).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}function gt(n,e,t){if(!e)return n;var r;if(t)r=t(e);else if(xt(e))r=e.toString();else{var a=[];Se(e,function(s,c){s===null||typeof s>"u"||(Re(s)?c=`${c}[]`:s=[s],Se(s,function(u){_t(u)?u=u.toISOString():wt(u)&&(u=JSON.stringify(u)),a.push(`${Le(c)}=${Le(u)}`)}))}),r=a.join("&")}if(r){var i=n.indexOf("#");i!==-1&&(n=n.slice(0,i)),n+=(n.indexOf("?")===-1?"?":"&")+r}return n}function bt(n,e){return n&&!mt(e)?ft(n,e):e}function yt(n){return typeof n>"u"}function wt(n){return n!==null&&typeof n=="object"}function _t(n){return toString.call(n)==="[object Date]"}function xt(n){return toString.call(n)==="[object URLSearchParams]"}function Re(n){return Array.isArray(n)}function Se(n,e){if(!(n===null||typeof n>"u"))if(typeof n!="object"&&(n=[n]),Re(n))for(var t=0,r=n.length;t<r;t++)e.call(null,n[t],t,n);else for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&e.call(null,n[a],a,n)}function At(n){return toString.call(n)==="[object FormData]"}function Tt(){return typeof navigator<"u"&&(navigator.product==="ReactNative"||navigator.product==="NativeScript"||navigator.product==="NS")?!1:typeof document<"u"&&typeof document<"u"}async function V(n){let e=Ot(n),t=await vt(e,n);return new Promise((r,a)=>{t instanceof Error?a(t):Object.prototype.toString.call(n.settle)==="[object Function]"?n.settle(r,a,t):ht(r,a,t)})}async function vt(n,e){let t;try{t=await fetch(n)}catch(i){return i&&i.name==="AbortError"?q("Request aborted",e,"ECONNABORTED",n):i&&i.name==="TimeoutError"?q("Request timeout",e,"ECONNABORTED",n):q("Network Error",e,"ERR_NETWORK",n)}let r={};t.headers.forEach((i,o)=>{r[o]=i});let a={ok:t.ok,status:t.status,statusText:t.statusText,headers:r,config:e,request:n};if(t.status>=200&&t.status!==204)if(e.responseType==="stream"){let i=t.headers.get("content-type");if(!i?.startsWith(U)){if(t.status>=400)return i?.startsWith("application/json")?(a.data=await t.json(),a):(a.data=await t.text(),a);throw new Error(`Expected content-type to be ${U}, Actual: ${i}`)}await Pe(t.body,ke(Ie(e.onmessage)))}else switch(e.responseType){case"arraybuffer":a.data=await t.arrayBuffer();break;case"blob":a.data=await t.blob();break;case"json":a.data=await t.json();break;case"formData":a.data=await t.formData();break;default:a.data=await t.text();break}return a}function Ot(n){let e=new Headers(n.headers);if(n.auth){let o=n.auth.username||"",s=n.auth.password?decodeURI(encodeURIComponent(n.auth.password)):"";e.set("Authorization",`Basic ${btoa(`${o}:${s}`)}`)}let t=n.method.toUpperCase(),r={headers:e,method:t};t!=="GET"&&t!=="HEAD"&&(r.body=n.data,At(r.body)&&Tt()&&e.delete("Content-Type")),typeof r.body=="string"&&(r.body=new TextEncoder().encode(r.body)),n.mode&&(r.mode=n.mode),n.cache&&(r.cache=n.cache),n.integrity&&(r.integrity=n.integrity),n.redirect&&(r.redirect=n.redirect),n.referrer&&(r.referrer=n.referrer),n.timeout&&n.timeout>0&&(r.signal=AbortSignal.timeout(n.timeout)),n.signal&&(r.signal=n.signal),yt(n.withCredentials)||(r.credentials=n.withCredentials?"include":"omit"),n.responseType==="stream"&&r.headers.set("Accept",U);let a=bt(n.baseURL,n.url),i=gt(a,n.params,n.paramsSerializer);return new Request(i,r)}function q(n,e,t,r,a){if(J.AxiosError&&typeof J.AxiosError=="function")return new J.AxiosError(n,J.AxiosError[t],e,r,a);let i=new Error(n);return Et(i,e,t,r,a)}function Et(n,e,t,r,a){return n.config=e,t&&(n.code=t),n.request=r,n.response=a,n.isAxiosError=!0,n.toJSON=function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:this.config,code:this.code,status:this.response&&this.response.status?this.response.status:null}},n}var Me=p(()=>{Ne()});import Pt from"/v126/decamelize@5.0.1/deno/decamelize.mjs";import Yt from"/v126/camelcase@6.3.0/deno/camelcase.mjs";function $e(n,e){return e?.[n]||Pt(n)}function je(n,e,t){let r={};for(let a in n)Object.hasOwn(n,a)&&(r[e(a,t)]=n[a]);return r}var Ce=p(()=>{});function ze(n){return Array.isArray(n)?[...n]:{...n}}function kt(n,e){let t=ze(n);for(let[r,a]of Object.entries(e)){let[i,...o]=r.split(".").reverse(),s=t;for(let c of o.reverse()){if(s[c]===void 0)break;s[c]=ze(s[c]),s=s[c]}s[i]!==void 0&&(s[i]={lc:1,type:"secret",id:[a]})}return t}var x,B=p(()=>{Ce();x=class{get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}constructor(e,...t){Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.lc_kwargs=e||{}}toJSON(){if(!this.lc_serializable)return this.toJSONNotImplemented();if(this.lc_kwargs instanceof x||typeof this.lc_kwargs!="object"||Array.isArray(this.lc_kwargs))return this.toJSONNotImplemented();let e={},t={},r=Object.keys(this.lc_kwargs).reduce((a,i)=>(a[i]=i in this?this[i]:this.lc_kwargs[i],a),{});for(let a=Object.getPrototypeOf(this);a;a=Object.getPrototypeOf(a))Object.assign(e,Reflect.get(a,"lc_aliases",this)),Object.assign(t,Reflect.get(a,"lc_secrets",this)),Object.assign(r,Reflect.get(a,"lc_attributes",this));return{lc:1,type:"constructor",id:[...this.lc_namespace,this.constructor.name],kwargs:je(this.lc_secrets?kt(r,t):r,$e,e)}}toJSONNotImplemented(){return{lc:1,type:"not_implemented",id:[...this.lc_namespace,this.constructor.name]}}}});var He,k,I,M,G,F,oe=p(()=>{B();He="__run",k=class{constructor(e,t){Object.defineProperty(this,"text",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"additional_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:{}}),this.text=e,this.additional_kwargs=t||{}}toJSON(){return{type:this._getType(),data:{content:this.text,role:"role"in this?this.role:void 0,name:this.name,additional_kwargs:this.additional_kwargs}}}},I=class extends k{_getType(){return"human"}},M=class extends k{_getType(){return"ai"}},G=class extends k{_getType(){return"system"}},F=class extends k{constructor(e,t){super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=t}_getType(){return"generic"}}});import It from"/v126/p-retry@4.6.2/deno/p-retry.mjs";import ue from"/v126/p-queue@6.6.2/deno/p-queue.mjs";var Nt,N,ce=p(()=>{Nt=[400,401,403,404,405,406,407,408,409],N=class{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6;let t="default"in ue?ue.default:ue;this.queue=new t({concurrency:this.maxConcurrency})}call(e,...t){return this.queue.add(()=>It(()=>e(...t).catch(r=>{throw r instanceof Error?r:new Error(r)}),{onFailedAttempt(r){if(r.message.startsWith("Cancel")||r.message.startsWith("TimeoutError")||r.message.startsWith("AbortError")||r?.code==="ECONNABORTED")throw r;let a=r?.response?.status;if(a&&Nt.includes(+a))throw r},retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(e,t,...r){return e.signal?Promise.race([this.call(t,...r),new Promise((a,i)=>{e.signal?.addEventListener("abort",()=>{i(new Error("AbortError"))})})]):this.call(t,...r)}fetch(...e){return this.call(()=>fetch(...e).then(t=>t.ok?t:Promise.reject(t)))}}});import{Tiktoken as Lt,getEncodingNameForModel as St}from"/v126/js-tiktoken@1.0.6/deno/lite.js";async function Mt(n,e){return n in W||(W[n]=Rt.fetch(`https://tiktoken.pages.dev/js/${n}.json`,{signal:e?.signal}).then(t=>t.json()).catch(t=>{throw delete W[n],t})),new Lt(await W[n],e?.extendedSpecialTokens)}async function le(n,e){return Mt(St(n),e)}var W,Rt,de=p(()=>{ce();W={},Rt=new N({})});var $,Y=p(()=>{de();$=n=>n.startsWith("gpt-3.5-turbo-")?"gpt-3.5-turbo":n.startsWith("gpt-4-32k-")?"gpt-4-32k":n.startsWith("gpt-4-")?"gpt-4":n});var $t,pe,Q,De=p(()=>{ce();Y();de();B();Y();$t=()=>!1,pe=class extends x{get lc_attributes(){return{callbacks:void 0,verbose:void 0}}constructor(e){super(e),Object.defineProperty(this,"verbose",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"callbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.verbose=e.verbose??$t(),this.callbacks=e.callbacks,this.tags=e.tags??[]}},Q=class extends pe{get callKeys(){return["stop","timeout","signal"]}constructor({callbacks:e,callbackManager:t,...r}){super({callbacks:e??t,...r}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_encoding",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.caller=new N(r??{})}async getNumTokens(e){let t=Math.ceil(e.length/4);if(!this._encoding)try{this._encoding=await le("modelName"in this?$(this.modelName):"gpt2")}catch(r){console.warn("Failed to calculate number of tokens, falling back to approximate count",r)}return this._encoding&&(t=this._encoding.encode(e).length),t}_identifyingParams(){return{}}serialize(){return{...this._identifyingParams(),_type:this._llmType(),_model:this._modelType()}}static async deserialize(e){let{_type:t,_model:r,...a}=e;if(r&&r!=="base_chat_model")throw new Error(`Cannot load LLM with model ${r}`);let i={openai:(await Promise.resolve().then(()=>(he(),Ke))).ChatOpenAI}[t];if(i===void 0)throw new Error(`Cannot load  LLM with type ${t}`);return new i(a)}}});import*as Ue from"/v126/uuid@9.0.0/deno/uuid.mjs";var me,T,fe=p(()=>{B();me=class{},T=class extends me{get lc_namespace(){return["langchain","callbacks",this.name]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}constructor(e){super(),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ignoreLLM",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreChain",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreAgent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"awaitHandlers",{enumerable:!0,configurable:!0,writable:!0,value:typeof __Process$<"u"?__Process$.env?.LANGCHAIN_CALLBACKS_BACKGROUND!=="true":!0}),this.lc_kwargs=e||{},e&&(this.ignoreLLM=e.ignoreLLM??this.ignoreLLM,this.ignoreChain=e.ignoreChain??this.ignoreChain,this.ignoreAgent=e.ignoreAgent??this.ignoreAgent)}copy(){return new this.constructor(this)}toJSON(){return x.prototype.toJSON.call(this)}toJSONNotImplemented(){return x.prototype.toJSONNotImplemented.call(this)}static fromMethods(e){class t extends T{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:Ue.v4()}),Object.assign(this,e)}}return new t}}});var v,Z=p(()=>{fe();v=class extends T{constructor(e){super(...arguments),Object.defineProperty(this,"runMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map})}copy(){return this}_addChildRun(e,t){e.child_runs.push(t)}_startTrace(e){if(e.parent_run_id!==void 0){let t=this.runMap.get(e.parent_run_id);t&&this._addChildRun(t,e)}this.runMap.set(e.id,e)}async _endTrace(e){let t=e.parent_run_id!==void 0&&this.runMap.get(e.parent_run_id);t?t.child_execution_order=Math.max(t.child_execution_order,e.child_execution_order):await this.persistRun(e),this.runMap.delete(e.id)}_getExecutionOrder(e){let t=e!==void 0&&this.runMap.get(e);return t?t.child_execution_order+1:1}async handleLLMStart(e,t,r,a,i,o){let s=this._getExecutionOrder(a),c=Date.now(),l={id:r,name:e.id[e.id.length-1],parent_run_id:a,start_time:c,serialized:e,events:[{name:"start",time:c}],inputs:{prompts:t},execution_order:s,child_runs:[],child_execution_order:s,run_type:"llm",extra:i??{},tags:o||[]};this._startTrace(l),await this.onLLMStart?.(l)}async handleChatModelStart(e,t,r,a,i,o){let s=this._getExecutionOrder(a),c=Date.now(),l={id:r,name:e.id[e.id.length-1],parent_run_id:a,start_time:c,serialized:e,events:[{name:"start",time:c}],inputs:{messages:t},execution_order:s,child_runs:[],child_execution_order:s,run_type:"llm",extra:i??{},tags:o||[]};this._startTrace(l),await this.onLLMStart?.(l)}async handleLLMEnd(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="llm")throw new Error("No LLM run to end.");r.end_time=Date.now(),r.outputs=e,r.events.push({name:"end",time:r.end_time}),await this.onLLMEnd?.(r),await this._endTrace(r)}async handleLLMError(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="llm")throw new Error("No LLM run to end.");r.end_time=Date.now(),r.error=e.message,r.events.push({name:"error",time:r.end_time}),await this.onLLMError?.(r),await this._endTrace(r)}async handleChainStart(e,t,r,a,i){let o=this._getExecutionOrder(a),s=Date.now(),c={id:r,name:e.id[e.id.length-1],parent_run_id:a,start_time:s,serialized:e,events:[{name:"start",time:s}],inputs:t,execution_order:o,child_execution_order:o,run_type:"chain",child_runs:[],extra:{},tags:i||[]};this._startTrace(c),await this.onChainStart?.(c)}async handleChainEnd(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="chain")throw new Error("No chain run to end.");r.end_time=Date.now(),r.outputs=e,r.events.push({name:"end",time:r.end_time}),await this.onChainEnd?.(r),await this._endTrace(r)}async handleChainError(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="chain")throw new Error("No chain run to end.");r.end_time=Date.now(),r.error=e.message,r.events.push({name:"error",time:r.end_time}),await this.onChainError?.(r),await this._endTrace(r)}async handleToolStart(e,t,r,a,i){let o=this._getExecutionOrder(a),s=Date.now(),c={id:r,name:e.id[e.id.length-1],parent_run_id:a,start_time:s,serialized:e,events:[{name:"start",time:s}],inputs:{input:t},execution_order:o,child_execution_order:o,run_type:"tool",child_runs:[],extra:{},tags:i||[]};this._startTrace(c),await this.onToolStart?.(c)}async handleToolEnd(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="tool")throw new Error("No tool run to end");r.end_time=Date.now(),r.outputs={output:e},r.events.push({name:"end",time:r.end_time}),await this.onToolEnd?.(r),await this._endTrace(r)}async handleToolError(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="tool")throw new Error("No tool run to end");r.end_time=Date.now(),r.error=e.message,r.events.push({name:"error",time:r.end_time}),await this.onToolError?.(r),await this._endTrace(r)}async handleAgentAction(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="chain")return;let a=r;a.actions=a.actions||[],a.actions.push(e),a.events.push({name:"agent_action",time:Date.now(),kwargs:{action:e}}),await this.onAgentAction?.(r)}async handleText(e,t){let r=this.runMap.get(t);!r||r?.run_type!=="chain"||(r.events.push({name:"text",time:Date.now(),kwargs:{text:e}}),await this.onText?.(r))}}});import Je from"/v126/ansi-styles@5.2.0/deno/ansi-styles.mjs";function b(n,e){return`${n.open}${e}${n.close}`}function O(n,e){try{return JSON.stringify(n,null,2)}catch{return e}}function L(n){if(!n.end_time)return"";let e=n.end_time-n.start_time;return e<1e3?`${e}ms`:`${(e/1e3).toFixed(2)}s`}var w,j,qe=p(()=>{Z();({color:w}=Je),j=class extends v{constructor(){super(...arguments),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"console_callback_handler"})}persistRun(e){return Promise.resolve()}getParents(e){let t=[],r=e;for(;r.parent_run_id;){let a=this.runMap.get(r.parent_run_id);if(a)t.push(a),r=a;else break}return t}getBreadcrumbs(e){let r=[...this.getParents(e).reverse(),e].map((a,i,o)=>{let s=`${a.execution_order}:${a.run_type}:${a.name}`;return i===o.length-1?b(Je.bold,s):s}).join(" > ");return b(w.grey,r)}onChainStart(e){let t=this.getBreadcrumbs(e);console.log(`${b(w.green,"[chain/start]")} [${t}] Entering Chain run with input: ${O(e.inputs,"[inputs]")}`)}onChainEnd(e){let t=this.getBreadcrumbs(e);console.log(`${b(w.cyan,"[chain/end]")} [${t}] [${L(e)}] Exiting Chain run with output: ${O(e.outputs,"[outputs]")}`)}onChainError(e){let t=this.getBreadcrumbs(e);console.log(`${b(w.red,"[chain/error]")} [${t}] [${L(e)}] Chain run errored with error: ${O(e.error,"[error]")}`)}onLLMStart(e){let t=this.getBreadcrumbs(e),r="prompts"in e.inputs?{prompts:e.inputs.prompts.map(a=>a.trim())}:e.inputs;console.log(`${b(w.green,"[llm/start]")} [${t}] Entering LLM run with input: ${O(r,"[inputs]")}`)}onLLMEnd(e){let t=this.getBreadcrumbs(e);console.log(`${b(w.cyan,"[llm/end]")} [${t}] [${L(e)}] Exiting LLM run with output: ${O(e.outputs,"[response]")}`)}onLLMError(e){let t=this.getBreadcrumbs(e);console.log(`${b(w.red,"[llm/error]")} [${t}] [${L(e)}] LLM run errored with error: ${O(e.error,"[error]")}`)}onToolStart(e){let t=this.getBreadcrumbs(e);console.log(`${b(w.green,"[tool/start]")} [${t}] Entering Tool run with input: "${e.inputs.input?.trim()}"`)}onToolEnd(e){let t=this.getBreadcrumbs(e);console.log(`${b(w.cyan,"[tool/end]")} [${t}] [${L(e)}] Exiting Tool run with output: "${e.outputs?.output?.trim()}"`)}onToolError(e){let t=this.getBreadcrumbs(e);console.log(`${b(w.red,"[tool/error]")} [${t}] [${L(e)}] Tool run errored with error: ${O(e.error,"[error]")}`)}onAgentAction(e){let t=e,r=this.getBreadcrumbs(e);console.log(`${b(w.blue,"[agent/action]")} [${r}] Agent selected action: ${O(t.actions[t.actions.length-1],"[action]")}`)}}});import{LangChainPlusClient as jt}from"/v126/langchainplus-sdk@0.0.11/deno/langchainplus-sdk.mjs";var C,ge=p(()=>{R();Z();C=class extends v{constructor(e={}){super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"langchain_tracer"}),Object.defineProperty(this,"sessionName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let{exampleId:t,sessionName:r,client:a}=e;this.sessionName=r??m("LANGCHAIN_SESSION"),this.exampleId=t,this.client=a??new jt({})}async _convertToCreate(e,t=void 0){return{...e,extra:{...e.extra,runtime:await Ee()},child_runs:void 0,session_name:this.sessionName,reference_example_id:e.parent_run_id?void 0:t}}async persistRun(e){}async _persistRunSingle(e){let t=await this._convertToCreate(e,this.exampleId);await this.client.createRun(t)}async _updateRunSingle(e){let t={end_time:e.end_time,error:e.error,outputs:e.outputs,events:e.events};await this.client.updateRun(e.id,t)}async onLLMStart(e){await this._persistRunSingle(e)}async onLLMEnd(e){await this._updateRunSingle(e)}async onLLMError(e){await this._updateRunSingle(e)}async onChainStart(e){await this._persistRunSingle(e)}async onChainEnd(e){await this._updateRunSingle(e)}async onChainError(e){await this._updateRunSingle(e)}async onToolStart(e){await this._persistRunSingle(e)}async onToolEnd(e){await this._updateRunSingle(e)}async onToolError(e){await this._updateRunSingle(e)}}});function X(n,e="Human",t="AI"){let r=[];for(let a of n){let i;if(a._getType()==="human")i=e;else if(a._getType()==="ai")i=t;else if(a._getType()==="system")i="System";else if(a._getType()==="generic")i=a.role;else throw new Error(`Got unsupported message type: ${a}`);r.push(`${i}: ${a.text}`)}return r.join(`
`)}var be=p(()=>{});var ee,Ve=p(()=>{be();R();Z();ee=class extends v{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"langchain_tracer"}),Object.defineProperty(this,"endpoint",{enumerable:!0,configurable:!0,writable:!0,value:m("LANGCHAIN_ENDPOINT")||"http://localhost:1984"}),Object.defineProperty(this,"headers",{enumerable:!0,configurable:!0,writable:!0,value:{"Content-Type":"application/json"}}),Object.defineProperty(this,"session",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let e=m("LANGCHAIN_API_KEY");e&&(this.headers["x-api-key"]=e)}async newSession(e){let t={start_time:Date.now(),name:e},r=await this.persistSession(t);return this.session=r,r}async loadSession(e){let t=`${this.endpoint}/sessions?name=${e}`;return this._handleSessionResponse(t)}async loadDefaultSession(){let e=`${this.endpoint}/sessions?name=default`;return this._handleSessionResponse(e)}async convertV2RunToRun(e){let t=this.session??await this.loadDefaultSession(),r=e.serialized,a;if(e.run_type==="llm"){let i=e.inputs.prompts?e.inputs.prompts:e.inputs.messages.map(s=>X(s));a={uuid:e.id,start_time:e.start_time,end_time:e.end_time,execution_order:e.execution_order,child_execution_order:e.child_execution_order,serialized:r,type:e.run_type,session_id:t.id,prompts:i,response:e.outputs}}else if(e.run_type==="chain"){let i=await Promise.all(e.child_runs.map(s=>this.convertV2RunToRun(s)));a={uuid:e.id,start_time:e.start_time,end_time:e.end_time,execution_order:e.execution_order,child_execution_order:e.child_execution_order,serialized:r,type:e.run_type,session_id:t.id,inputs:e.inputs,outputs:e.outputs,child_llm_runs:i.filter(s=>s.type==="llm"),child_chain_runs:i.filter(s=>s.type==="chain"),child_tool_runs:i.filter(s=>s.type==="tool")}}else if(e.run_type==="tool"){let i=await Promise.all(e.child_runs.map(s=>this.convertV2RunToRun(s)));a={uuid:e.id,start_time:e.start_time,end_time:e.end_time,execution_order:e.execution_order,child_execution_order:e.child_execution_order,serialized:r,type:e.run_type,session_id:t.id,tool_input:e.inputs.input,output:e.outputs?.output,action:JSON.stringify(r),child_llm_runs:i.filter(s=>s.type==="llm"),child_chain_runs:i.filter(s=>s.type==="chain"),child_tool_runs:i.filter(s=>s.type==="tool")}}else throw new Error(`Unknown run type: ${e.run_type}`);return a}async persistRun(e){let t,r;e.run_type!==void 0?r=await this.convertV2RunToRun(e):r=e,r.type==="llm"?t=`${this.endpoint}/llm-runs`:r.type==="chain"?t=`${this.endpoint}/chain-runs`:t=`${this.endpoint}/tool-runs`;let a=await fetch(t,{method:"POST",headers:this.headers,body:JSON.stringify(r)});a.ok||console.error(`Failed to persist run: ${a.status} ${a.statusText}`)}async persistSession(e){let t=`${this.endpoint}/sessions`,r=await fetch(t,{method:"POST",headers:this.headers,body:JSON.stringify(e)});return r.ok?{id:(await r.json()).id,...e}:(console.error(`Failed to persist session: ${r.status} ${r.statusText}, using default session.`),{id:1,...e})}async _handleSessionResponse(e){let t=await fetch(e,{method:"GET",headers:this.headers}),r;if(!t.ok)return console.error(`Failed to load session: ${t.status} ${t.statusText}`),r={id:1,start_time:Date.now()},this.session=r,r;let a=await t.json();return a.length===0?(r={id:1,start_time:Date.now()},this.session=r,r):([r]=a,this.session=r,r)}}});async function Be(n){let e=new ee;return n?await e.loadSession(n):await e.loadDefaultSession(),e}async function Ge(){return new C}var Fe=p(()=>{ge();Ve()});import ye from"/v126/p-queue@6.6.2/deno/p-queue.mjs";function Ct(){let n="default"in ye?ye.default:ye;return new n({autoStart:!0,concurrency:1})}async function f(n,e){e===!0?await n():(typeof we>"u"&&(we=Ct()),we.add(n))}var we,We=p(()=>{});import{v4 as z}from"/v126/uuid@9.0.0/deno/uuid.mjs";function Ye(n){return"name"in n?n:T.fromMethods(n)}var _e,H,te,xe,Ae,A,Qe=p(()=>{fe();qe();Fe();be();R();ge();We();_e=class{setHandler(e){return this.setHandlers([e])}},H=class{constructor(e,t,r,a,i,o){Object.defineProperty(this,"runId",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:o})}async handleText(e){await Promise.all(this.handlers.map(t=>f(async()=>{try{await t.handleText?.(e,this.runId,this._parentRunId)}catch(r){console.error(`Error in handler ${t.constructor.name}, handleText: ${r}`)}},t.awaitHandlers)))}},te=class extends H{async handleLLMNewToken(e){await Promise.all(this.handlers.map(t=>f(async()=>{if(!t.ignoreLLM)try{await t.handleLLMNewToken?.(e,this.runId,this._parentRunId)}catch(r){console.error(`Error in handler ${t.constructor.name}, handleLLMNewToken: ${r}`)}},t.awaitHandlers)))}async handleLLMError(e){await Promise.all(this.handlers.map(t=>f(async()=>{if(!t.ignoreLLM)try{await t.handleLLMError?.(e,this.runId,this._parentRunId)}catch(r){console.error(`Error in handler ${t.constructor.name}, handleLLMError: ${r}`)}},t.awaitHandlers)))}async handleLLMEnd(e){await Promise.all(this.handlers.map(t=>f(async()=>{if(!t.ignoreLLM)try{await t.handleLLMEnd?.(e,this.runId,this._parentRunId)}catch(r){console.error(`Error in handler ${t.constructor.name}, handleLLMEnd: ${r}`)}},t.awaitHandlers)))}},xe=class extends H{getChild(e){let t=new A(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),e&&t.addTags([e],!1),t}async handleChainError(e){await Promise.all(this.handlers.map(t=>f(async()=>{if(!t.ignoreChain)try{await t.handleChainError?.(e,this.runId,this._parentRunId)}catch(r){console.error(`Error in handler ${t.constructor.name}, handleChainError: ${r}`)}},t.awaitHandlers)))}async handleChainEnd(e){await Promise.all(this.handlers.map(t=>f(async()=>{if(!t.ignoreChain)try{await t.handleChainEnd?.(e,this.runId,this._parentRunId)}catch(r){console.error(`Error in handler ${t.constructor.name}, handleChainEnd: ${r}`)}},t.awaitHandlers)))}async handleAgentAction(e){await Promise.all(this.handlers.map(t=>f(async()=>{if(!t.ignoreAgent)try{await t.handleAgentAction?.(e,this.runId,this._parentRunId)}catch(r){console.error(`Error in handler ${t.constructor.name}, handleAgentAction: ${r}`)}},t.awaitHandlers)))}async handleAgentEnd(e){await Promise.all(this.handlers.map(t=>f(async()=>{if(!t.ignoreAgent)try{await t.handleAgentEnd?.(e,this.runId,this._parentRunId)}catch(r){console.error(`Error in handler ${t.constructor.name}, handleAgentEnd: ${r}`)}},t.awaitHandlers)))}},Ae=class extends H{getChild(e){let t=new A(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),e&&t.addTags([e],!1),t}async handleToolError(e){await Promise.all(this.handlers.map(t=>f(async()=>{if(!t.ignoreAgent)try{await t.handleToolError?.(e,this.runId,this._parentRunId)}catch(r){console.error(`Error in handler ${t.constructor.name}, handleToolError: ${r}`)}},t.awaitHandlers)))}async handleToolEnd(e){await Promise.all(this.handlers.map(t=>f(async()=>{if(!t.ignoreAgent)try{await t.handleToolEnd?.(e,this.runId,this._parentRunId)}catch(r){console.error(`Error in handler ${t.constructor.name}, handleToolEnd: ${r}`)}},t.awaitHandlers)))}},A=class extends _e{constructor(e){super(),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"callback_manager"}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.handlers=[],this.inheritableHandlers=[],this._parentRunId=e}async handleLLMStart(e,t,r=z(),a=void 0,i=void 0){return await Promise.all(this.handlers.map(o=>f(async()=>{if(!o.ignoreLLM)try{await o.handleLLMStart?.(e,t,r,this._parentRunId,i,this.tags)}catch(s){console.error(`Error in handler ${o.constructor.name}, handleLLMStart: ${s}`)}},o.awaitHandlers))),new te(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this._parentRunId)}async handleChatModelStart(e,t,r=z(),a=void 0,i=void 0){let o;return await Promise.all(this.handlers.map(s=>f(async()=>{if(!s.ignoreLLM)try{s.handleChatModelStart?await s.handleChatModelStart?.(e,t,r,this._parentRunId,i,this.tags):s.handleLLMStart&&(o=t.map(c=>X(c)),await s.handleLLMStart?.(e,o,r,this._parentRunId,i,this.tags))}catch(c){console.error(`Error in handler ${s.constructor.name}, handleLLMStart: ${c}`)}},s.awaitHandlers))),new te(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this._parentRunId)}async handleChainStart(e,t,r=z()){return await Promise.all(this.handlers.map(a=>f(async()=>{if(!a.ignoreChain)try{await a.handleChainStart?.(e,t,r,this._parentRunId,this.tags)}catch(i){console.error(`Error in handler ${a.constructor.name}, handleChainStart: ${i}`)}},a.awaitHandlers))),new xe(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this._parentRunId)}async handleToolStart(e,t,r=z()){return await Promise.all(this.handlers.map(a=>f(async()=>{if(!a.ignoreAgent)try{await a.handleToolStart?.(e,t,r,this._parentRunId,this.tags)}catch(i){console.error(`Error in handler ${a.constructor.name}, handleToolStart: ${i}`)}},a.awaitHandlers))),new Ae(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this._parentRunId)}addHandler(e,t=!0){this.handlers.push(e),t&&this.inheritableHandlers.push(e)}removeHandler(e){this.handlers=this.handlers.filter(t=>t!==e),this.inheritableHandlers=this.inheritableHandlers.filter(t=>t!==e)}setHandlers(e,t=!0){this.handlers=[],this.inheritableHandlers=[];for(let r of e)this.addHandler(r,t)}addTags(e,t=!0){this.removeTags(e),this.tags.push(...e),t&&this.inheritableTags.push(...e)}removeTags(e){this.tags=this.tags.filter(t=>!e.includes(t)),this.inheritableTags=this.inheritableTags.filter(t=>!e.includes(t))}copy(e=[],t=!0){let r=new A(this._parentRunId);for(let a of this.handlers){let i=this.inheritableHandlers.includes(a);r.addHandler(a,i)}for(let a of this.tags){let i=this.inheritableTags.includes(a);r.addTags([a],i)}for(let a of e)r.handlers.filter(i=>i.name==="console_callback_handler").some(i=>i.name===a.name)||r.addHandler(a,t);return r}static fromHandlers(e){class t extends T{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:z()}),Object.assign(this,e)}}let r=new this;return r.addHandler(new t),r}static async configure(e,t,r,a,i){let o;(e||t)&&(Array.isArray(e)||!e?(o=new A,o.setHandlers(e?.map(Ye)??[],!0)):o=e,o=o.copy(Array.isArray(t)?t.map(Ye):t?.handlers,!1));let s=m("LANGCHAIN_VERBOSE")||i?.verbose,c=m("LANGCHAIN_TRACING_V2")??!1,l=c||(m("LANGCHAIN_TRACING")??!1);if(s||l){if(o||(o=new A),s&&!o.handlers.some(u=>u.name===j.prototype.name)){let u=new j;o.addHandler(u,!0)}if(l&&!o.handlers.some(u=>u.name==="langchain_tracer"))if(c)o.addHandler(await Ge(),!0);else{let u=m("LANGCHAIN_SESSION");o.addHandler(await Be(u),!0)}}return(r||a)&&o&&(o.addTags(r??[]),o.addTags(a??[],!1)),o}}});var re,Ze=p(()=>{oe();De();Qe();re=class extends Q{constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","chat_models",this._llmType()]})}async generate(e,t,r){let a=[],i=[],o;Array.isArray(t)?o={stop:t}:t?.timeout&&!t.signal?o={...t,signal:AbortSignal.timeout(t.timeout)}:o=t??{};let s=await A.configure(r,this.callbacks,o.tags,this.tags,{verbose:this.verbose}),c={options:o,invocation_params:this?.invocationParams()},l=await s?.handleChatModelStart(this.toJSON(),e,void 0,void 0,c);try{let d=await Promise.all(e.map(h=>this._generate(h,o,l)));for(let h of d)h.llmOutput&&i.push(h.llmOutput),a.push(h.generations)}catch(d){throw await l?.handleLLMError(d),d}let u={generations:a,llmOutput:i.length?this._combineLLMOutput?.(...i):void 0};return await l?.handleLLMEnd(u),Object.defineProperty(u,He,{value:l?{runId:l?.runId}:void 0,configurable:!0}),u}invocationParams(){return{}}_modelType(){return"base_chat_model"}async generatePrompt(e,t,r){let a=e.map(i=>i.toChatMessages());return this.generate(a,t,r)}async call(e,t,r){return(await this.generate([e],t,r)).generations[0][0].message}async callPrompt(e,t,r){let a=e.toChatMessages();return this.call(a,t,r)}async predictMessages(e,t,r){return this.call(e,t,r)}async predict(e,t,r){let a=new I(e);return(await this.call([a],t,r)).text}}});var Xe,et=p(()=>{Xe=async(n,e,t,r,a,i,o,s,c)=>(await n.call(fetch,"https://api.promptlayer.com/track-request",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({function_name:e,provider:"langchain",args:t,kwargs:r,tags:a,request_response:i,request_start_time:Math.floor(o/1e3),request_end_time:Math.floor(s/1e3),api_key:c})})).json()});import{zodToJsonSchema as zt}from"/v126/zod-to-json-schema@3.21.1/deno/zod-to-json-schema.mjs";function tt(n){return{name:n.name,description:n.description,parameters:zt(n.schema)}}var rt=p(()=>{});var Ke={};it(Ke,{ChatOpenAI:()=>ne,PromptLayerChatOpenAI:()=>ve});import{Configuration as Ht,OpenAIApi as Dt}from"/v126/openai@3.3.0/deno/openai.mjs";function Te(n){switch(n){case"system":return"system";case"ai":return"assistant";case"human":return"user";case"function":return"function";default:throw new Error(`Unknown message type: ${n}`)}}function Kt(n){switch(n.role){case"user":return new I(n.content||"");case"assistant":return new M(n.content||"",{function_call:n.function_call});case"system":return new G(n.content||"");default:return new F(n.content||"",n.role??"unknown")}}var ne,ve,he=p(()=>{R();Me();Ze();oe();Y();et();rt();ne=class extends re{get callKeys(){return["stop","signal","timeout","options","functions","tools"]}get lc_secrets(){return{openAIApiKey:"OPENAI_API_KEY",azureOpenAIApiKey:"AZURE_OPENAI_API_KEY"}}get lc_aliases(){return{modelName:"model",openAIApiKey:"openai_api_key",azureOpenAIApiVersion:"azure_openai_api_version",azureOpenAIApiKey:"azure_openai_api_key",azureOpenAIApiInstanceName:"azure_openai_api_instance_name",azureOpenAIApiDeploymentName:"azure_openai_api_deployment_name"}}constructor(e,t){super(e??{}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"frequencyPenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"presencePenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"logitBias",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:"gpt-3.5-turbo"}),Object.defineProperty(this,"modelKwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiVersion",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiInstanceName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiDeploymentName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"clientConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let r=e?.openAIApiKey??m("OPENAI_API_KEY"),a=e?.azureOpenAIApiKey??m("AZURE_OPENAI_API_KEY");if(!a&&!r)throw new Error("(Azure) OpenAI API key not found");let i=e?.azureOpenAIApiInstanceName??m("AZURE_OPENAI_API_INSTANCE_NAME"),o=e?.azureOpenAIApiDeploymentName??m("AZURE_OPENAI_API_DEPLOYMENT_NAME"),s=e?.azureOpenAIApiVersion??m("AZURE_OPENAI_API_VERSION");if(this.modelName=e?.modelName??this.modelName,this.modelKwargs=e?.modelKwargs??{},this.timeout=e?.timeout,this.temperature=e?.temperature??this.temperature,this.topP=e?.topP??this.topP,this.frequencyPenalty=e?.frequencyPenalty??this.frequencyPenalty,this.presencePenalty=e?.presencePenalty??this.presencePenalty,this.maxTokens=e?.maxTokens,this.n=e?.n??this.n,this.logitBias=e?.logitBias,this.stop=e?.stop,this.streaming=e?.streaming??!1,this.azureOpenAIApiVersion=s,this.azureOpenAIApiKey=a,this.azureOpenAIApiInstanceName=i,this.azureOpenAIApiDeploymentName=o,this.streaming&&this.n>1)throw new Error("Cannot stream results when n > 1");if(this.azureOpenAIApiKey){if(!this.azureOpenAIApiInstanceName)throw new Error("Azure OpenAI API instance name not found");if(!this.azureOpenAIApiDeploymentName)throw new Error("Azure OpenAI API deployment name not found");if(!this.azureOpenAIApiVersion)throw new Error("Azure OpenAI API version not found")}this.clientConfig={apiKey:r,...t,...e?.configuration}}invocationParams(){return{model:this.modelName,temperature:this.temperature,top_p:this.topP,frequency_penalty:this.frequencyPenalty,presence_penalty:this.presencePenalty,max_tokens:this.maxTokens===-1?void 0:this.maxTokens,n:this.n,logit_bias:this.logitBias,stop:this.stop,stream:this.streaming,...this.modelKwargs}}_identifyingParams(){return{model_name:this.modelName,...this.invocationParams(),...this.clientConfig}}identifyingParams(){return this._identifyingParams()}async _generate(e,t,r){let a={};if(this.stop&&t?.stop)throw new Error("Stop found in input and default params");let i=this.invocationParams();i.stop=t?.stop??i.stop,i.functions=t?.functions??(t?.tools?t?.tools.map(tt):void 0),i.function_call=t?.function_call;let o=e.map(h=>({role:Te(h._getType()),content:h.text,name:h.name})),s=i.stream?await new Promise((h,E)=>{let _,S=!1,D=!1;this.completionWithRetry({...i,messages:o},{signal:t?.signal,...t?.options,adapter:V,responseType:"stream",onmessage:K=>{if(K.data?.trim?.()==="[DONE]"){if(D)return;D=!0,h(_)}else{let P=JSON.parse(K.data);_||(_={id:P.id,object:P.object,created:P.created,model:P.model,choices:[]});for(let g of P.choices)if(g!=null){let y=_.choices.find(nt=>nt.index===g.index);y||(y={index:g.index,finish_reason:g.finish_reason??void 0},_.choices[g.index]=y),y.message||(y.message={role:g.delta?.role,content:""}),g.delta.function_call&&!y.message.function_call&&(y.message.function_call={name:"",arguments:""}),y.message.content+=g.delta?.content??"",y.message.function_call&&(y.message.function_call.name+=g.delta?.function_call?.name??"",y.message.function_call.arguments+=g.delta?.function_call?.arguments??""),r?.handleLLMNewToken(g.delta?.content??"")}!D&&P.choices.every(g=>g.finish_reason!=null)&&(D=!0,h(_))}}}).catch(K=>{S||(S=!0,E(K))})}):await this.completionWithRetry({...i,messages:o},{signal:t?.signal,...t?.options}),{completion_tokens:c,prompt_tokens:l,total_tokens:u}=s.usage??{};c&&(a.completionTokens=(a.completionTokens??0)+c),l&&(a.promptTokens=(a.promptTokens??0)+l),u&&(a.totalTokens=(a.totalTokens??0)+u);let d=[];for(let h of s.choices){let E=h.message?.content??"";d.push({text:E,message:Kt(h.message??{role:"assistant"})})}return{generations:d,llmOutput:{tokenUsage:a}}}async getNumTokensFromMessages(e){let t=0,r=0,a=0;$(this.modelName)==="gpt-3.5-turbo"?(r=4,a=-1):$(this.modelName).startsWith("gpt-4")&&(r=3,a=1);let i=await Promise.all(e.map(async o=>{let s=await this.getNumTokens(o.text),c=await this.getNumTokens(Te(o._getType())),l=o.name!==void 0?a+await this.getNumTokens(o.name):0,u=s+r+c+l;return t+=u,u}));return t+=3,{totalCount:t,countPerMessage:i}}async completionWithRetry(e,t){if(!this.client){let a=this.azureOpenAIApiKey?`https://${this.azureOpenAIApiInstanceName}.openai.azure.com/openai/deployments/${this.azureOpenAIApiDeploymentName}`:this.clientConfig.basePath,i=new Ht({...this.clientConfig,basePath:a,baseOptions:{timeout:this.timeout,...this.clientConfig.baseOptions}});this.client=new Dt(i)}let r={adapter:ie()?void 0:V,...this.clientConfig.baseOptions,...t};return this.azureOpenAIApiKey&&(r.headers={"api-key":this.azureOpenAIApiKey,...r.headers},r.params={"api-version":this.azureOpenAIApiVersion,...r.params}),this.caller.call(this.client.createChatCompletion.bind(this.client),e,r).then(a=>a.data)}_llmType(){return"openai"}_combineLLMOutput(...e){return e.reduce((t,r)=>(r&&r.tokenUsage&&(t.tokenUsage.completionTokens+=r.tokenUsage.completionTokens??0,t.tokenUsage.promptTokens+=r.tokenUsage.promptTokens??0,t.tokenUsage.totalTokens+=r.tokenUsage.totalTokens??0),t),{tokenUsage:{completionTokens:0,promptTokens:0,totalTokens:0}})}},ve=class extends ne{constructor(e){super(e),Object.defineProperty(this,"promptLayerApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"plTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"returnPromptLayerId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.promptLayerApiKey=e?.promptLayerApiKey??(typeof __Process$<"u"?__Process$.env?.PROMPTLAYER_API_KEY:void 0),this.plTags=e?.plTags??[],this.returnPromptLayerId=e?.returnPromptLayerId??!1}async _generate(e,t,r){let a=Date.now(),i;Array.isArray(t)?i={stop:t}:t?.timeout&&!t.signal?i={...t,signal:AbortSignal.timeout(t.timeout)}:i=t??{};let o=await super._generate(e,i,r),s=Date.now(),c=u=>{let d;if(u._getType()==="human")d={role:"user",content:u.text};else if(u._getType()==="ai")d={role:"assistant",content:u.text};else if(u._getType()==="system")d={role:"system",content:u.text};else if(u._getType()==="generic")d={role:u.role,content:u.text};else throw new Error(`Got unknown type ${u}`);return d},l=(u,d)=>{let h={...this.invocationParams(),model:this.modelName};if(d?.stop&&Object.keys(h).includes("stop"))throw new Error("`stop` found in both the input and default params.");return u.map(_=>c(_))};for(let u=0;u<o.generations.length;u+=1){let d=o.generations[u],h=l(e,i),E,_=[{content:d.text,role:Te(d.message._getType())}],S=await Xe(this.caller,"langchain.PromptLayerChatOpenAI",h,this._identifyingParams(),this.plTags,_,a,s,this.promptLayerApiKey);this.returnPromptLayerId===!0&&(S.success===!0&&(E=S.request_id),(!d.generationInfo||typeof d.generationInfo!="object")&&(d.generationInfo={}),d.generationInfo.promptLayerRequestId=E)}return o}}});he();export{ne as ChatOpenAI,ve as PromptLayerChatOpenAI};
//# sourceMappingURL=openai.js.map