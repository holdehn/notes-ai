/* esm.sh - esbuild bundle(langchain@0.0.73/output_parsers) deno production */
import __Process$ from "https://deno.land/std@0.177.0/node/process.ts";var er=Object.defineProperty;var l=(i,e)=>()=>(i&&(e=i(i=0)),e);var j=(i,e)=>{for(var t in e)er(i,t,{get:e[t],enumerable:!0})};var xe,F,I,U,q,re,H,B=l(()=>{xe="__run",F=class{constructor(e){Object.defineProperty(this,"text",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.text=e}},I=class extends F{_getType(){return"human"}},U=class extends F{_getType(){return"ai"}},q=class extends F{_getType(){return"system"}},re=class extends F{constructor(e,t){super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=t}_getType(){return"generic"}},H=class{}});import*as mt from"/v124/uuid@9.0.0/deno/uuid.mjs";var Fe,A,Ue=l(()=>{Fe=class{},A=class extends Fe{constructor(e){super(),Object.defineProperty(this,"ignoreLLM",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreChain",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreAgent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),e&&(this.ignoreLLM=e.ignoreLLM??this.ignoreLLM,this.ignoreChain=e.ignoreChain??this.ignoreChain,this.ignoreAgent=e.ignoreAgent??this.ignoreAgent)}copy(){return new this.constructor(this)}static fromMethods(e){class t extends A{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:mt.v4()}),Object.assign(this,e)}}return new t}}});var ne,_e,qe=l(()=>{Ue();ne=class extends A{constructor(){super(),Object.defineProperty(this,"session",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"runMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map})}copy(){return this}async newSession(e){let t={start_time:Date.now(),name:e},r=await this.persistSession(t);return this.session=r,r}_addChildRun(e,t){if(t.type==="llm")e.child_llm_runs.push(t);else if(t.type==="chain")e.child_chain_runs.push(t);else if(t.type==="tool")e.child_tool_runs.push(t);else throw new Error("Invalid run type")}_startTrace(e){if(e.parent_uuid){let t=this.runMap.get(e.parent_uuid);if(t)if(t.type==="tool"||t.type==="chain")this._addChildRun(t,e);else throw new Error("Caller run can only be a tool or chain");else throw new Error(`Caller run ${e.parent_uuid} not found`)}this.runMap.set(e.uuid,e)}async _endTrace(e){if(!e.parent_uuid)await this.persistRun(e);else{let t=this.runMap.get(e.parent_uuid);if(t===void 0)throw new Error(`Parent run ${e.parent_uuid} not found`);t.child_execution_order=Math.max(t.child_execution_order,e.child_execution_order)}this.runMap.delete(e.uuid)}_getExecutionOrder(e){if(e===void 0)return 1;let t=this.runMap.get(e);if(t===void 0)throw new Error(`Parent run ${e} not found`);return t.child_execution_order+1}async handleLLMStart(e,t,r,n){this.session===void 0&&(this.session=await this.loadDefaultSession());let a=this._getExecutionOrder(n),s={uuid:r,parent_uuid:n,start_time:Date.now(),end_time:0,serialized:e,prompts:t,session_id:this.session.id,execution_order:a,child_execution_order:a,type:"llm"};this._startTrace(s),await this.onLLMStart?.(s)}async handleLLMEnd(e,t){let r=this.runMap.get(t);if(!r||r?.type!=="llm")throw new Error("No LLM run to end.");let n=r;n.end_time=Date.now(),n.response=e,await this.onLLMEnd?.(n),await this._endTrace(n)}async handleLLMError(e,t){let r=this.runMap.get(t);if(!r||r?.type!=="llm")throw new Error("No LLM run to end.");let n=r;n.end_time=Date.now(),n.error=e.message,await this.onLLMError?.(n),await this._endTrace(n)}async handleChainStart(e,t,r,n){this.session===void 0&&(this.session=await this.loadDefaultSession());let a=this._getExecutionOrder(n),s={uuid:r,parent_uuid:n,start_time:Date.now(),end_time:0,serialized:e,inputs:t,session_id:this.session.id,execution_order:a,child_execution_order:a,type:"chain",child_llm_runs:[],child_chain_runs:[],child_tool_runs:[]};this._startTrace(s),await this.onChainStart?.(s)}async handleChainEnd(e,t){let r=this.runMap.get(t);if(!r||r?.type!=="chain")throw new Error("No chain run to end.");let n=r;n.end_time=Date.now(),n.outputs=e,await this.onChainEnd?.(n),await this._endTrace(n)}async handleChainError(e,t){let r=this.runMap.get(t);if(!r||r?.type!=="chain")throw new Error("No chain run to end.");let n=r;n.end_time=Date.now(),n.error=e.message,await this.onChainError?.(n),await this._endTrace(n)}async handleToolStart(e,t,r,n){this.session===void 0&&(this.session=await this.loadDefaultSession());let a=this._getExecutionOrder(n),s={uuid:r,parent_uuid:n,start_time:Date.now(),end_time:0,serialized:e,tool_input:t,session_id:this.session.id,execution_order:a,child_execution_order:a,type:"tool",action:JSON.stringify(e),child_llm_runs:[],child_chain_runs:[],child_tool_runs:[]};this._startTrace(s),await this.onToolStart?.(s)}async handleToolEnd(e,t){let r=this.runMap.get(t);if(!r||r?.type!=="tool")throw new Error("No tool run to end");let n=r;n.end_time=Date.now(),n.output=e,await this.onToolEnd?.(n),await this._endTrace(n)}async handleToolError(e,t){let r=this.runMap.get(t);if(!r||r?.type!=="tool")throw new Error("No tool run to end");let n=r;n.end_time=Date.now(),n.error=e.message,await this.onToolError?.(n),await this._endTrace(n)}async handleAgentAction(e,t){let r=this.runMap.get(t);if(!r||r?.type!=="chain")return;let n=r;n.actions=n.actions||[],n.actions.push(e),await this.onAgentAction?.(r)}},_e=class extends ne{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"langchain_tracer"}),Object.defineProperty(this,"endpoint",{enumerable:!0,configurable:!0,writable:!0,value:(typeof __Process$<"u"?__Process$.env?.LANGCHAIN_ENDPOINT:void 0)||"http://localhost:8000"}),Object.defineProperty(this,"headers",{enumerable:!0,configurable:!0,writable:!0,value:{"Content-Type":"application/json"}}),typeof __Process$<"u"&&__Process$.env?.LANGCHAIN_API_KEY&&(this.headers["x-api-key"]=__Process$.env?.LANGCHAIN_API_KEY)}async persistRun(e){let t;e.type==="llm"?t=`${this.endpoint}/llm-runs`:e.type==="chain"?t=`${this.endpoint}/chain-runs`:t=`${this.endpoint}/tool-runs`;let r=await fetch(t,{method:"POST",headers:this.headers,body:JSON.stringify(e)});r.ok||console.error(`Failed to persist run: ${r.status} ${r.statusText}`)}async persistSession(e){let t=`${this.endpoint}/sessions`,r=await fetch(t,{method:"POST",headers:this.headers,body:JSON.stringify(e)});return r.ok?{id:(await r.json()).id,...e}:(console.error(`Failed to persist session: ${r.status} ${r.statusText}, using default session.`),{id:1,...e})}async loadSession(e){let t=`${this.endpoint}/sessions?name=${e}`;return this._handleSessionResponse(t)}async loadDefaultSession(){let e=`${this.endpoint}/sessions?name=default`;return this._handleSessionResponse(e)}async _handleSessionResponse(e){let t=await fetch(e,{method:"GET",headers:this.headers}),r;if(!t.ok)return console.error(`Failed to load session: ${t.status} ${t.statusText}`),r={id:1,start_time:Date.now()},this.session=r,r;let n=await t.json();return n.length===0?(r={id:1,start_time:Date.now()},this.session=r,r):([r]=n,this.session=r,r)}}});import dt from"/v124/ansi-styles@5.2.0/deno/ansi-styles.mjs";function x(i,e){return`${i.open}${e}${i.close}`}function k(i,e){try{return JSON.stringify(i,null,2)}catch{return e}}function W(i){let e=i.end_time-i.start_time;return e<1e3?`${e}ms`:`${(e/1e3).toFixed(2)}s`}var T,ie,ft=l(()=>{qe();({color:T}=dt),ie=class extends ne{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"console_callback_handler"}),Object.defineProperty(this,"i",{enumerable:!0,configurable:!0,writable:!0,value:0})}persistSession(e){return Promise.resolve({...e,id:this.i++})}persistRun(e){return Promise.resolve()}loadDefaultSession(){return this.newSession()}loadSession(e){return this.newSession(e)}getParents(e){let t=[],r=e;for(;r.parent_uuid;){let n=this.runMap.get(r.parent_uuid);if(n)t.push(n),r=n;else break}return t}getBreadcrumbs(e){let r=[...this.getParents(e).reverse(),e].map((n,a,s)=>{let o=`${n.execution_order}:${n.type}:${n.serialized?.name}`;return a===s.length-1?x(dt.bold,o):o}).join(" > ");return x(T.grey,r)}onChainStart(e){let t=this.getBreadcrumbs(e);console.log(`${x(T.green,"[chain/start]")} [${t}] Entering Chain run with input: ${k(e.inputs,"[inputs]")}`)}onChainEnd(e){let t=this.getBreadcrumbs(e);console.log(`${x(T.cyan,"[chain/end]")} [${t}] [${W(e)}] Exiting Chain run with output: ${k(e.outputs,"[outputs]")}`)}onChainError(e){let t=this.getBreadcrumbs(e);console.log(`${x(T.red,"[chain/error]")} [${t}] [${W(e)}] Chain run errored with error: ${k(e.error,"[error]")}`)}onLLMStart(e){let t=this.getBreadcrumbs(e);console.log(`${x(T.green,"[llm/start]")} [${t}] Entering LLM run with input: ${k({prompts:e.prompts.map(r=>r.trim())},"[inputs]")}`)}onLLMEnd(e){let t=this.getBreadcrumbs(e);console.log(`${x(T.cyan,"[llm/end]")} [${t}] [${W(e)}] Exiting LLM run with output: ${k(e.response,"[response]")}`)}onLLMError(e){let t=this.getBreadcrumbs(e);console.log(`${x(T.red,"[llm/error]")} [${t}] [${W(e)}] LLM run errored with error: ${k(e.error,"[error]")}`)}onToolStart(e){let t=this.getBreadcrumbs(e);console.log(`${x(T.green,"[tool/start]")} [${t}] Entering Tool run with input: "${e.tool_input?.trim()}"`)}onToolEnd(e){let t=this.getBreadcrumbs(e);console.log(`${x(T.cyan,"[tool/end]")} [${t}] [${W(e)}] Exiting Tool run with output: "${e.output?.trim()}"`)}onToolError(e){let t=this.getBreadcrumbs(e);console.log(`${x(T.red,"[tool/error]")} [${t}] [${W(e)}] Tool run errored with error: ${k(e.error,"[error]")}`)}onAgentAction(e){let t=this.getBreadcrumbs(e);console.log(`${x(T.blue,"[agent/action]")} [${t}] Agent selected action: ${k(e.actions[e.actions.length-1],"[action]")}`)}}});async function bt(i){let e=new _e;return i?await e.loadSession(i):await e.loadDefaultSession(),e}var yt=l(()=>{qe()});import{v4 as ve}from"/v124/uuid@9.0.0/deno/uuid.mjs";function wt(i){return"name"in i?i:A.fromMethods(i)}var He,ae,Be,We,Je,_,Qe=l(()=>{Ue();ft();yt();He=class{setHandler(e){return this.setHandlers([e])}},ae=class{constructor(e,t,r,n){Object.defineProperty(this,"runId",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:n})}async handleText(e){await Promise.all(this.handlers.map(async t=>{try{await t.handleText?.(e,this.runId,this._parentRunId)}catch(r){console.error(`Error in handler ${t.constructor.name}, handleText: ${r}`)}}))}},Be=class extends ae{async handleLLMNewToken(e){await Promise.all(this.handlers.map(async t=>{if(!t.ignoreLLM)try{await t.handleLLMNewToken?.(e,this.runId,this._parentRunId)}catch(r){console.error(`Error in handler ${t.constructor.name}, handleLLMNewToken: ${r}`)}}))}async handleLLMError(e){await Promise.all(this.handlers.map(async t=>{if(!t.ignoreLLM)try{await t.handleLLMError?.(e,this.runId,this._parentRunId)}catch(r){console.error(`Error in handler ${t.constructor.name}, handleLLMError: ${r}`)}}))}async handleLLMEnd(e){await Promise.all(this.handlers.map(async t=>{if(!t.ignoreLLM)try{await t.handleLLMEnd?.(e,this.runId,this._parentRunId)}catch(r){console.error(`Error in handler ${t.constructor.name}, handleLLMEnd: ${r}`)}}))}},We=class extends ae{getChild(){let e=new _(this.runId);return e.setHandlers(this.inheritableHandlers),e}async handleChainError(e){await Promise.all(this.handlers.map(async t=>{if(!t.ignoreChain)try{await t.handleChainError?.(e,this.runId,this._parentRunId)}catch(r){console.error(`Error in handler ${t.constructor.name}, handleChainError: ${r}`)}}))}async handleChainEnd(e){await Promise.all(this.handlers.map(async t=>{if(!t.ignoreChain)try{await t.handleChainEnd?.(e,this.runId,this._parentRunId)}catch(r){console.error(`Error in handler ${t.constructor.name}, handleChainEnd: ${r}`)}}))}async handleAgentAction(e){await Promise.all(this.handlers.map(async t=>{if(!t.ignoreAgent)try{await t.handleAgentAction?.(e,this.runId,this._parentRunId)}catch(r){console.error(`Error in handler ${t.constructor.name}, handleAgentAction: ${r}`)}}))}async handleAgentEnd(e){await Promise.all(this.handlers.map(async t=>{if(!t.ignoreAgent)try{await t.handleAgentEnd?.(e,this.runId,this._parentRunId)}catch(r){console.error(`Error in handler ${t.constructor.name}, handleAgentEnd: ${r}`)}}))}},Je=class extends ae{getChild(){let e=new _(this.runId);return e.setHandlers(this.inheritableHandlers),e}async handleToolError(e){await Promise.all(this.handlers.map(async t=>{if(!t.ignoreAgent)try{await t.handleToolError?.(e,this.runId,this._parentRunId)}catch(r){console.error(`Error in handler ${t.constructor.name}, handleToolError: ${r}`)}}))}async handleToolEnd(e){await Promise.all(this.handlers.map(async t=>{if(!t.ignoreAgent)try{await t.handleToolEnd?.(e,this.runId,this._parentRunId)}catch(r){console.error(`Error in handler ${t.constructor.name}, handleToolEnd: ${r}`)}}))}},_=class extends He{constructor(e){super(),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"callback_manager"}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.handlers=[],this.inheritableHandlers=[],this._parentRunId=e}async handleLLMStart(e,t,r=ve()){return await Promise.all(this.handlers.map(async n=>{if(!n.ignoreLLM)try{await n.handleLLMStart?.(e,t,r,this._parentRunId)}catch(a){console.error(`Error in handler ${n.constructor.name}, handleLLMStart: ${a}`)}})),new Be(r,this.handlers,this.inheritableHandlers,this._parentRunId)}async handleChainStart(e,t,r=ve()){return await Promise.all(this.handlers.map(async n=>{if(!n.ignoreChain)try{await n.handleChainStart?.(e,t,r,this._parentRunId)}catch(a){console.error(`Error in handler ${n.constructor.name}, handleChainStart: ${a}`)}})),new We(r,this.handlers,this.inheritableHandlers,this._parentRunId)}async handleToolStart(e,t,r=ve()){return await Promise.all(this.handlers.map(async n=>{if(!n.ignoreAgent)try{await n.handleToolStart?.(e,t,r,this._parentRunId)}catch(a){console.error(`Error in handler ${n.constructor.name}, handleToolStart: ${a}`)}})),new Je(r,this.handlers,this.inheritableHandlers,this._parentRunId)}addHandler(e,t=!0){this.handlers.push(e),t&&this.inheritableHandlers.push(e)}removeHandler(e){this.handlers=this.handlers.filter(t=>t!==e),this.inheritableHandlers=this.inheritableHandlers.filter(t=>t!==e)}setHandlers(e,t=!0){this.handlers=[],this.inheritableHandlers=[];for(let r of e)this.addHandler(r,t)}copy(e=[],t=!0){let r=new _(this._parentRunId);for(let n of this.handlers){let a=this.inheritableHandlers.includes(n);r.addHandler(n,a)}for(let n of e)r.handlers.filter(a=>a.name==="console_callback_handler").some(a=>a.name===n.name)||r.addHandler(n,t);return r}static fromHandlers(e){class t extends A{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:ve()}),Object.assign(this,e)}}let r=new this;return r.addHandler(new t),r}static async configure(e,t,r){let n;(e||t)&&(Array.isArray(e)||!e?(n=new _,n.setHandlers(e?.map(wt)??[],!0)):n=e,n=n.copy(Array.isArray(t)?t.map(wt):t?.handlers,!1));let a=typeof __Process$<"u"?__Process$.env?.LANGCHAIN_TRACING!==void 0:!1;if(r?.verbose||a){if(n||(n=new _),r?.verbose&&!n.handlers.some(s=>s.name===ie.prototype.name)){let s=new ie;n.addHandler(s,!0)}if(a&&!n.handlers.some(s=>s.name==="langchain_tracer")){let s=typeof __Process$<"u"?__Process$.env?.LANGCHAIN_SESSION:void 0;n.addHandler(await bt(s),!0)}}return n}}});import tr from"/v124/p-retry@4.6.2/deno/p-retry.mjs";import Ge from"/v124/p-queue@6.6.2/deno/p-queue.mjs";var rr,Pe,gt=l(()=>{rr=[400,401,403,404,405,406,407,408,409],Pe=class{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6;let t="default"in Ge?Ge.default:Ge;this.queue=new t({concurrency:this.maxConcurrency})}call(e,...t){return this.queue.add(()=>tr(()=>e(...t).catch(r=>{throw r instanceof Error?r:new Error(r)}),{onFailedAttempt(r){if(r.message.startsWith("Cancel")||r.message.startsWith("TimeoutError")||r.message.startsWith("AbortError")||r?.code==="ECONNABORTED")throw r;let n=r?.response?.status;if(n&&rr.includes(+n))throw r},retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}fetch(...e){return this.call(()=>fetch(...e).then(t=>t.ok?t:Promise.reject(t)))}}});var se,xt,Ye=l(()=>{se=i=>i.startsWith("gpt-3.5-turbo-")?"gpt-3.5-turbo":i.startsWith("gpt-4-32k-")?"gpt-4-32k":i.startsWith("gpt-4-")?"gpt-4":i,xt=async()=>{try{let{encoding_for_model:i}=await import("/v124/@dqbd/tiktoken@1.0.7/deno/tiktoken.mjs");return{encoding_for_model:i}}catch(i){return console.log(i),{encoding_for_model:null}}}});async function vt(i,e){let t=i.getReader(),r;for(;!(r=await t.read()).done;)e(r.value)}function Pt(i){let e,t,r,n=!1;return function(s){e===void 0?(e=s,t=0,r=-1):e=nr(e,s);let o=e.length,u=0;for(;t<o;){n&&(e[t]===10&&(u=++t),n=!1);let p=-1;for(;t<o&&p===-1;++t)switch(e[t]){case 58:r===-1&&(r=t-u);break;case 13:n=!0;case 10:p=t;break}if(p===-1)break;i(e.subarray(u,p),r),u=t,r=-1}u===o?e=void 0:u!==0&&(e=e.subarray(u),t-=u)}}function Ot(i,e,t){let r=_t(),n=new TextDecoder;return function(s,o){if(s.length===0)i?.(r),r=_t();else if(o>0){let u=n.decode(s.subarray(0,o)),p=o+(s[o+1]===32?2:1),c=n.decode(s.subarray(p));switch(u){case"data":r.data=r.data?r.data+`
`+c:c;break;case"event":r.event=c;break;case"id":e?.(r.id=c);break;case"retry":{let m=parseInt(c,10);Number.isNaN(m)||t?.(r.retry=m);break}}}}}function nr(i,e){let t=new Uint8Array(i.length+e.length);return t.set(i),t.set(e,i.length),t}function _t(){return{data:"",event:"",id:"",retry:void 0}}var Oe,Tt=l(()=>{Oe="text/event-stream"});import Te from"/v124/axios@1.4.0/deno/axios.mjs";function ir(i){try{return JSON.stringify(i)}catch{return i}}function ar(i,e,t){let{validateStatus:r}=t.config;!t.status||!r||r(t.status)?i(t):e(Ee(`Request failed with status code ${t.status} and body ${typeof t.data=="string"?t.data:ir(t.data)}`,t.config,null,t.request,t))}function sr(i){return/^([a-z][a-z\d+\-.]*:)?\/\//i.test(i)}function or(i,e){return e?i.replace(/\/+$/,"")+"/"+e.replace(/^\/+/,""):i}function Et(i){return encodeURIComponent(i).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}function ur(i,e,t){if(!e)return i;var r;if(t)r=t(e);else if(mr(e))r=e.toString();else{var n=[];At(e,function(o,u){o===null||typeof o>"u"||(Ct(o)?u=`${u}[]`:o=[o],At(o,function(c){hr(c)?c=c.toISOString():pr(c)&&(c=JSON.stringify(c)),n.push(`${Et(u)}=${Et(c)}`)}))}),r=n.join("&")}if(r){var a=i.indexOf("#");a!==-1&&(i=i.slice(0,a)),i+=(i.indexOf("?")===-1?"?":"&")+r}return i}function lr(i,e){return i&&!sr(e)?or(i,e):e}function cr(i){return typeof i>"u"}function pr(i){return i!==null&&typeof i=="object"}function hr(i){return toString.call(i)==="[object Date]"}function mr(i){return toString.call(i)==="[object URLSearchParams]"}function Ct(i){return Array.isArray(i)}function At(i,e){if(!(i===null||typeof i>"u"))if(typeof i!="object"&&(i=[i]),Ct(i))for(var t=0,r=i.length;t<r;t++)e.call(null,i[t],t,i);else for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&e.call(null,i[n],n,i)}function dr(i){return toString.call(i)==="[object FormData]"}function fr(){return typeof navigator<"u"&&(navigator.product==="ReactNative"||navigator.product==="NativeScript"||navigator.product==="NS")?!1:typeof document<"u"&&typeof document<"u"}async function Ae(i){let e=yr(i),t=await br(e,i);return new Promise((r,n)=>{t instanceof Error?n(t):Object.prototype.toString.call(i.settle)==="[object Function]"?i.settle(r,n,t):ar(r,n,t)})}async function br(i,e){let t;try{t=await fetch(i)}catch(a){return a&&a.name==="AbortError"?Ee("Request aborted",e,"ECONNABORTED",i):a&&a.name==="TimeoutError"?Ee("Request timeout",e,"ECONNABORTED",i):Ee("Network Error",e,"ERR_NETWORK",i)}let r={};t.headers.forEach((a,s)=>{r[s]=a});let n={ok:t.ok,status:t.status,statusText:t.statusText,headers:r,config:e,request:i};if(t.status>=200&&t.status!==204)if(e.responseType==="stream"){let a=t.headers.get("content-type");if(!a?.startsWith(Oe)){if(t.status>=400)return a?.startsWith("application/json")?(n.data=await t.json(),n):(n.data=await t.text(),n);throw new Error(`Expected content-type to be ${Oe}, Actual: ${a}`)}await vt(t.body,Pt(Ot(e.onmessage)))}else switch(e.responseType){case"arraybuffer":n.data=await t.arrayBuffer();break;case"blob":n.data=await t.blob();break;case"json":n.data=await t.json();break;case"formData":n.data=await t.formData();break;default:n.data=await t.text();break}return n}function yr(i){let e=new Headers(i.headers);if(i.auth){let s=i.auth.username||"",o=i.auth.password?decodeURI(encodeURIComponent(i.auth.password)):"";e.set("Authorization",`Basic ${btoa(`${s}:${o}`)}`)}let t=i.method.toUpperCase(),r={headers:e,method:t};t!=="GET"&&t!=="HEAD"&&(r.body=i.data,dr(r.body)&&fr()&&e.delete("Content-Type")),i.mode&&(r.mode=i.mode),i.cache&&(r.cache=i.cache),i.integrity&&(r.integrity=i.integrity),i.redirect&&(r.redirect=i.redirect),i.referrer&&(r.referrer=i.referrer),i.timeout&&i.timeout>0&&(r.signal=AbortSignal.timeout(i.timeout)),i.signal&&(r.signal=i.signal),cr(i.withCredentials)||(r.credentials=i.withCredentials?"include":"omit"),i.responseType==="stream"&&r.headers.set("Accept",Oe);let n=lr(i.baseURL,i.url),a=ur(n,i.params,i.paramsSerializer);return new Request(a,r)}function Ee(i,e,t,r,n){if(Te.AxiosError&&typeof Te.AxiosError=="function")return new Te.AxiosError(i,Te.AxiosError[t],e,r,n);let a=new Error(i);return wr(a,e,t,r,n)}function wr(i,e,t,r,n){return i.config=e,t&&(i.code=t),i.request=r,i.response=n,i.isAxiosError=!0,i.toJSON=function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:this.config,code:this.code,status:this.response&&this.response.status?this.response.status:null}},i}var It=l(()=>{Tt()});function kt(i,e="Human",t="AI"){let r=[];for(let n of i){let a;if(n._getType()==="human")a=e;else if(n._getType()==="ai")a=t;else if(n._getType()==="system")a="System";else if(n._getType()==="generic")a=n.role;else throw new Error(`Got unsupported message type: ${n}`);r.push(`${a}: ${n.text}`)}return r.join(`
`)}var St=l(()=>{});var Ce,jt=l(()=>{B();Ie();St();Qe();Ce=class extends J{constructor(e){super(e)}async generate(e,t,r){let n=[],a=[],s=e.map(c=>kt(c)),u=await(await _.configure(r,this.callbacks,{verbose:this.verbose}))?.handleLLMStart({name:this._llmType()},s);try{let c=await Promise.all(e.map(m=>this._generate(m,t,u)));for(let m of c)m.llmOutput&&a.push(m.llmOutput),n.push(m.generations)}catch(c){throw await u?.handleLLMError(c),c}let p={generations:n,llmOutput:a.length?this._combineLLMOutput?.(...a):void 0};return await u?.handleLLMEnd(p),Object.defineProperty(p,xe,{value:u?{runId:u?.runId}:void 0,configurable:!0}),p}_modelType(){return"base_chat_model"}async generatePrompt(e,t,r){let n=e.map(a=>a.toChatMessages());return this.generate(n,t,r)}async call(e,t,r){return(await this.generate([e],t,r)).generations[0][0].message}async callPrompt(e,t,r){let n=e.toChatMessages();return this.call(n,t,r)}}});var Mt={};j(Mt,{ChatOpenAI:()=>Ze});import{isNode as gr}from"/v124/browser-or-node@2.1.1/deno/browser-or-node.mjs";import{Configuration as xr,OpenAIApi as _r}from"/v124/openai@3.2.1/deno/openai.mjs";function vr(i){switch(i){case"system":return"system";case"ai":return"assistant";case"human":return"user";default:throw new Error(`Unknown message type: ${i}`)}}function Pr(i,e){switch(i){case"user":return new I(e);case"assistant":return new U(e);case"system":return new q(e);default:return new re(e,i??"unknown")}}var Ze,$t=l(()=>{It();jt();B();Ye();Ze=class extends Ce{constructor(e,t){super(e??{}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"frequencyPenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"presencePenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"logitBias",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:"gpt-3.5-turbo"}),Object.defineProperty(this,"modelKwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiVersion",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiInstanceName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiDeploymentName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"clientConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let r=e?.openAIApiKey??(typeof __Process$<"u"?__Process$.env?.OPENAI_API_KEY:void 0),n=e?.azureOpenAIApiKey??(typeof __Process$<"u"?__Process$.env?.AZURE_OPENAI_API_KEY:void 0);if(!n&&!r)throw new Error("(Azure) OpenAI API key not found");let a=e?.azureOpenAIApiInstanceName??(typeof __Process$<"u"?__Process$.env?.AZURE_OPENAI_API_INSTANCE_NAME:void 0),s=e?.azureOpenAIApiDeploymentName??(typeof __Process$<"u"?__Process$.env?.AZURE_OPENAI_API_DEPLOYMENT_NAME:void 0),o=e?.azureOpenAIApiVersion??(typeof __Process$<"u"?__Process$.env?.AZURE_OPENAI_API_VERSION:void 0);if(this.modelName=e?.modelName??this.modelName,this.modelKwargs=e?.modelKwargs??{},this.timeout=e?.timeout,this.temperature=e?.temperature??this.temperature,this.topP=e?.topP??this.topP,this.frequencyPenalty=e?.frequencyPenalty??this.frequencyPenalty,this.presencePenalty=e?.presencePenalty??this.presencePenalty,this.maxTokens=e?.maxTokens,this.n=e?.n??this.n,this.logitBias=e?.logitBias,this.stop=e?.stop,this.streaming=e?.streaming??!1,this.azureOpenAIApiVersion=o,this.azureOpenAIApiKey=n,this.azureOpenAIApiInstanceName=a,this.azureOpenAIApiDeploymentName=s,this.streaming&&this.n>1)throw new Error("Cannot stream results when n > 1");if(this.azureOpenAIApiKey){if(!this.azureOpenAIApiInstanceName)throw new Error("Azure OpenAI API instance name not found");if(!this.azureOpenAIApiDeploymentName)throw new Error("Azure OpenAI API deployment name not found");if(!this.azureOpenAIApiVersion)throw new Error("Azure OpenAI API version not found")}this.clientConfig={apiKey:r,...t}}invocationParams(){return{model:this.modelName,temperature:this.temperature,top_p:this.topP,frequency_penalty:this.frequencyPenalty,presence_penalty:this.presencePenalty,max_tokens:this.maxTokens===-1?void 0:this.maxTokens,n:this.n,logit_bias:this.logitBias,stop:this.stop,stream:this.streaming,...this.modelKwargs}}_identifyingParams(){return{model_name:this.modelName,...this.invocationParams(),...this.clientConfig}}identifyingParams(){return this._identifyingParams()}async _generate(e,t,r){let n=Array.isArray(t)?t:t?.stop,a=Array.isArray(t)?{}:t?.options??{},s={};if(this.stop&&n)throw new Error("Stop found in input and default params");let o=this.invocationParams();o.stop=n??o.stop;let u=e.map(P=>({role:vr(P._getType()),content:P.text,name:P.name})),p=o.stream?await new Promise((P,R)=>{let y,w=!1,C=!1;this.completionWithRetry({...o,messages:u},{...a,adapter:Ae,responseType:"stream",onmessage:z=>{if(z.data?.trim?.()==="[DONE]"){if(C)return;C=!0,P(y)}else{let V=JSON.parse(z.data);y||(y={id:V.id,object:V.object,created:V.created,model:V.model,choices:[]});for(let O of V.choices)if(O!=null){let D=y.choices.find(Xt=>Xt.index===O.index);D||(D={index:O.index,finish_reason:O.finish_reason??void 0},y.choices[O.index]=D),D.message||(D.message={role:O.delta?.role,content:O.delta?.content??""}),D.message.content+=O.delta?.content??"",r?.handleLLMNewToken(O.delta?.content??"")}!C&&V.choices.every(O=>O.finish_reason!=null)&&(C=!0,P(y))}}}).catch(z=>{w||(w=!0,R(z))})}):await this.completionWithRetry({...o,messages:u},a),{completion_tokens:c,prompt_tokens:m,total_tokens:ye}=p.usage??{};c&&(s.completionTokens=(s.completionTokens??0)+c),m&&(s.promptTokens=(s.promptTokens??0)+m),ye&&(s.totalTokens=(s.totalTokens??0)+ye);let we=[];for(let P of p.choices){let R=P.message?.role??void 0,y=P.message?.content??"";we.push({text:y,message:Pr(R,y)})}return{generations:we,llmOutput:{tokenUsage:s}}}async getNumTokensFromMessages(e){let t=0,r=0,n=0;se(this.modelName)==="gpt-3.5-turbo"?(r=4,n=-1):se(this.modelName).startsWith("gpt-4")&&(r=3,n=1);let a=await Promise.all(e.map(async s=>{let u=await this.getNumTokens(s.text)+r+(s.name?n:0);return t+=u,u}));return{totalCount:t,countPerMessage:a}}async completionWithRetry(e,t){if(!this.client){let n=this.azureOpenAIApiKey?`https://${this.azureOpenAIApiInstanceName}.openai.azure.com/openai/deployments/${this.azureOpenAIApiDeploymentName}`:this.clientConfig.basePath,a=new xr({...this.clientConfig,basePath:n,baseOptions:{timeout:this.timeout,...this.clientConfig.baseOptions}});this.client=new _r(a)}let r={adapter:gr?void 0:Ae,...this.clientConfig.baseOptions,...t};return this.azureOpenAIApiKey&&(r.headers={"api-key":this.azureOpenAIApiKey,...r.headers},r.params={"api-version":this.azureOpenAIApiVersion,...r.params}),this.caller.call(this.client.createChatCompletion.bind(this.client),e,r).then(n=>n.data)}_llmType(){return"openai"}_combineLLMOutput(...e){return e.reduce((t,r)=>(r&&r.tokenUsage&&(t.tokenUsage.completionTokens+=r.tokenUsage.completionTokens??0,t.tokenUsage.promptTokens+=r.tokenUsage.promptTokens??0,t.tokenUsage.totalTokens+=r.tokenUsage.totalTokens??0),t),{tokenUsage:{completionTokens:0,promptTokens:0,totalTokens:0}})}}});var Or,oe,J,Ie=l(()=>{gt();Ye();Or=()=>!1,oe=class{constructor(e){Object.defineProperty(this,"verbose",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"callbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.verbose=e.verbose??Or(),this.callbacks=e.callbacks}},J=class extends oe{constructor(e){super({verbose:e.verbose,callbacks:e.callbacks??e.callbackManager}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_encoding",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_registry",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.caller=new Pe(e??{})}async getNumTokens(e){let t=Math.ceil(e.length/4);try{if(!this._encoding){let{encoding_for_model:r}=await xt();r&&(this._encoding=r("modelName"in this?se(this.modelName):"gpt2"),this._registry=new FinalizationRegistry(n=>n.free()),this._registry.register(this,this._encoding))}this._encoding&&(t=this._encoding.encode(e).length)}catch(r){console.warn("Failed to calculate number of tokens with tiktoken, falling back to approximate count",r)}return t}_identifyingParams(){return{}}serialize(){return{...this._identifyingParams(),_type:this._llmType(),_model:this._modelType()}}static async deserialize(e){let{_type:t,_model:r,...n}=e;if(r&&r!=="base_chat_model")throw new Error(`Cannot load LLM with model ${r}`);let a={openai:(await Promise.resolve().then(()=>($t(),Mt))).ChatOpenAI}[t];if(a===void 0)throw new Error(`Cannot load  LLM with type ${t}`);return new a(n)}}});function Xe(i,e){let t=new Set;for(let r of e)i.has(r)&&t.add(r);return t}function Lt(i,e){let t=new Set(i);for(let r of e)t.add(r);return t}function ke(i,e){let t=new Set(i);for(let r of e)t.delete(r);return t}var Nt=l(()=>{});var et={};j(et,{SequentialChain:()=>le,SimpleSequentialChain:()=>ce});function ue(i){return Array.from(i).map(e=>`"${e}"`).join(", ")}var le,ce,tt=l(()=>{pe();Nt();le=class extends d{get inputKeys(){return this.inputVariables}get outputKeys(){return this.outputVariables}constructor(e){if(super(e),Object.defineProperty(this,"chains",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inputVariables",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputVariables",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"returnAll",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.chains=e.chains,this.inputVariables=e.inputVariables,this.outputVariables=e.outputVariables??[],this.outputVariables.length>0&&e.returnAll)throw new Error("Either specify variables to return using `outputVariables` or use `returnAll` param. Cannot apply both conditions at the same time.");this.returnAll=e.returnAll??!1,this._validateChains()}_validateChains(){if(this.chains.length===0)throw new Error("Sequential chain must have at least one chain.");let e=this.memory?.memoryKeys??[],t=new Set(this.inputKeys),r=new Set(e),n=Xe(t,r);if(n.size>0)throw new Error(`The following keys: ${ue(n)} are overlapping between memory and input keys of the chain variables. This can lead to unexpected behaviour. Please use input and memory keys that don't overlap.`);let a=Lt(t,r);for(let s of this.chains){let o=ke(new Set(s.inputKeys),a);if(o.size>0)throw new Error(`Missing variables for chain "${s._chainType()}": ${ue(o)}. Only got the following variables: ${ue(a)}.`);let u=new Set(s.outputKeys),p=Xe(a,u);if(p.size>0)throw new Error(`The following output variables for chain "${s._chainType()}" are overlapping: ${ue(p)}. This can lead to unexpected behaviour.`);for(let c of u)a.add(c)}if(this.outputVariables.length===0)if(this.returnAll){let s=ke(a,t);this.outputVariables=Array.from(s)}else this.outputVariables=this.chains[this.chains.length-1].outputKeys;else{let s=ke(new Set(this.outputVariables),new Set(a));if(s.size>0)throw new Error(`The following output variables were expected to be in the final chain output but were not found: ${ue(s)}.`)}}async _call(e,t){let r=e,n={};for(let s of this.chains){r=await s.call(r,t?.getChild());for(let o of Object.keys(r))n[o]=r[o]}let a={};for(let s of this.outputVariables)a[s]=n[s];return a}_chainType(){return"sequential_chain"}static async deserialize(e){let t=[],r=e.input_variables,n=e.output_variables,a=e.chains;for(let s of a){let o=await d.deserialize(s);t.push(o)}return new le({chains:t,inputVariables:r,outputVariables:n})}serialize(){let e=[];for(let t of this.chains)e.push(t.serialize());return{_type:this._chainType(),input_variables:this.inputVariables,output_variables:this.outputVariables,chains:e}}},ce=class extends d{get inputKeys(){return[this.inputKey]}get outputKeys(){return[this.outputKey]}constructor(e){super(e.memory,e.verbose,e.callbacks??e.callbackManager),Object.defineProperty(this,"chains",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inputKey",{enumerable:!0,configurable:!0,writable:!0,value:"input"}),Object.defineProperty(this,"outputKey",{enumerable:!0,configurable:!0,writable:!0,value:"output"}),Object.defineProperty(this,"trimOutputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.chains=e.chains,this.trimOutputs=e.trimOutputs??!1,this._validateChains()}_validateChains(){for(let e of this.chains){if(e.inputKeys.length!==1)throw new Error(`Chains used in SimpleSequentialChain should all have one input, got ${e.inputKeys.length} for ${e._chainType()}.`);if(e.outputKeys.length!==1)throw new Error(`Chains used in SimpleSequentialChain should all have one output, got ${e.outputKeys.length} for ${e._chainType()}.`)}}async _call(e,t){let r=e[this.inputKey];for(let n of this.chains)r=await n.run(r,t?.getChild()),this.trimOutputs&&(r=r.trim()),await t?.handleText(r);return{[this.outputKey]:r}}_chainType(){return"simple_sequential_chain"}static async deserialize(e){let t=[],r=e.chains;for(let n of r){let a=await d.deserialize(n);t.push(a)}return new ce({chains:t})}serialize(){let e=[];for(let t of this.chains)e.push(t.serialize());return{_type:this._chainType(),chains:e}}}});var Kt,Tr,rt,Er,Q,nt,he,Se=l(()=>{Kt=i=>{let e=i.split(""),t=[],r=(a,s)=>{for(let o=s;o<e.length;o+=1)if(a.includes(e[o]))return o;return-1},n=0;for(;n<e.length;)if(e[n]==="{"&&n+1<e.length&&e[n+1]==="{")t.push({type:"literal",text:"{"}),n+=2;else if(e[n]==="}"&&n+1<e.length&&e[n+1]==="}")t.push({type:"literal",text:"}"}),n+=2;else if(e[n]==="{"){let a=r("}",n);if(a<0)throw new Error("Unclosed '{' in template.");t.push({type:"variable",name:e.slice(n+1,a).join("")}),n=a+1}else{if(e[n]==="}")throw new Error("Single '}' in template.");{let a=r("{}",n),s=(a<0?e.slice(n):e.slice(n,a)).join("");t.push({type:"literal",text:s}),n=a<0?e.length:a}}return t},Tr=(i,e)=>Kt(i).reduce((t,r)=>{if(r.type==="variable"){if(r.name in e)return t+e[r.name];throw new Error(`Missing value for input ${r.name}`)}return t+r.text},""),rt={"f-string":Tr,jinja2:(i,e)=>""},Er={"f-string":Kt,jinja2:i=>[]},Q=(i,e,t)=>rt[e](i,t),nt=(i,e)=>Er[e](i),he=(i,e,t)=>{if(!(e in rt)){let r=Object.keys(rt);throw new Error(`Invalid template format. Got \`${e}\`;
                         should be one of ${r}`)}try{let r=t.reduce((n,a)=>(n[a]="foo",n),{});Q(i,e,r)}catch{throw new Error("Invalid prompt schema.")}}});var Rt={};j(Rt,{FewShotPromptTemplate:()=>M});var M,it=l(()=>{G();Se();E();M=class extends ${constructor(e){if(super(e),Object.defineProperty(this,"examples",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleSelector",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"examplePrompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"suffix",{enumerable:!0,configurable:!0,writable:!0,value:""}),Object.defineProperty(this,"exampleSeparator",{enumerable:!0,configurable:!0,writable:!0,value:`

`}),Object.defineProperty(this,"prefix",{enumerable:!0,configurable:!0,writable:!0,value:""}),Object.defineProperty(this,"templateFormat",{enumerable:!0,configurable:!0,writable:!0,value:"f-string"}),Object.defineProperty(this,"validateTemplate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.assign(this,e),this.examples!==void 0&&this.exampleSelector!==void 0)throw new Error("Only one of 'examples' and 'example_selector' should be provided");if(this.examples===void 0&&this.exampleSelector===void 0)throw new Error("One of 'examples' and 'example_selector' should be provided");if(this.validateTemplate){let t=this.inputVariables;this.partialVariables&&(t=t.concat(Object.keys(this.partialVariables))),he(this.prefix+this.suffix,this.templateFormat,t)}}_getPromptType(){return"few_shot"}async getExamples(e){if(this.examples!==void 0)return this.examples;if(this.exampleSelector!==void 0)return this.exampleSelector.selectExamples(e);throw new Error("One of 'examples' and 'example_selector' should be provided")}async partial(e){let t={...this};return t.inputVariables=this.inputVariables.filter(r=>!(r in e)),t.partialVariables={...this.partialVariables??{},...e},new M(t)}async format(e){let t=await this.mergePartialAndUserVariables(e),r=await this.getExamples(t),n=await Promise.all(r.map(s=>this.examplePrompt.format(s))),a=[this.prefix,...n,this.suffix].join(this.exampleSeparator);return Q(a,this.templateFormat,t)}serialize(){if(this.exampleSelector||!this.examples)throw new Error("Serializing an example selector is not currently supported");if(this.outputParser!==void 0)throw new Error("Serializing an output parser is not currently supported");return{_type:this._getPromptType(),input_variables:this.inputVariables,example_prompt:this.examplePrompt.serialize(),example_separator:this.exampleSeparator,suffix:this.suffix,prefix:this.prefix,template_format:this.templateFormat,examples:this.examples}}static async deserialize(e){let{example_prompt:t}=e;if(!t)throw new Error("Missing example prompt");let r=await h.deserialize(t),n;if(Array.isArray(e.examples))n=e.examples;else throw new Error("Invalid examples format. Only list or string are supported.");return new M({inputVariables:e.input_variables,examplePrompt:r,examples:n,exampleSeparator:e.example_separator,prefix:e.prefix,suffix:e.suffix,templateFormat:e.template_format})}}});var je,S,$,G=l(()=>{B();je=class extends H{constructor(e){super(),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.value=e}toString(){return this.value}toChatMessages(){return[new I(this.value)]}},S=class{constructor(e){Object.defineProperty(this,"inputVariables",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputParser",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"partialVariables",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let{inputVariables:t}=e;if(t.includes("stop"))throw new Error("Cannot have an input variable named 'stop', as it is used internally, please rename.");Object.assign(this,e)}async mergePartialAndUserVariables(e){let t=this.partialVariables??{},r={};for(let[a,s]of Object.entries(t))typeof s=="string"?r[a]=s:r[a]=await s();return{...r,...e}}static async deserialize(e){switch(e._type){case"prompt":{let{PromptTemplate:t}=await Promise.resolve().then(()=>(E(),at));return t.deserialize(e)}case void 0:{let{PromptTemplate:t}=await Promise.resolve().then(()=>(E(),at));return t.deserialize({...e,_type:"prompt"})}case"few_shot":{let{FewShotPromptTemplate:t}=await Promise.resolve().then(()=>(it(),Rt));return t.deserialize(e)}default:throw new Error(`Invalid prompt type in config: ${e._type}`)}}},$=class extends S{async formatPromptValue(e){let t=await this.format(e);return new je(t)}}});var at={};j(at,{PromptTemplate:()=>h});var h,E=l(()=>{G();Se();h=class extends ${constructor(e){if(super(e),Object.defineProperty(this,"template",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"templateFormat",{enumerable:!0,configurable:!0,writable:!0,value:"f-string"}),Object.defineProperty(this,"validateTemplate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.assign(this,e),this.validateTemplate){let t=this.inputVariables;this.partialVariables&&(t=t.concat(Object.keys(this.partialVariables))),he(this.template,this.templateFormat,t)}}_getPromptType(){return"prompt"}async format(e){let t=await this.mergePartialAndUserVariables(e);return Q(this.template,this.templateFormat,t)}static fromExamples(e,t,r,n=`

`,a=""){let s=[a,...e,t].join(n);return new h({inputVariables:r,template:s})}static fromTemplate(e,{templateFormat:t="f-string",...r}={}){let n=new Set;return nt(e,t).forEach(a=>{a.type==="variable"&&n.add(a.name)}),new h({inputVariables:[...n],templateFormat:t,template:e,...r})}async partial(e){let t={...this};return t.inputVariables=this.inputVariables.filter(r=>!(r in e)),t.partialVariables={...this.partialVariables??{},...e},new h(t)}serialize(){if(this.outputParser!==void 0)throw new Error("Cannot serialize a prompt template with an output parser");return{_type:this._getPromptType(),input_variables:this.inputVariables,template:this.template,template_format:this.templateFormat}}static async deserialize(e){if(!e.template)throw new Error("Prompt template must have a template");return new h({inputVariables:e.input_variables,template:e.template,templateFormat:e.template_format})}}});var Me={};j(Me,{MapReduceDocumentsChain:()=>Y,RefineDocumentsChain:()=>Z,StuffDocumentsChain:()=>L});var L,Y,Z,me=l(()=>{pe();de();E();L=class extends d{get inputKeys(){return[this.inputKey,...this.llmChain.inputKeys]}get outputKeys(){return this.llmChain.outputKeys}constructor(e){super(e),Object.defineProperty(this,"llmChain",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inputKey",{enumerable:!0,configurable:!0,writable:!0,value:"input_documents"}),Object.defineProperty(this,"documentVariableName",{enumerable:!0,configurable:!0,writable:!0,value:"context"}),this.llmChain=e.llmChain,this.documentVariableName=e.documentVariableName??this.documentVariableName,this.inputKey=e.inputKey??this.inputKey}async _call(e,t){if(!(this.inputKey in e))throw new Error(`Document key ${this.inputKey} not found.`);let{[this.inputKey]:r,...n}=e,s=r.map(({pageContent:u})=>u).join(`

`);return await this.llmChain.call({...n,[this.documentVariableName]:s},t?.getChild())}_chainType(){return"stuff_documents_chain"}static async deserialize(e){if(!e.llm_chain)throw new Error("Missing llm_chain");return new L({llmChain:await b.deserialize(e.llm_chain)})}serialize(){return{_type:this._chainType(),llm_chain:this.llmChain.serialize()}}},Y=class extends d{get inputKeys(){return[this.inputKey,...this.combineDocumentChain.inputKeys]}get outputKeys(){return this.combineDocumentChain.outputKeys}constructor(e){super(e),Object.defineProperty(this,"llmChain",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inputKey",{enumerable:!0,configurable:!0,writable:!0,value:"input_documents"}),Object.defineProperty(this,"documentVariableName",{enumerable:!0,configurable:!0,writable:!0,value:"context"}),Object.defineProperty(this,"returnIntermediateSteps",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:3e3}),Object.defineProperty(this,"maxIterations",{enumerable:!0,configurable:!0,writable:!0,value:10}),Object.defineProperty(this,"ensureMapStep",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"combineDocumentChain",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.llmChain=e.llmChain,this.combineDocumentChain=e.combineDocumentChain,this.documentVariableName=e.documentVariableName??this.documentVariableName,this.ensureMapStep=e.ensureMapStep??this.ensureMapStep,this.inputKey=e.inputKey??this.inputKey,this.maxTokens=e.maxTokens??this.maxTokens,this.maxIterations=e.maxIterations??this.maxIterations,this.returnIntermediateSteps=e.returnIntermediateSteps??!1}async _call(e,t){if(!(this.inputKey in e))throw new Error(`Document key ${this.inputKey} not found.`);let{[this.inputKey]:r,...n}=e,a=r,s=[];for(let p=0;p<this.maxIterations;p+=1){let c=a.map(w=>({[this.documentVariableName]:w.pageContent,...n})),m=c.map(async w=>{let C=await this.llmChain.prompt.format(w);return this.llmChain.llm.getNumTokens(C)}),ye=await Promise.all(m).then(w=>w.reduce((C,z)=>C+z,0)),we=p!==0||!this.ensureMapStep,P=ye<this.maxTokens;if(we&&P)break;let R=await this.llmChain.apply(c,t?[t.getChild()]:void 0),{outputKey:y}=this.llmChain;this.returnIntermediateSteps&&(s=s.concat(R.map(w=>w[y]))),a=R.map(w=>({pageContent:w[y]}))}let o={input_documents:a,...n},u=await this.combineDocumentChain.call(o,t?.getChild());return this.returnIntermediateSteps?{...u,intermediateSteps:s}:u}_chainType(){return"map_reduce_documents_chain"}static async deserialize(e){if(!e.llm_chain)throw new Error("Missing llm_chain");if(!e.combine_document_chain)throw new Error("Missing combine_document_chain");return new Y({llmChain:await b.deserialize(e.llm_chain),combineDocumentChain:await d.deserialize(e.combine_document_chain)})}serialize(){return{_type:this._chainType(),llm_chain:this.llmChain.serialize(),combine_document_chain:this.combineDocumentChain.serialize()}}},Z=class extends d{get defaultDocumentPrompt(){return new h({inputVariables:["page_content"],template:"{page_content}"})}get inputKeys(){return[this.inputKey,...this.refineLLMChain.inputKeys]}get outputKeys(){return[this.outputKey]}constructor(e){super(e),Object.defineProperty(this,"llmChain",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inputKey",{enumerable:!0,configurable:!0,writable:!0,value:"input_documents"}),Object.defineProperty(this,"outputKey",{enumerable:!0,configurable:!0,writable:!0,value:"output_text"}),Object.defineProperty(this,"documentVariableName",{enumerable:!0,configurable:!0,writable:!0,value:"context"}),Object.defineProperty(this,"initialResponseName",{enumerable:!0,configurable:!0,writable:!0,value:"existing_answer"}),Object.defineProperty(this,"refineLLMChain",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"documentPrompt",{enumerable:!0,configurable:!0,writable:!0,value:this.defaultDocumentPrompt}),this.llmChain=e.llmChain,this.refineLLMChain=e.refineLLMChain,this.documentVariableName=e.documentVariableName??this.documentVariableName,this.inputKey=e.inputKey??this.inputKey,this.outputKey=e.outputKey??this.outputKey,this.documentPrompt=e.documentPrompt??this.documentPrompt,this.initialResponseName=e.initialResponseName??this.initialResponseName}async _constructInitialInputs(e,t){let r={page_content:e.pageContent,...e.metadata},n={};return this.documentPrompt.inputVariables.forEach(o=>{n[o]=r[o]}),{...{[this.documentVariableName]:await this.documentPrompt.format({...n})},...t}}async _constructRefineInputs(e,t){let r={page_content:e.pageContent,...e.metadata},n={};this.documentPrompt.inputVariables.forEach(o=>{n[o]=r[o]});let a={[this.documentVariableName]:await this.documentPrompt.format({...n})};return{[this.initialResponseName]:t,...a}}async _call(e,t){if(!(this.inputKey in e))throw new Error(`Document key ${this.inputKey} not found.`);let{[this.inputKey]:r,...n}=e,a=r,s=await this._constructInitialInputs(a[0],n),o=await this.llmChain.predict({...s},t?.getChild()),u=[o];for(let p=1;p<a.length;p+=1){let m={...await this._constructRefineInputs(a[p],o),...n};o=await this.refineLLMChain.predict({...m},t?.getChild()),u.push(o)}return{[this.outputKey]:o}}_chainType(){return"refine_documents_chain"}static async deserialize(e){let t=e.llm_chain;if(!t)throw new Error("Missing llm_chain");let r=e.refine_llm_chain;if(!r)throw new Error("Missing refine_llm_chain");return new Z({llmChain:await b.deserialize(t),refineLLMChain:await b.deserialize(r)})}serialize(){return{_type:this._chainType(),llm_chain:this.llmChain.serialize(),refine_llm_chain:this.refineLLMChain.serialize()}}}});var st,ot,$e,Le,N,K,v,Ne=l(()=>{B();G();E();st=class{serialize(){return{_type:this.constructor.name,...JSON.parse(JSON.stringify(this))}}},ot=class extends H{constructor(e){super(),Object.defineProperty(this,"messages",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.messages=e}toString(){return JSON.stringify(this.messages)}toChatMessages(){return this.messages}},$e=class extends st{constructor(e){super(),Object.defineProperty(this,"prompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.prompt=e}get inputVariables(){return this.prompt.inputVariables}async formatMessages(e){return[await this.format(e)]}},Le=class extends S{constructor(e){super(e)}async format(e){return(await this.formatPromptValue(e)).toString()}async formatPromptValue(e){let t=await this.formatMessages(e);return new ot(t)}},N=class extends $e{async format(e){return new I(await this.prompt.format(e))}constructor(e){super(e)}static fromTemplate(e){return new this(h.fromTemplate(e))}},K=class extends $e{async format(e){return new q(await this.prompt.format(e))}constructor(e){super(e)}static fromTemplate(e){return new this(h.fromTemplate(e))}},v=class extends Le{constructor(e){if(super(e),Object.defineProperty(this,"promptMessages",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"validateTemplate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.assign(this,e),this.validateTemplate){let t=new Set;for(let s of this.promptMessages)for(let o of s.inputVariables)t.add(o);let r=new Set(this.partialVariables?this.inputVariables.concat(Object.keys(this.partialVariables)):this.inputVariables),n=new Set([...r].filter(s=>!t.has(s)));if(n.size>0)throw new Error(`Input variables \`${[...n]}\` are not used in any of the prompt messages.`);let a=new Set([...t].filter(s=>!r.has(s)));if(a.size>0)throw new Error(`Input variables \`${[...a]}\` are used in prompt messages but not in the prompt template.`)}}_getPromptType(){return"chat"}async formatMessages(e){let t=await this.mergePartialAndUserVariables(e),r=[];for(let n of this.promptMessages){let a=n.inputVariables.reduce((o,u)=>{if(!(u in t))throw new Error(`Missing value for input variable \`${u}\``);return o[u]=t[u],o},{}),s=await n.formatMessages(a);r=r.concat(s)}return r}serialize(){if(this.outputParser!==void 0)throw new Error("ChatPromptTemplate cannot be serialized if outputParser is set");return{input_variables:this.inputVariables,prompt_messages:this.promptMessages.map(e=>e.serialize())}}async partial(e){let t={...this};return t.inputVariables=this.inputVariables.filter(r=>!(r in e)),t.partialVariables={...this.partialVariables??{},...e},new v(t)}static fromPromptMessages(e){let t=e.reduce((a,s)=>a.concat(s instanceof v?s.promptMessages:[s]),[]),r=e.reduce((a,s)=>s instanceof v?Object.assign(a,s.partialVariables):a,Object.create(null)),n=new Set;for(let a of t)for(let s of a.inputVariables)s in r||n.add(s);return new v({inputVariables:[...n],promptMessages:t,partialVariables:r})}}});function Ke(i){return i._modelType()==="base_chat_model"}var ut,X,Re=l(()=>{ut=class{},X=class extends ut{constructor(e,t=[]){super(),Object.defineProperty(this,"defaultPrompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"conditionals",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.defaultPrompt=e,this.conditionals=t}getPrompt(e){for(let[t,r]of this.conditionals)if(t(e))return r;return this.defaultPrompt}}});var Ar,Cr,Ir,kr,zt,Vt=l(()=>{E();Ne();Re();Ar=new h({template:`Use the following pieces of context to answer the question at the end. If you don't know the answer, just say that you don't know, don't try to make up an answer.

{context}

Question: {question}
Helpful Answer:`,inputVariables:["context","question"]}),Cr=`Use the following pieces of context to answer the users question. 
If you don't know the answer, just say that you don't know, don't try to make up an answer.
----------------
{context}`,Ir=[K.fromTemplate(Cr),N.fromTemplate("{question}")],kr=v.fromPromptMessages(Ir),zt=new X(Ar,[[Ke,kr]])});var Dt=l(()=>{E();Ne();Re()});var Ft=l(()=>{});var Ut=l(()=>{});var qt=l(()=>{Ut()});var Ht=l(()=>{G();E();Ft();qt();it();Ne();Se()});var Bt=l(()=>{Ht();Re()});function Wt(i,e={}){let{prompt:t=zt.getPrompt(i),verbose:r}=e,n=new b({prompt:t,llm:i,verbose:r});return new L({llmChain:n,verbose:r})}var Jt=l(()=>{de();me();Vt();Dt();Bt()});var Qt={};j(Qt,{VectorDBQAChain:()=>fe});var fe,Gt=l(()=>{pe();Jt();fe=class extends d{get inputKeys(){return[this.inputKey]}get outputKeys(){return this.combineDocumentsChain.outputKeys.concat(this.returnSourceDocuments?["sourceDocuments"]:[])}constructor(e){super(e),Object.defineProperty(this,"k",{enumerable:!0,configurable:!0,writable:!0,value:4}),Object.defineProperty(this,"inputKey",{enumerable:!0,configurable:!0,writable:!0,value:"query"}),Object.defineProperty(this,"vectorstore",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"combineDocumentsChain",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"returnSourceDocuments",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.vectorstore=e.vectorstore,this.combineDocumentsChain=e.combineDocumentsChain,this.inputKey=e.inputKey??this.inputKey,this.k=e.k??this.k,this.returnSourceDocuments=e.returnSourceDocuments??this.returnSourceDocuments}async _call(e,t){if(!(this.inputKey in e))throw new Error(`Question key ${this.inputKey} not found.`);let r=e[this.inputKey],n=await this.vectorstore.similaritySearch(r,this.k),a={question:r,input_documents:n},s=await this.combineDocumentsChain.call(a,t?.getChild());return this.returnSourceDocuments?{...s,sourceDocuments:n}:s}_chainType(){return"vector_db_qa"}static async deserialize(e,t){if(!("vectorstore"in t))throw new Error("Need to pass in a vectorstore to deserialize VectorDBQAChain");let{vectorstore:r}=t;if(!e.combine_documents_chain)throw new Error("VectorDBQAChain must have combine_documents_chain in serialized data");return new fe({combineDocumentsChain:await d.deserialize(e.combine_documents_chain),k:e.k,vectorstore:r})}serialize(){return{_type:this._chainType(),combine_documents_chain:this.combineDocumentsChain.serialize(),k:this.k}}static fromLLM(e,t,r){let n=Wt(e);return new this({vectorstore:t,combineDocumentsChain:n,...r})}}});var d,pe=l(()=>{B();Qe();Ie();d=class extends oe{constructor(e,t,r){if(arguments.length===1&&typeof e=="object"&&!("saveContext"in e)){let{memory:n,callbackManager:a,...s}=e;super({...s,callbacks:a??s.callbacks}),this.memory=n}else super({verbose:t,callbacks:r}),this.memory=e}serialize(){throw new Error("Method not implemented.")}async run(e,t){if(!(this.inputKeys.length<=1))throw new Error(`Chain ${this._chainType()} expects multiple inputs, cannot use 'run' `);let n=this.inputKeys.length?{[this.inputKeys[0]]:e}:{},a=await this.call(n,t),s=Object.keys(a);if(s.length===1)return a[s[0]];throw new Error("return values have multiple keys, `run` only supported when one key currently")}async call(e,t){let r={...e};if(this.memory!=null){let o=await this.memory.loadMemoryVariables(e);for(let[u,p]of Object.entries(o))r[u]=p}let a=await(await _.configure(t,this.callbacks,{verbose:this.verbose}))?.handleChainStart({name:this._chainType()},r),s;try{s=await this._call(r,a)}catch(o){throw await a?.handleChainError(o),o}return this.memory!=null&&await this.memory.saveContext(e,s),await a?.handleChainEnd(s),Object.defineProperty(s,xe,{value:a?{runId:a?.runId}:void 0,configurable:!0}),s}async apply(e,t){return Promise.all(e.map(async(r,n)=>this.call(r,t?.[n])))}static async deserialize(e,t={}){switch(e._type){case"llm_chain":{let{LLMChain:r}=await Promise.resolve().then(()=>(de(),Yt));return r.deserialize(e)}case"sequential_chain":{let{SequentialChain:r}=await Promise.resolve().then(()=>(tt(),et));return r.deserialize(e)}case"simple_sequential_chain":{let{SimpleSequentialChain:r}=await Promise.resolve().then(()=>(tt(),et));return r.deserialize(e)}case"stuff_documents_chain":{let{StuffDocumentsChain:r}=await Promise.resolve().then(()=>(me(),Me));return r.deserialize(e)}case"map_reduce_documents_chain":{let{MapReduceDocumentsChain:r}=await Promise.resolve().then(()=>(me(),Me));return r.deserialize(e)}case"refine_documents_chain":{let{RefineDocumentsChain:r}=await Promise.resolve().then(()=>(me(),Me));return r.deserialize(e)}case"vector_db_qa":{let{VectorDBQAChain:r}=await Promise.resolve().then(()=>(Gt(),Qt));return r.deserialize(e,t)}default:throw new Error(`Invalid prompt type in config: ${e._type}`)}}}});var Yt={};j(Yt,{LLMChain:()=>b});var b,de=l(()=>{pe();G();Ie();b=class extends d{get inputKeys(){return this.prompt.inputVariables}get outputKeys(){return[this.outputKey]}constructor(e){if(super(e),Object.defineProperty(this,"prompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"llm",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputKey",{enumerable:!0,configurable:!0,writable:!0,value:"text"}),Object.defineProperty(this,"outputParser",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.prompt=e.prompt,this.llm=e.llm,this.outputKey=e.outputKey??this.outputKey,this.outputParser=e.outputParser??this.outputParser,this.prompt.outputParser){if(this.outputParser)throw new Error("Cannot set both outputParser and prompt.outputParser");this.outputParser=this.prompt.outputParser}}async _getFinalOutput(e,t,r){let n=e[0].text,a;return this.outputParser?a=await this.outputParser.parseWithPrompt(n,t,r?.getChild()):a=n,a}async _call(e,t){let r;"stop"in e&&Array.isArray(e.stop)&&(r=e.stop);let n=await this.prompt.formatPromptValue(e),{generations:a}=await this.llm.generatePrompt([n],r,t?.getChild());return{[this.outputKey]:await this._getFinalOutput(a[0],n,t)}}async predict(e,t){return(await this.call(e,t))[this.outputKey]}_chainType(){return"llm_chain"}static async deserialize(e){let{llm:t,prompt:r}=e;if(!t)throw new Error("LLMChain must have llm");if(!r)throw new Error("LLMChain must have prompt");return new b({llm:await J.deserialize(t),prompt:await S.deserialize(r)})}serialize(){return{_type:this._chainType(),llm:this.llm.serialize(),prompt:this.prompt.serialize()}}}});var g=class{async parseWithPrompt(e,t,r){return this.parse(e,r)}_type(){throw new Error("_type not implemented")}},f=class extends Error{constructor(e,t){super(e),Object.defineProperty(this,"output",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.output=t}};var ee=class extends g{},ze=class extends ee{async parse(e){try{return e.trim().split(",").map(t=>t.trim())}catch{throw new f(`Could not parse output: ${e}`,e)}}getFormatInstructions(){return"Your response should be a list of comma separated values, eg: `foo, bar, baz`"}},Ve=class extends ee{constructor({length:e,separator:t}){super(),Object.defineProperty(this,"length",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"separator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.length=e,this.separator=t||","}async parse(e){try{let t=e.trim().split(this.separator).map(r=>r.trim());if(this.length!==void 0&&t.length!==this.length)throw new f(`Incorrect number of items. Expected ${this.length}, got ${t.length}.`);return t}catch(t){throw Object.getPrototypeOf(t)===f.prototype?t:new f(`Could not parse output: ${e}`)}}getFormatInstructions(){return`Your response should be a list of ${this.length} items separated by "${this.separator}" (eg: \`foo${this.separator} bar${this.separator} baz\`)`}};var De=class extends g{constructor(e,t,r){super(),Object.defineProperty(this,"regex",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputKeys",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"defaultOutputKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.regex=typeof e=="string"?new RegExp(e):e,this.outputKeys=t,this.defaultOutputKey=r}_type(){return"regex_parser"}async parse(e){let t=e.match(this.regex);if(t)return this.outputKeys.reduce((r,n,a)=>(r[n]=t[a+1],r),{});if(this.defaultOutputKey===void 0)throw new f(`Could not parse output: ${e}`,e);return this.outputKeys.reduce((r,n)=>(r[n]=n===this.defaultOutputKey?e:"",r),{})}getFormatInstructions(){return`Your response should match the following regex: ${this.regex}`}};import{z as pt}from"/v124/zod@3.21.4/deno/zod.mjs";import{zodToJsonSchema as ht}from"/v124/zod-to-json-schema@3.21.1/deno/zod-to-json-schema.mjs";var ge=class extends g{constructor(e){super(),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:e})}static fromZodSchema(e){return new this(e)}static fromNamesAndDescriptions(e){let t=pt.object(Object.fromEntries(Object.entries(e).map(([r,n])=>[r,pt.string().describe(n)])));return new this(t)}getFormatInstructions(){return`You must format your output as a JSON value that adheres to a given "JSON Schema" instance.

"JSON Schema" is a declarative language that allows you to annotate and validate JSON documents.

For example, the example "JSON Schema" instance {{"properties": {{"foo": {{"description": "a list of test words", "type": "array", "items": {{"type": "string"}}}}}}, "required": ["foo"]}}}}
would match an object with one required property, "foo". The "type" property specifies "foo" must be an "array", and the "description" property semantically describes it as "a list of test words". The items within "foo" must be strings.
Thus, the object {{"foo": ["bar", "baz"]}} is a well-formatted instance of this example "JSON Schema". The object {{"properties": {{"foo": ["bar", "baz"]}}}} is not well-formatted.

Your output will be parsed and type-checked according to the provided schema instance, so make sure all fields in your output match the schema exactly and there are no trailing commas!

Here is the JSON Schema instance your output must adhere to. Include the enclosing markdown codeblock:
\`\`\`json
${JSON.stringify(ht(this.schema))}
\`\`\`
`}async parse(e){try{let t=e.includes("```")?e.trim().split(/```(?:json)?/)[1]:e.trim();return this.schema.parseAsync(JSON.parse(t))}catch(t){throw new f(`Failed to parse. Text: "${e}". Error: ${t}`,e)}}},te=class extends ge{getFormatInstructions(e){let t=e?.interpolationDepth??1;if(t<1)throw new Error("f string interpolation depth must be at least 1");return`Return a markdown code snippet with a JSON object formatted to look like:
\`\`\`json
${this._schemaToInstruction(ht(this.schema)).replaceAll("{","{".repeat(t)).replaceAll("}","}".repeat(t))}
\`\`\``}_schemaToInstruction(e,t=2){let r=e,n=!1;if(Array.isArray(r.type)){let[o,u]=r.type;n=u==="null",r.type=o}if(r.type==="object"&&r.properties){let o=r.description?` // ${r.description}`:"";return`{
${Object.entries(r.properties).map(([p,c])=>{let m=r.required?.includes(p)?"":" (optional)";return`${" ".repeat(t)}"${p}": ${this._schemaToInstruction(c,t+2)}${m}`}).join(`
`)}
${" ".repeat(t-2)}}${o}`}if(r.type==="array"&&r.items){let o=r.description?` // ${r.description}`:"";return`array[
${" ".repeat(t)}${this._schemaToInstruction(r.items)}
${" ".repeat(t-2)}] ${o}`}let a=n?" (nullable)":"",s=r.description?` // ${r.description}`:"";return`${r.type}${s}${a}`}};de();E();var jr=`Instructions:
--------------
{instructions}
--------------
Completion:
--------------
{completion}
--------------

Above, the Completion did not satisfy the constraints given in the Instructions.
Error:
--------------
{error}
--------------

Please try again. Please only respond with an answer that satisfies the constraints laid out in the Instructions:`,Zt=h.fromTemplate(jr);var be=class extends g{static fromLLM(e,t,r){let n=r?.prompt??Zt,a=new b({llm:e,prompt:n});return new be({parser:t,retryChain:a})}constructor({parser:e,retryChain:t}){super(),Object.defineProperty(this,"parser",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"retryChain",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.parser=e,this.retryChain=t}async parse(e,t){try{return await this.parser.parse(e,t)}catch(r){if(r instanceof f){let a=(await this.retryChain.call({instructions:this.parser.getFormatInstructions(),completion:e,error:r},t))[this.retryChain.outputKey];return this.parser.parse(a)}throw r}}getFormatInstructions(){return this.parser.getFormatInstructions()}};var lt=class extends g{constructor(...e){super(),Object.defineProperty(this,"parsers",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputDelimiter",{enumerable:!0,configurable:!0,writable:!0,value:"-----"}),this.parsers=e}async parse(e,t){let r=e.trim().split(new RegExp(`${this.outputDelimiter}Output \\d+${this.outputDelimiter}`)).slice(1),n={};for(let[a,s]of this.parsers.entries()){let o;try{let u=r[a].includes("```")?r[a].trim().split(/```/)[1]:r[a].trim();u.endsWith(this.outputDelimiter)&&(u=u.slice(0,-this.outputDelimiter.length)),o=await s.parse(u,t)}catch{o=await s.parse(e.trim(),t)}Object.assign(n,o)}return n}getFormatInstructions(){return`${[`Return the following ${this.parsers.length} outputs, each formatted as described below. Include the delimiter characters "${this.outputDelimiter}" in your response:`,...this.parsers.map((e,t)=>`${this.outputDelimiter}Output ${t+1}${this.outputDelimiter}
${e.getFormatInstructions().trim()}
${this.outputDelimiter}`)].join(`

`)}
`}};var ct=class extends te{constructor(e,t){super(e),Object.defineProperty(this,"defaultDestination",{enumerable:!0,configurable:!0,writable:!0,value:"DEFAULT"}),this.defaultDestination=t?.defaultDestination??this.defaultDestination}async parse(e){try{let t=await super.parse(e);return t.destination?.toLowerCase()===this.defaultDestination.toLowerCase()&&(t.destination=null),t}catch(t){throw new f(`Failed to parse. Text: "${e}". Error: ${t}`,e)}}};export{lt as CombiningOutputParser,ze as CommaSeparatedListOutputParser,Ve as CustomListOutputParser,te as JsonMarkdownStructuredOutputParser,ee as ListOutputParser,be as OutputFixingParser,De as RegexParser,ct as RouterOutputParser,ge as StructuredOutputParser};
//# sourceMappingURL=output_parsers.js.map