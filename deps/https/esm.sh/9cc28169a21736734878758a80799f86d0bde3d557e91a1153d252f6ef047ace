/* esm.sh - esbuild bundle(langchain@0.0.95/embeddings) deno production */
import __Process$ from "https://deno.land/std@0.177.1/node/process.ts";import{Configuration as X,OpenAIApi as ee}from"/v125/openai@3.3.0/deno/openai.mjs";var T=()=>typeof Deno<"u",P=()=>typeof __Process$<"u"&&typeof __Process$.versions<"u"&&typeof __Process$.versions.node<"u"&&!T();function l(e){try{return typeof __Process$<"u"?__Process$.env?.[e]:void 0}catch{return}}import b from"/v125/axios@1.4.0/deno/axios.mjs";var h="text/event-stream";async function x(e,t){let r=e.getReader();for(;;){let n=await r.read();if(n.done){t(new Uint8Array,!0);break}t(n.value)}}function z(e){let t,r,n,i=!1;return function(s,o){if(o){e(s,0,!0);return}t===void 0?(t=s,r=0,n=-1):t=j(t,s);let d=t.length,c=0;for(;r<d;){i&&(t[r]===10&&(c=++r),i=!1);let u=-1;for(;r<d&&u===-1;++r)switch(t[r]){case 58:n===-1&&(n=r-c);break;case 13:i=!0;case 10:u=r;break}if(u===-1)break;e(t.subarray(c,u),n),c=r,n=-1}c===d?t=void 0:c!==0&&(t=t.subarray(c),r-=c)}}function R(e,t,r){let n=g(),i=new TextDecoder;return function(s,o,d){if(d){_(n)||(e?.(n),n=g());return}if(s.length===0)e?.(n),n=g();else if(o>0){let c=i.decode(s.subarray(0,o)),u=o+(s[o+1]===32?2:1),m=i.decode(s.subarray(u));switch(c){case"data":n.data=n.data?n.data+`
`+m:m;break;case"event":n.event=m;break;case"id":t?.(n.id=m);break;case"retry":{let v=parseInt(m,10);Number.isNaN(v)||r?.(n.retry=v);break}}}}}function j(e,t){let r=new Uint8Array(e.length+t.length);return r.set(e),r.set(t,e.length),r}function g(){return{data:"",event:"",id:"",retry:void 0}}function _(e){return e.data===""&&e.event===""&&e.id===""&&e.retry===void 0}function k(e){try{return JSON.stringify(e)}catch{return e}}function K(e,t,r){let{validateStatus:n}=r.config;!r.status||!n||n(r.status)?e(r):t(y(`Request failed with status code ${r.status} and body ${typeof r.data=="string"?r.data:k(r.data)}`,r.config,null,r.request,r))}function W(e){return/^([a-z][a-z\d+\-.]*:)?\/\//i.test(e)}function U(e,t){return t?e.replace(/\/+$/,"")+"/"+t.replace(/^\/+/,""):e}function S(e){return encodeURIComponent(e).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}function $(e,t,r){if(!t)return e;var n;if(r)n=r(t);else if(J(t))n=t.toString();else{var i=[];C(t,function(o,d){o===null||typeof o>"u"||(D(o)?d=`${d}[]`:o=[o],C(o,function(u){M(u)?u=u.toISOString():V(u)&&(u=JSON.stringify(u)),i.push(`${S(d)}=${S(u)}`)}))}),n=i.join("&")}if(n){var a=e.indexOf("#");a!==-1&&(e=e.slice(0,a)),e+=(e.indexOf("?")===-1?"?":"&")+n}return e}function B(e,t){return e&&!W(t)?U(e,t):t}function L(e){return typeof e>"u"}function V(e){return e!==null&&typeof e=="object"}function M(e){return toString.call(e)==="[object Date]"}function J(e){return toString.call(e)==="[object URLSearchParams]"}function D(e){return Array.isArray(e)}function C(e,t){if(!(e===null||typeof e>"u"))if(typeof e!="object"&&(e=[e]),D(e))for(var r=0,n=e.length;r<n;r++)t.call(null,e[r],r,e);else for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.call(null,e[i],i,e)}function Y(e){return toString.call(e)==="[object FormData]"}function F(){return typeof navigator<"u"&&(navigator.product==="ReactNative"||navigator.product==="NativeScript"||navigator.product==="NS")?!1:typeof document<"u"&&typeof document<"u"}async function E(e){let t=Z(e),r=await Q(t,e);return new Promise((n,i)=>{r instanceof Error?i(r):Object.prototype.toString.call(e.settle)==="[object Function]"?e.settle(n,i,r):K(n,i,r)})}async function Q(e,t){let r;try{r=await fetch(e)}catch(a){return a&&a.name==="AbortError"?y("Request aborted",t,"ECONNABORTED",e):a&&a.name==="TimeoutError"?y("Request timeout",t,"ECONNABORTED",e):y("Network Error",t,"ERR_NETWORK",e)}let n={};r.headers.forEach((a,s)=>{n[s]=a});let i={ok:r.ok,status:r.status,statusText:r.statusText,headers:n,config:t,request:e};if(r.status>=200&&r.status!==204)if(t.responseType==="stream"){let a=r.headers.get("content-type");if(!a?.startsWith(h)){if(r.status>=400)return a?.startsWith("application/json")?(i.data=await r.json(),i):(i.data=await r.text(),i);throw new Error(`Expected content-type to be ${h}, Actual: ${a}`)}await x(r.body,z(R(t.onmessage)))}else switch(t.responseType){case"arraybuffer":i.data=await r.arrayBuffer();break;case"blob":i.data=await r.blob();break;case"json":i.data=await r.json();break;case"formData":i.data=await r.formData();break;default:i.data=await r.text();break}return i}function Z(e){let t=new Headers(e.headers);if(e.auth){let s=e.auth.username||"",o=e.auth.password?decodeURI(encodeURIComponent(e.auth.password)):"";t.set("Authorization",`Basic ${btoa(`${s}:${o}`)}`)}let r=e.method.toUpperCase(),n={headers:t,method:r};r!=="GET"&&r!=="HEAD"&&(n.body=e.data,Y(n.body)&&F()&&t.delete("Content-Type")),typeof n.body=="string"&&(n.body=new TextEncoder().encode(n.body)),e.mode&&(n.mode=e.mode),e.cache&&(n.cache=e.cache),e.integrity&&(n.integrity=e.integrity),e.redirect&&(n.redirect=e.redirect),e.referrer&&(n.referrer=e.referrer),e.timeout&&e.timeout>0&&(n.signal=AbortSignal.timeout(e.timeout)),e.signal&&(n.signal=e.signal),L(e.withCredentials)||(n.credentials=e.withCredentials?"include":"omit"),e.responseType==="stream"&&n.headers.set("Accept",h);let i=B(e.baseURL,e.url),a=$(i,e.params,e.paramsSerializer);return new Request(a,n)}function y(e,t,r,n,i){if(b.AxiosError&&typeof b.AxiosError=="function")return new b.AxiosError(e,b.AxiosError[r],t,n,i);let a=new Error(e);return q(a,t,r,n,i)}function q(e,t,r,n,i){return e.config=t,r&&(e.code=r),e.request=n,e.response=i,e.isAxiosError=!0,e.toJSON=function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:this.config,code:this.code,status:this.response&&this.response.status?this.response.status:null}},e}var A=(e,t)=>e.reduce((r,n,i)=>{let a=Math.floor(i/t),s=r[a]||[];return r[a]=s.concat([n]),r},[]);import G from"/v125/p-retry@4.6.2/deno/p-retry.mjs";import O from"/v125/p-queue@6.6.2/deno/p-queue.mjs";var H=[400,401,403,404,405,406,407,408,409],w=class{constructor(t){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=t.maxConcurrency??1/0,this.maxRetries=t.maxRetries??6;let r="default"in O?O.default:O;this.queue=new r({concurrency:this.maxConcurrency})}call(t,...r){return this.queue.add(()=>G(()=>t(...r).catch(n=>{throw n instanceof Error?n:new Error(n)}),{onFailedAttempt(n){if(n.message.startsWith("Cancel")||n.message.startsWith("TimeoutError")||n.message.startsWith("AbortError")||n?.code==="ECONNABORTED")throw n;let i=n?.response?.status;if(i&&H.includes(+i))throw n},retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(t,r,...n){return t.signal?Promise.race([this.call(r,...n),new Promise((i,a)=>{t.signal?.addEventListener("abort",()=>{a(new Error("AbortError"))})})]):this.call(r,...n)}fetch(...t){return this.call(()=>fetch(...t).then(r=>r.ok?r:Promise.reject(r)))}};var p=class{constructor(t){Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.caller=new w(t??{})}};var N=class extends p{constructor(t,r){super(t??{}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:"text-embedding-ada-002"}),Object.defineProperty(this,"batchSize",{enumerable:!0,configurable:!0,writable:!0,value:this.azureOpenAIApiKey?1:512}),Object.defineProperty(this,"stripNewLines",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiVersion",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiInstanceName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiDeploymentName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"clientConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let n=t?.openAIApiKey??l("OPENAI_API_KEY"),i=t?.azureOpenAIApiKey??l("AZURE_OPENAI_API_KEY");if(!i&&!n)throw new Error("(Azure) OpenAI API key not found");let a=t?.azureOpenAIApiInstanceName??l("AZURE_OPENAI_API_INSTANCE_NAME"),s=(t?.azureOpenAIApiEmbeddingsDeploymentName||t?.azureOpenAIApiDeploymentName)??(l("AZURE_OPENAI_API_EMBEDDINGS_DEPLOYMENT_NAME")||l("AZURE_OPENAI_API_DEPLOYMENT_NAME")),o=t?.azureOpenAIApiVersion??l("AZURE_OPENAI_API_VERSION");if(this.modelName=t?.modelName??this.modelName,this.batchSize=t?.batchSize??this.batchSize,this.stripNewLines=t?.stripNewLines??this.stripNewLines,this.timeout=t?.timeout,this.azureOpenAIApiVersion=o,this.azureOpenAIApiKey=i,this.azureOpenAIApiInstanceName=a,this.azureOpenAIApiDeploymentName=s,this.azureOpenAIApiKey){if(!this.azureOpenAIApiInstanceName)throw new Error("Azure OpenAI API instance name not found");if(!this.azureOpenAIApiDeploymentName)throw new Error("Azure OpenAI API deployment name not found");if(!this.azureOpenAIApiVersion)throw new Error("Azure OpenAI API version not found")}this.clientConfig={apiKey:n,...r}}async embedDocuments(t){let r=A(this.stripNewLines?t.map(i=>i.replaceAll(`
`," ")):t,this.batchSize),n=[];for(let i=0;i<r.length;i+=1){let a=r[i],{data:s}=await this.embeddingWithRetry({model:this.modelName,input:a});for(let o=0;o<a.length;o+=1)n.push(s.data[o].embedding)}return n}async embedQuery(t){let{data:r}=await this.embeddingWithRetry({model:this.modelName,input:this.stripNewLines?t.replaceAll(`
`," "):t});return r.data[0].embedding}async embeddingWithRetry(t){if(!this.client){let n=this.azureOpenAIApiKey?`https://${this.azureOpenAIApiInstanceName}.openai.azure.com/openai/deployments/${this.azureOpenAIApiDeploymentName}`:this.clientConfig.basePath,i=new X({...this.clientConfig,basePath:n,baseOptions:{timeout:this.timeout,adapter:P()?void 0:E,...this.clientConfig.baseOptions}});this.client=new ee(i)}let r={};return this.azureOpenAIApiKey&&(r.headers={"api-key":this.azureOpenAIApiKey,...r.headers},r.params={"api-version":this.azureOpenAIApiVersion,...r.params}),this.caller.call(this.client.createEmbedding.bind(this.client),t,r)}};var f=class extends p{constructor(t){super(t??{}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:"small"}),Object.defineProperty(this,"batchSize",{enumerable:!0,configurable:!0,writable:!0,value:48}),Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let r=t?.apiKey||l("COHERE_API_KEY");if(!r)throw new Error("Cohere API key not found");this.modelName=t?.modelName??this.modelName,this.batchSize=t?.batchSize??this.batchSize,this.apiKey=r}async embedDocuments(t){await this.maybeInitClient();let r=A(t,this.batchSize),n=[];for(let i=0;i<r.length;i+=1){let a=r[i],{body:s}=await this.embeddingWithRetry({model:this.modelName,texts:a});for(let o=0;o<a.length;o+=1)n.push(s.embeddings[o])}return n}async embedQuery(t){await this.maybeInitClient();let{body:r}=await this.embeddingWithRetry({model:this.modelName,texts:[t]});return r.embeddings[0]}async embeddingWithRetry(t){return await this.maybeInitClient(),this.caller.call(this.client.embed.bind(this.client),t)}async maybeInitClient(){if(!this.client){let{cohere:t}=await f.imports();this.client=t,this.client.init(this.apiKey)}}static async imports(){try{let{default:t}=await import("/v125/cohere-ai@5.1.0/deno/cohere-ai.mjs");return{cohere:t}}catch{throw new Error("Please install cohere-ai as a dependency with, e.g. `yarn add cohere-ai`")}}};var I=class extends p{constructor(t){super(t??{})}embedDocuments(t){return Promise.resolve(t.map(()=>[.1,.2,.3,.4]))}embedQuery(t){return Promise.resolve([.1,.2,.3,.4])}};export{f as CohereEmbeddings,p as Embeddings,I as FakeEmbeddings,N as OpenAIEmbeddings};
//# sourceMappingURL=embeddings.js.map