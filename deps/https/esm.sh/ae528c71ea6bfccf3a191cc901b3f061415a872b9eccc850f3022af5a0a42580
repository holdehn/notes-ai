/* esm.sh - esbuild bundle(langchain@0.0.66/chat_models/openai) deno production */
import __Process$ from "https://deno.land/std@0.177.0/node/process.ts";var ke=Object.defineProperty;var d=(n,e)=>()=>(n&&(e=n(n=0)),e);var ve=(n,e)=>{for(var t in e)ke(n,t,{get:e[t],enumerable:!0})};async function re(n,e){let t=n.getReader(),r;for(;!(r=await t.read()).done;)e(r.value)}function ne(n){let e,t,r,s=!1;return function(o){e===void 0?(e=o,t=0,r=-1):e=Oe(e,o);let i=e.length,u=0;for(;t<i;){s&&(e[t]===10&&(u=++t),s=!1);let c=-1;for(;t<i&&c===-1;++t)switch(e[t]){case 58:r===-1&&(r=t-u);break;case 13:s=!0;case 10:c=t;break}if(c===-1)break;n(e.subarray(u,c),r),u=t,r=-1}u===i?e=void 0:u!==0&&(e=e.subarray(u),t-=u)}}function se(n,e,t){let r=te(),s=new TextDecoder;return function(o,i){if(o.length===0)n?.(r),r=te();else if(i>0){let u=s.decode(o.subarray(0,i)),c=i+(o[i+1]===32?2:1),l=s.decode(o.subarray(c));switch(u){case"data":r.data=r.data?r.data+`
`+l:l;break;case"event":r.event=l;break;case"id":e?.(r.id=l);break;case"retry":{let m=parseInt(l,10);Number.isNaN(m)||t?.(r.retry=m);break}}}}}function Oe(n,e){let t=new Uint8Array(n.length+e.length);return t.set(n),t.set(e,n.length),t}function te(){return{data:"",event:"",id:"",retry:void 0}}var v,ae=d(()=>{v="text/event-stream"});import O from"/v118/axios@1.4.0/deno/axios.mjs";function Le(n,e,t){let{validateStatus:r}=t.config;!t.status||!r||r(t.status)?n(t):e(L(`Request failed with status code ${t.status}`,t.config,null,t.request,t))}function Ae(n){return/^([a-z][a-z\d+\-.]*:)?\/\//i.test(n)}function Ne(n,e){return e?n.replace(/\/+$/,"")+"/"+e.replace(/^\/+/,""):n}function ie(n){return encodeURIComponent(n).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}function Me(n,e,t){if(!e)return n;var r;if(t)r=t(e);else if(je(e))r=e.toString();else{var s=[];oe(e,function(i,u){i===null||typeof i>"u"||(ue(i)?u=`${u}[]`:i=[i],oe(i,function(l){Ie(l)?l=l.toISOString():Ce(l)&&(l=JSON.stringify(l)),s.push(`${ie(u)}=${ie(l)}`)}))}),r=s.join("&")}if(r){var a=n.indexOf("#");a!==-1&&(n=n.slice(0,a)),n+=(n.indexOf("?")===-1?"?":"&")+r}return n}function Se(n,e){return n&&!Ae(e)?Ne(n,e):e}function $e(n){return typeof n>"u"}function Ce(n){return n!==null&&typeof n=="object"}function Ie(n){return toString.call(n)==="[object Date]"}function je(n){return toString.call(n)==="[object URLSearchParams]"}function ue(n){return Array.isArray(n)}function oe(n,e){if(!(n===null||typeof n>"u"))if(typeof n!="object"&&(n=[n]),ue(n))for(var t=0,r=n.length;t<r;t++)e.call(null,n[t],t,n);else for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&e.call(null,n[s],s,n)}function Re(n){return toString.call(n)==="[object FormData]"}function He(){return typeof navigator<"u"&&(navigator.product==="ReactNative"||navigator.product==="NativeScript"||navigator.product==="NS")?!1:typeof document<"u"&&typeof document<"u"}async function D(n){let e=Ue(n),t=await De(e,n);return new Promise((r,s)=>{t instanceof Error?s(t):Object.prototype.toString.call(n.settle)==="[object Function]"?n.settle(r,s,t):Le(r,s,t)})}async function De(n,e){let t;try{t=await fetch(n)}catch(a){return a&&a.name==="AbortError"?L("Request aborted",e,"ECONNABORTED",n):a&&a.name==="TimeoutError"?L("Request timeout",e,"ECONNABORTED",n):L("Network Error",e,"ERR_NETWORK",n)}let r={};t.headers.forEach((a,o)=>{r[o]=a});let s={ok:t.ok,status:t.status,statusText:t.statusText,headers:r,config:e,request:n};if(t.status>=200&&t.status!==204)if(e.responseType==="stream"){let a=t.headers.get("content-type");if(!a?.startsWith(v))throw new Error(`Expected content-type to be ${v}, Actual: ${a}`);await re(t.body,ne(se(e.onmessage)))}else switch(e.responseType){case"arraybuffer":s.data=await t.arrayBuffer();break;case"blob":s.data=await t.blob();break;case"json":s.data=await t.json();break;case"formData":s.data=await t.formData();break;default:s.data=await t.text();break}return s}function Ue(n){let e=new Headers(n.headers);if(n.auth){let o=n.auth.username||"",i=n.auth.password?decodeURI(encodeURIComponent(n.auth.password)):"";e.set("Authorization",`Basic ${btoa(`${o}:${i}`)}`)}let t=n.method.toUpperCase(),r={headers:e,method:t};t!=="GET"&&t!=="HEAD"&&(r.body=n.data,Re(r.body)&&He()&&e.delete("Content-Type")),n.mode&&(r.mode=n.mode),n.cache&&(r.cache=n.cache),n.integrity&&(r.integrity=n.integrity),n.redirect&&(r.redirect=n.redirect),n.referrer&&(r.referrer=n.referrer),n.timeout&&n.timeout>0&&(r.signal=AbortSignal.timeout(n.timeout)),n.signal&&(r.signal=n.signal),$e(n.withCredentials)||(r.credentials=n.withCredentials?"include":"omit"),n.responseType==="stream"&&r.headers.set("Accept",v);let s=Se(n.baseURL,n.url),a=Me(s,n.params,n.paramsSerializer);return new Request(a,r)}function L(n,e,t,r,s){if(O.AxiosError&&typeof O.AxiosError=="function")return new O.AxiosError(n,O.AxiosError[t],e,r,s);let a=new Error(n);return ze(a,e,t,r,s)}function ze(n,e,t,r,s){return n.config=e,t&&(n.code=t),n.request=r,n.response=s,n.isAxiosError=!0,n.toJSON=function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:this.config,code:this.code,status:this.response&&this.response.status?this.response.status:null}},n}var le=d(()=>{ae()});var ce,w,A,T,N,M,U=d(()=>{ce="__run",w=class{constructor(e){Object.defineProperty(this,"text",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.text=e}},A=class extends w{_getType(){return"human"}},T=class extends w{_getType(){return"ai"}},N=class extends w{_getType(){return"system"}},M=class extends w{constructor(e,t){super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=t}_getType(){return"generic"}}});import Fe from"/v118/p-retry@4.6.2/deno/p-retry.mjs";import z from"/v118/p-queue@6.6.2/deno/p-queue.mjs";var We,S,de=d(()=>{We=[400,401,403,404,405,406,407,408,409],S=class{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6;let t="default"in z?z.default:z;this.queue=new t({concurrency:this.maxConcurrency})}call(e,...t){return this.queue.add(()=>Fe(()=>e(...t).catch(r=>{throw r instanceof Error?r:new Error(r)}),{onFailedAttempt(r){if(r.message.startsWith("Cancel")||r.message.startsWith("TimeoutError")||r.message.startsWith("AbortError")||r?.code==="ECONNABORTED")throw r;let s=r?.response?.status;if(s&&We.includes(+s))throw r},retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}fetch(...e){return this.call(()=>fetch(...e).then(t=>t.ok?t:Promise.reject(t)))}}});var E,he,F=d(()=>{E=n=>n.startsWith("gpt-3.5-turbo-")?"gpt-3.5-turbo":n.startsWith("gpt-4-32k-")?"gpt-4-32k":n.startsWith("gpt-4-")?"gpt-4":n,he=async()=>{try{let{encoding_for_model:n}=await import("/v118/@dqbd/tiktoken@1.0.7/deno/tiktoken.mjs");return{encoding_for_model:n}}catch(n){return console.log(n),{encoding_for_model:null}}}});var Ke,W,$,pe=d(()=>{de();F();Ke=()=>!1,W=class{constructor(e){Object.defineProperty(this,"verbose",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"callbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.verbose=e.verbose??Ke(),this.callbacks=e.callbacks}},$=class extends W{constructor(e){super({verbose:e.verbose,callbacks:e.callbacks??e.callbackManager}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_encoding",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_registry",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.caller=new S(e??{})}async getNumTokens(e){let t=Math.ceil(e.length/4);try{if(!this._encoding){let{encoding_for_model:r}=await he();r&&(this._encoding=r("modelName"in this?E(this.modelName):"gpt2"),this._registry=new FinalizationRegistry(s=>s.free()),this._registry.register(this,this._encoding))}this._encoding&&(t=this._encoding.encode(e).length)}catch(r){console.warn("Failed to calculate number of tokens with tiktoken, falling back to approximate count",r)}return t}_identifyingParams(){return{}}serialize(){return{...this._identifyingParams(),_type:this._llmType(),_model:this._modelType()}}static async deserialize(e){let{_type:t,_model:r,...s}=e;if(r&&r!=="base_chat_model")throw new Error(`Cannot load LLM with model ${r}`);let a={openai:(await Promise.resolve().then(()=>(K(),me))).ChatOpenAI}[t];if(a===void 0)throw new Error(`Cannot load  LLM with type ${t}`);return new a(s)}}});function fe(n,e="Human",t="AI"){let r=[];for(let s of n){let a;if(s._getType()==="human")a=e;else if(s._getType()==="ai")a=t;else if(s._getType()==="system")a="System";else if(s._getType()==="generic")a=s.role;else throw new Error(`Got unsupported message type: ${s}`);r.push(`${a}: ${s.text}`)}return r.join(`
`)}var ge=d(()=>{});import{v4 as qe}from"/v118/uuid@9.0.0/deno/uuid.mjs";var q,h,C=d(()=>{q=class{},h=class extends q{constructor(e){super(),Object.defineProperty(this,"ignoreLLM",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreChain",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreAgent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),e&&(this.ignoreLLM=e.ignoreLLM??this.ignoreLLM,this.ignoreChain=e.ignoreChain??this.ignoreChain,this.ignoreAgent=e.ignoreAgent??this.ignoreAgent)}copy(){return new this.constructor(this)}static fromMethods(e){class t extends h{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:qe()}),Object.assign(this,e)}}return new t}}});var I,ye=d(()=>{C();I=class extends h{constructor(){super(...arguments),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"console_callback_handler"})}handleLLMStart(e,t,r){console.log(`Starting LLM ${r} with name ${e.name} with prompts: ${t.join(", ")}
`)}handleLLMError(e,t){console.log(`LLM ${t} errored: ${e}
`)}handleLLMEnd(e,t){console.log(`LLM ${t} finished: ${JSON.stringify(e)}
`)}handleChainStart(e){console.log(`Entering new ${e.name} chain...`)}handleChainEnd(e){console.log("Finished chain.")}handleAgentAction(e){console.log(e.log)}handleToolEnd(e){console.log(e)}handleText(e){console.log(e)}handleAgentEnd(e){console.log(e.log)}}});var G,_,be=d(()=>{C();G=class extends h{constructor(){super(),Object.defineProperty(this,"session",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"runMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"executionOrder",{enumerable:!0,configurable:!0,writable:!0,value:1})}async newSession(e){let t={start_time:Date.now(),name:e},r=await this.persistSession(t);return this.session=r,r}_addChildRun(e,t){if(t.type==="llm")e.child_llm_runs.push(t);else if(t.type==="chain")e.child_chain_runs.push(t);else if(t.type==="tool")e.child_tool_runs.push(t);else throw new Error("Invalid run type")}_startTrace(e){if(this.executionOrder+=1,e.parent_uuid){let t=this.runMap.get(e.parent_uuid);if(t)if(t.type==="tool"||t.type==="chain")this._addChildRun(t,e);else throw new Error("Caller run can only be a tool or chain");else throw new Error(`Caller run ${e.parent_uuid} not found`)}this.runMap.set(e.uuid,e)}async _endTrace(e){e.parent_uuid||(await this.persistRun(e),this.executionOrder=1),this.runMap.delete(e.uuid)}async handleLLMStart(e,t,r,s){this.session===void 0&&(this.session=await this.loadDefaultSession());let a={uuid:r,parent_uuid:s,start_time:Date.now(),end_time:0,serialized:e,prompts:t,session_id:this.session.id,execution_order:this.executionOrder,type:"llm"};this._startTrace(a)}async handleLLMEnd(e,t){let r=this.runMap.get(t);if(!r||r?.type!=="llm")throw new Error("No LLM run to end.");let s=r;s.end_time=Date.now(),s.response=e,await this._endTrace(s)}async handleLLMError(e,t){let r=this.runMap.get(t);if(!r||r?.type!=="llm")throw new Error("No LLM run to end.");let s=r;s.end_time=Date.now(),s.error=e.message,await this._endTrace(s)}async handleChainStart(e,t,r,s){this.session===void 0&&(this.session=await this.loadDefaultSession());let a={uuid:r,parent_uuid:s,start_time:Date.now(),end_time:0,serialized:e,inputs:t,session_id:this.session.id,execution_order:this.executionOrder,type:"chain",child_llm_runs:[],child_chain_runs:[],child_tool_runs:[]};this._startTrace(a)}async handleChainEnd(e,t){let r=this.runMap.get(t);if(!r||r?.type!=="chain")throw new Error("No chain run to end.");let s=r;s.end_time=Date.now(),s.outputs=e,await this._endTrace(s)}async handleChainError(e,t){let r=this.runMap.get(t);if(!r||r?.type!=="chain")throw new Error("No chain run to end.");let s=r;s.end_time=Date.now(),s.error=e.message,await this._endTrace(s)}async handleToolStart(e,t,r,s){this.session===void 0&&(this.session=await this.loadDefaultSession());let a={uuid:r,parent_uuid:s,start_time:Date.now(),end_time:0,serialized:e,tool_input:t,session_id:this.session.id,execution_order:this.executionOrder,type:"tool",action:JSON.stringify(e),child_llm_runs:[],child_chain_runs:[],child_tool_runs:[]};this._startTrace(a)}async handleToolEnd(e,t){let r=this.runMap.get(t);if(!r||r?.type!=="tool")throw new Error("No tool run to end");let s=r;s.end_time=Date.now(),s.output=e,await this._endTrace(s)}async handleToolError(e,t){let r=this.runMap.get(t);if(!r||r?.type!=="tool")throw new Error("No tool run to end");let s=r;s.end_time=Date.now(),s.error=e.message,await this._endTrace(s)}},_=class extends G{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"langchain_tracer"}),Object.defineProperty(this,"endpoint",{enumerable:!0,configurable:!0,writable:!0,value:(typeof __Process$<"u"?__Process$.env?.LANGCHAIN_ENDPOINT:void 0)||"http://localhost:8000"}),Object.defineProperty(this,"headers",{enumerable:!0,configurable:!0,writable:!0,value:{"Content-Type":"application/json"}}),typeof __Process$<"u"&&__Process$.env?.LANGCHAIN_API_KEY&&(this.headers["x-api-key"]=__Process$.env?.LANGCHAIN_API_KEY)}async persistRun(e){let t;e.type==="llm"?t=`${this.endpoint}/llm-runs`:e.type==="chain"?t=`${this.endpoint}/chain-runs`:t=`${this.endpoint}/tool-runs`;let r=await fetch(t,{method:"POST",headers:this.headers,body:JSON.stringify(e)});r.ok||console.error(`Failed to persist run: ${r.status} ${r.statusText}`)}async persistSession(e){let t=`${this.endpoint}/sessions`,r=await fetch(t,{method:"POST",headers:this.headers,body:JSON.stringify(e)});return r.ok?{id:(await r.json()).id,...e}:(console.error(`Failed to persist session: ${r.status} ${r.statusText}, using default session.`),{id:1,...e})}async loadSession(e){let t=`${this.endpoint}/sessions?name=${e}`;return this._handleSessionResponse(t)}async loadDefaultSession(){let e=`${this.endpoint}/sessions?name=default`;return this._handleSessionResponse(e)}async _handleSessionResponse(e){let t=await fetch(e,{method:"GET",headers:this.headers}),r;if(!t.ok)return console.error(`Failed to load session: ${t.status} ${t.statusText}`),r={id:1,start_time:Date.now()},this.session=r,r;let s=await t.json();return s.length===0?(r={id:1,start_time:Date.now()},this.session=r,r):([r]=s,this.session=r,r)}copy(){if(this.executionOrder===1){let e=new _;return e.session=this.session,e.runMap=new Map(this.runMap),e.executionOrder=this.executionOrder,e}return this}}});async function we(n){let e=new _;return n?await e.loadSession(n):await e.loadDefaultSession(),e}var _e=d(()=>{be()});import{v4 as j}from"/v118/uuid@9.0.0/deno/uuid.mjs";function xe(n){return"name"in n?n:h.fromMethods(n)}var J,P,Y,B,Q,p,Te=d(()=>{C();ye();_e();J=class{setHandler(e){return this.setHandlers([e])}},P=class{constructor(e,t,r,s){Object.defineProperty(this,"runId",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:s})}async handleText(e){await Promise.all(this.handlers.map(async t=>{try{await t.handleText?.(e,this.runId,this._parentRunId)}catch(r){console.error(`Error in handler ${t.constructor.name}, handleText: ${r}`)}}))}},Y=class extends P{async handleLLMNewToken(e){await Promise.all(this.handlers.map(async t=>{if(!t.ignoreLLM)try{await t.handleLLMNewToken?.(e,this.runId,this._parentRunId)}catch(r){console.error(`Error in handler ${t.constructor.name}, handleLLMNewToken: ${r}`)}}))}async handleLLMError(e){await Promise.all(this.handlers.map(async t=>{if(!t.ignoreLLM)try{await t.handleLLMError?.(e,this.runId,this._parentRunId)}catch(r){console.error(`Error in handler ${t.constructor.name}, handleLLMError: ${r}`)}}))}async handleLLMEnd(e){await Promise.all(this.handlers.map(async t=>{if(!t.ignoreLLM)try{await t.handleLLMEnd?.(e,this.runId,this._parentRunId)}catch(r){console.error(`Error in handler ${t.constructor.name}, handleLLMEnd: ${r}`)}}))}},B=class extends P{getChild(){let e=new p(this.runId);return e.setHandlers(this.inheritableHandlers),e}async handleChainError(e){await Promise.all(this.handlers.map(async t=>{if(!t.ignoreChain)try{await t.handleChainError?.(e,this.runId,this._parentRunId)}catch(r){console.error(`Error in handler ${t.constructor.name}, handleChainError: ${r}`)}}))}async handleChainEnd(e){await Promise.all(this.handlers.map(async t=>{if(!t.ignoreChain)try{await t.handleChainEnd?.(e,this.runId,this._parentRunId)}catch(r){console.error(`Error in handler ${t.constructor.name}, handleChainEnd: ${r}`)}}))}async handleAgentAction(e){await Promise.all(this.handlers.map(async t=>{if(!t.ignoreAgent)try{await t.handleAgentAction?.(e,this.runId,this._parentRunId)}catch(r){console.error(`Error in handler ${t.constructor.name}, handleAgentAction: ${r}`)}}))}async handleAgentEnd(e){await Promise.all(this.handlers.map(async t=>{if(!t.ignoreAgent)try{await t.handleAgentEnd?.(e,this.runId,this._parentRunId)}catch(r){console.error(`Error in handler ${t.constructor.name}, handleAgentEnd: ${r}`)}}))}},Q=class extends P{getChild(){let e=new p(this.runId);return e.setHandlers(this.inheritableHandlers),e}async handleToolError(e){await Promise.all(this.handlers.map(async t=>{if(!t.ignoreAgent)try{await t.handleToolError?.(e,this.runId,this._parentRunId)}catch(r){console.error(`Error in handler ${t.constructor.name}, handleToolError: ${r}`)}}))}async handleToolEnd(e){await Promise.all(this.handlers.map(async t=>{if(!t.ignoreAgent)try{await t.handleToolEnd?.(e,this.runId,this._parentRunId)}catch(r){console.error(`Error in handler ${t.constructor.name}, handleToolEnd: ${r}`)}}))}},p=class extends J{constructor(e){super(),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"callback_manager"}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.handlers=[],this.inheritableHandlers=[],this._parentRunId=e}async handleLLMStart(e,t,r=j()){return await Promise.all(this.handlers.map(async s=>{if(!s.ignoreLLM)try{await s.handleLLMStart?.(e,t,r,this._parentRunId)}catch(a){console.error(`Error in handler ${s.constructor.name}, handleLLMStart: ${a}`)}})),new Y(r,this.handlers,this.inheritableHandlers,this._parentRunId)}async handleChainStart(e,t,r=j()){return await Promise.all(this.handlers.map(async s=>{if(!s.ignoreChain)try{await s.handleChainStart?.(e,t,r,this._parentRunId)}catch(a){console.error(`Error in handler ${s.constructor.name}, handleChainStart: ${a}`)}})),new B(r,this.handlers,this.inheritableHandlers,this._parentRunId)}async handleToolStart(e,t,r=j()){return await Promise.all(this.handlers.map(async s=>{if(!s.ignoreAgent)try{await s.handleToolStart?.(e,t,r,this._parentRunId)}catch(a){console.error(`Error in handler ${s.constructor.name}, handleToolStart: ${a}`)}})),new Q(r,this.handlers,this.inheritableHandlers,this._parentRunId)}addHandler(e,t=!0){this.handlers.push(e),t&&this.inheritableHandlers.push(e)}removeHandler(e){this.handlers=this.handlers.filter(t=>t!==e),this.inheritableHandlers=this.inheritableHandlers.filter(t=>t!==e)}setHandlers(e,t=!0){this.handlers=[],this.inheritableHandlers=[];for(let r of e)this.addHandler(r,t)}copy(e=[],t=!0){let r=new p(this._parentRunId);r.setHandlers([...this.handlers].map(s=>s.copy()));for(let s of e)r.addHandler(s.copy(),t);return r}static fromHandlers(e){class t extends h{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:j()}),Object.assign(this,e)}}let r=new this;return r.addHandler(new t),r}static async configure(e,t,r){let s;(e||t)&&(Array.isArray(e)||!e?(s=new p,s.setHandlers(e?.map(xe)??[],!0)):s=e,s=s.copy(Array.isArray(t)?t.map(xe):t?.handlers,!1));let a=typeof __Process$<"u"?__Process$.env?.LANGCHAIN_TRACING!==void 0:!1;if(r?.verbose||a){s||(s=new p);let o=new I;if(r?.verbose&&!s.handlers.some(i=>i.name===o.name)&&s.addHandler(o,!0),a&&!s.handlers.some(i=>i.name==="langchain_tracer")){let i=typeof __Process$<"u"?__Process$.env?.LANGCHAIN_SESSION:void 0;s.addHandler(await we(i),!0)}}return s}}});var R,Ee=d(()=>{U();pe();ge();Te();R=class extends ${constructor(e){super(e)}async generate(e,t,r){let s=[],a=[],o=e.map(l=>fe(l)),u=await(await p.configure(r,this.callbacks,{verbose:this.verbose}))?.handleLLMStart({name:this._llmType()},o);try{for(let l of e){let m=await this._generate(l,t,u);m.llmOutput&&a.push(m.llmOutput),s.push(m.generations)}}catch(l){throw await u?.handleLLMError(l),l}let c={generations:s,llmOutput:a.length?this._combineLLMOutput?.(...a):void 0};return await u?.handleLLMEnd(c),Object.defineProperty(c,ce,{value:u?{runId:u?.runId}:void 0,configurable:!0}),c}_modelType(){return"base_chat_model"}async generatePrompt(e,t,r){let s=e.map(a=>a.toChatMessages());return this.generate(s,t,r)}async call(e,t,r){return(await this.generate([e],t,r)).generations[0][0].message}async callPrompt(e,t,r){let s=e.toChatMessages();return this.call(s,t,r)}}});var me={};ve(me,{ChatOpenAI:()=>V});import{Configuration as Ge,OpenAIApi as Je}from"/v118/openai@3.2.1/deno/openai.mjs";function Ye(n){switch(n){case"system":return"system";case"ai":return"assistant";case"human":return"user";default:throw new Error(`Unknown message type: ${n}`)}}function Be(n,e){switch(n){case"user":return new A(e);case"assistant":return new T(e);case"system":return new N(e);default:return new M(e,n??"unknown")}}var V,K=d(()=>{le();Ee();U();F();V=class extends R{constructor(e,t){super(e??{}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"frequencyPenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"presencePenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"logitBias",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:"gpt-3.5-turbo"}),Object.defineProperty(this,"modelKwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"clientConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let r=e?.openAIApiKey??(typeof __Process$<"u"?__Process$.env?.OPENAI_API_KEY:void 0);if(!r)throw new Error("OpenAI API key not found");if(this.modelName=e?.modelName??this.modelName,this.modelKwargs=e?.modelKwargs??{},this.timeout=e?.timeout,this.temperature=e?.temperature??this.temperature,this.topP=e?.topP??this.topP,this.frequencyPenalty=e?.frequencyPenalty??this.frequencyPenalty,this.presencePenalty=e?.presencePenalty??this.presencePenalty,this.maxTokens=e?.maxTokens,this.n=e?.n??this.n,this.logitBias=e?.logitBias,this.stop=e?.stop,this.streaming=e?.streaming??!1,this.streaming&&this.n>1)throw new Error("Cannot stream results when n > 1");this.clientConfig={apiKey:r,...t}}invocationParams(){return{model:this.modelName,temperature:this.temperature,top_p:this.topP,frequency_penalty:this.frequencyPenalty,presence_penalty:this.presencePenalty,max_tokens:this.maxTokens,n:this.n,logit_bias:this.logitBias,stop:this.stop,stream:this.streaming,...this.modelKwargs}}_identifyingParams(){return{model_name:this.modelName,...this.invocationParams(),...this.clientConfig}}identifyingParams(){return this._identifyingParams()}async _generate(e,t,r){let s=Array.isArray(t)?t:t?.stop,a=Array.isArray(t)?{}:t?.options??{},o={};if(this.stop&&s)throw new Error("Stop found in input and default params");let i=this.invocationParams();i.stop=s??i.stop;let u=e.map(f=>({role:Ye(f._getType()),content:f.text,name:f.name})),c=i.stream?await new Promise((f,H)=>{let g,ee=!1;this.completionWithRetry({...i,messages:u},{...a,responseType:"stream",onmessage:k=>{if(k.data?.trim?.()==="[DONE]")f(g);else{let x=JSON.parse(k.data);g||(g={id:x.id,object:x.object,created:x.created,model:x.model,choices:[]});let y=x.choices[0];if(y!=null){let b=g.choices.find(Pe=>Pe.index===y.index);b||(b={index:y.index,finish_reason:y.finish_reason??void 0},g.choices.push(b)),b.message||(b.message={role:y.delta?.role,content:y.delta?.content??""}),b.message.content+=y.delta?.content??"",r?.handleLLMNewToken(y.delta?.content??"")}}}}).catch(k=>{ee||(ee=!0,H(k))})}):await this.completionWithRetry({...i,messages:u},a),{completion_tokens:l,prompt_tokens:m,total_tokens:X}=c.usage??{};l&&(o.completionTokens=(o.completionTokens??0)+l),m&&(o.promptTokens=(o.promptTokens??0)+m),X&&(o.totalTokens=(o.totalTokens??0)+X);let Z=[];for(let f of c.choices){let H=f.message?.role??void 0,g=f.message?.content??"";Z.push({text:g,message:Be(H,g)})}return{generations:Z,llmOutput:{tokenUsage:o}}}async getNumTokensFromMessages(e){let t=0,r=0,s=0;E(this.modelName)==="gpt-3.5-turbo"?(r=4,s=-1):E(this.modelName).startsWith("gpt-4")&&(r=3,s=1);let a=await Promise.all(e.map(async o=>{let u=await this.getNumTokens(o.text)+r+(o.name?s:0);return t+=u,u}));return{totalCount:t,countPerMessage:a}}async completionWithRetry(e,t){if(!this.client){let r=new Ge({...this.clientConfig,baseOptions:{timeout:this.timeout,adapter:D,...this.clientConfig.baseOptions}});this.client=new Je(r)}return this.caller.call(this.client.createChatCompletion.bind(this.client),e,t).then(r=>r.data)}_llmType(){return"openai"}_combineLLMOutput(...e){return e.reduce((t,r)=>(r&&r.tokenUsage&&(t.tokenUsage.completionTokens+=r.tokenUsage.completionTokens??0,t.tokenUsage.promptTokens+=r.tokenUsage.promptTokens??0,t.tokenUsage.totalTokens+=r.tokenUsage.totalTokens??0),t),{tokenUsage:{completionTokens:0,promptTokens:0,totalTokens:0}})}}});K();export{V as ChatOpenAI};
//# sourceMappingURL=openai.js.map