/* esm.sh - esbuild bundle(langchain@0.0.95/output_parsers) deno production */
import __Process$ from "https://deno.land/std@0.177.1/node/process.ts";var Rr=Object.defineProperty;var p=(i,e)=>()=>(i&&(e=i(i=0)),e);var R=(i,e)=>{for(var t in e)Rr(i,t,{get:e[t],enumerable:!0})};import $r from"/v126/decamelize@5.0.1/deno/decamelize.mjs";import kn from"/v126/camelcase@6.3.0/deno/camelcase.mjs";function kt(i,e){return e?.[i]||$r(i)}function Mt(i,e,t){let r={};for(let n in i)Object.hasOwn(i,n)&&(r[e(n,t)]=i[n]);return r}var Lt=p(()=>{});function Nt(i){return Array.isArray(i)?[...i]:{...i}}function Kr(i,e){let t=Nt(i);for(let[r,n]of Object.entries(e)){let[a,...s]=r.split(".").reverse(),o=t;for(let u of s.reverse()){if(o[u]===void 0)break;o[u]=Nt(o[u]),o=o[u]}o[a]!==void 0&&(o[a]={lc:1,type:"secret",id:[n]})}return t}var g,z=p(()=>{Lt();g=class{get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}constructor(e,...t){Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.lc_kwargs=e||{}}toJSON(){if(!this.lc_serializable)return this.toJSONNotImplemented();if(this.lc_kwargs instanceof g||typeof this.lc_kwargs!="object"||Array.isArray(this.lc_kwargs))return this.toJSONNotImplemented();let e={},t={},r=Object.keys(this.lc_kwargs).reduce((n,a)=>(n[a]=a in this?this[a]:this.lc_kwargs[a],n),{});for(let n=Object.getPrototypeOf(this);n;n=Object.getPrototypeOf(n))Object.assign(e,Reflect.get(n,"lc_aliases",this)),Object.assign(t,Reflect.get(n,"lc_secrets",this)),Object.assign(r,Reflect.get(n,"lc_attributes",this));return{lc:1,type:"constructor",id:[...this.lc_namespace,this.constructor.name],kwargs:Mt(this.lc_secrets?Kr(r,t):r,kt,e)}}toJSONNotImplemented(){return{lc:1,type:"not_implemented",id:[...this.lc_namespace,this.constructor.name]}}}});var Se,W,S,G,Q,le,Y,Z=p(()=>{z();Se="__run",W=class{constructor(e,t){Object.defineProperty(this,"text",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"additional_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:{}}),this.text=e,this.additional_kwargs=t||{}}toJSON(){return{type:this._getType(),data:{content:this.text,role:"role"in this?this.role:void 0,name:this.name,additional_kwargs:this.additional_kwargs}}}},S=class extends W{_getType(){return"human"}},G=class extends W{_getType(){return"ai"}},Q=class extends W{_getType(){return"system"}},le=class extends W{constructor(e,t){super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=t}_getType(){return"generic"}},Y=class extends g{}});import*as $t from"/v126/uuid@9.0.0/deno/uuid.mjs";var rt,k,nt=p(()=>{z();rt=class{},k=class extends rt{get lc_namespace(){return["langchain","callbacks",this.name]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}constructor(e){super(),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ignoreLLM",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreChain",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreAgent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"awaitHandlers",{enumerable:!0,configurable:!0,writable:!0,value:typeof __Process$<"u"?__Process$.env?.LANGCHAIN_CALLBACKS_BACKGROUND!=="true":!0}),this.lc_kwargs=e||{},e&&(this.ignoreLLM=e.ignoreLLM??this.ignoreLLM,this.ignoreChain=e.ignoreChain??this.ignoreChain,this.ignoreAgent=e.ignoreAgent??this.ignoreAgent)}copy(){return new this.constructor(this)}toJSON(){return g.prototype.toJSON.call(this)}toJSONNotImplemented(){return g.prototype.toJSONNotImplemented.call(this)}static fromMethods(e){class t extends k{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:$t.v4()}),Object.assign(this,e)}}return new t}}});var $,ke=p(()=>{nt();$=class extends k{constructor(e){super(...arguments),Object.defineProperty(this,"runMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map})}copy(){return this}_addChildRun(e,t){e.child_runs.push(t)}_startTrace(e){if(e.parent_run_id!==void 0){let t=this.runMap.get(e.parent_run_id);t&&this._addChildRun(t,e)}this.runMap.set(e.id,e)}async _endTrace(e){let t=e.parent_run_id!==void 0&&this.runMap.get(e.parent_run_id);t?t.child_execution_order=Math.max(t.child_execution_order,e.child_execution_order):await this.persistRun(e),this.runMap.delete(e.id)}_getExecutionOrder(e){let t=e!==void 0&&this.runMap.get(e);return t?t.child_execution_order+1:1}async handleLLMStart(e,t,r,n,a,s){let o=this._getExecutionOrder(n),u=Date.now(),c={id:r,name:e.id[e.id.length-1],parent_run_id:n,start_time:u,serialized:e,events:[{name:"start",time:u}],inputs:{prompts:t},execution_order:o,child_runs:[],child_execution_order:o,run_type:"llm",extra:a??{},tags:s||[]};this._startTrace(c),await this.onLLMStart?.(c)}async handleChatModelStart(e,t,r,n,a,s){let o=this._getExecutionOrder(n),u=Date.now(),c={id:r,name:e.id[e.id.length-1],parent_run_id:n,start_time:u,serialized:e,events:[{name:"start",time:u}],inputs:{messages:t},execution_order:o,child_runs:[],child_execution_order:o,run_type:"llm",extra:a??{},tags:s||[]};this._startTrace(c),await this.onLLMStart?.(c)}async handleLLMEnd(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="llm")throw new Error("No LLM run to end.");r.end_time=Date.now(),r.outputs=e,r.events.push({name:"end",time:r.end_time}),await this.onLLMEnd?.(r),await this._endTrace(r)}async handleLLMError(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="llm")throw new Error("No LLM run to end.");r.end_time=Date.now(),r.error=e.message,r.events.push({name:"error",time:r.end_time}),await this.onLLMError?.(r),await this._endTrace(r)}async handleChainStart(e,t,r,n,a){let s=this._getExecutionOrder(n),o=Date.now(),u={id:r,name:e.id[e.id.length-1],parent_run_id:n,start_time:o,serialized:e,events:[{name:"start",time:o}],inputs:t,execution_order:s,child_execution_order:s,run_type:"chain",child_runs:[],extra:{},tags:a||[]};this._startTrace(u),await this.onChainStart?.(u)}async handleChainEnd(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="chain")throw new Error("No chain run to end.");r.end_time=Date.now(),r.outputs=e,r.events.push({name:"end",time:r.end_time}),await this.onChainEnd?.(r),await this._endTrace(r)}async handleChainError(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="chain")throw new Error("No chain run to end.");r.end_time=Date.now(),r.error=e.message,r.events.push({name:"error",time:r.end_time}),await this.onChainError?.(r),await this._endTrace(r)}async handleToolStart(e,t,r,n,a){let s=this._getExecutionOrder(n),o=Date.now(),u={id:r,name:e.id[e.id.length-1],parent_run_id:n,start_time:o,serialized:e,events:[{name:"start",time:o}],inputs:{input:t},execution_order:s,child_execution_order:s,run_type:"tool",child_runs:[],extra:{},tags:a||[]};this._startTrace(u),await this.onToolStart?.(u)}async handleToolEnd(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="tool")throw new Error("No tool run to end");r.end_time=Date.now(),r.outputs={output:e},r.events.push({name:"end",time:r.end_time}),await this.onToolEnd?.(r),await this._endTrace(r)}async handleToolError(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="tool")throw new Error("No tool run to end");r.end_time=Date.now(),r.error=e.message,r.events.push({name:"error",time:r.end_time}),await this.onToolError?.(r),await this._endTrace(r)}async handleAgentAction(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="chain")return;let n=r;n.actions=n.actions||[],n.actions.push(e),n.events.push({name:"agent_action",time:Date.now(),kwargs:{action:e}}),await this.onAgentAction?.(r)}async handleText(e,t){let r=this.runMap.get(t);!r||r?.run_type!=="chain"||(r.events.push({name:"text",time:Date.now(),kwargs:{text:e}}),await this.onText?.(r))}}});import Kt from"/v126/ansi-styles@5.2.0/deno/ansi-styles.mjs";function T(i,e){return`${i.open}${e}${i.close}`}function K(i,e){try{return JSON.stringify(i,null,2)}catch{return e}}function X(i){if(!i.end_time)return"";let e=i.end_time-i.start_time;return e<1e3?`${e}ms`:`${(e/1e3).toFixed(2)}s`}var C,ce,Vt=p(()=>{ke();({color:C}=Kt),ce=class extends ${constructor(){super(...arguments),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"console_callback_handler"})}persistRun(e){return Promise.resolve()}getParents(e){let t=[],r=e;for(;r.parent_run_id;){let n=this.runMap.get(r.parent_run_id);if(n)t.push(n),r=n;else break}return t}getBreadcrumbs(e){let r=[...this.getParents(e).reverse(),e].map((n,a,s)=>{let o=`${n.execution_order}:${n.run_type}:${n.name}`;return a===s.length-1?T(Kt.bold,o):o}).join(" > ");return T(C.grey,r)}onChainStart(e){let t=this.getBreadcrumbs(e);console.log(`${T(C.green,"[chain/start]")} [${t}] Entering Chain run with input: ${K(e.inputs,"[inputs]")}`)}onChainEnd(e){let t=this.getBreadcrumbs(e);console.log(`${T(C.cyan,"[chain/end]")} [${t}] [${X(e)}] Exiting Chain run with output: ${K(e.outputs,"[outputs]")}`)}onChainError(e){let t=this.getBreadcrumbs(e);console.log(`${T(C.red,"[chain/error]")} [${t}] [${X(e)}] Chain run errored with error: ${K(e.error,"[error]")}`)}onLLMStart(e){let t=this.getBreadcrumbs(e),r="prompts"in e.inputs?{prompts:e.inputs.prompts.map(n=>n.trim())}:e.inputs;console.log(`${T(C.green,"[llm/start]")} [${t}] Entering LLM run with input: ${K(r,"[inputs]")}`)}onLLMEnd(e){let t=this.getBreadcrumbs(e);console.log(`${T(C.cyan,"[llm/end]")} [${t}] [${X(e)}] Exiting LLM run with output: ${K(e.outputs,"[response]")}`)}onLLMError(e){let t=this.getBreadcrumbs(e);console.log(`${T(C.red,"[llm/error]")} [${t}] [${X(e)}] LLM run errored with error: ${K(e.error,"[error]")}`)}onToolStart(e){let t=this.getBreadcrumbs(e);console.log(`${T(C.green,"[tool/start]")} [${t}] Entering Tool run with input: "${e.inputs.input?.trim()}"`)}onToolEnd(e){let t=this.getBreadcrumbs(e);console.log(`${T(C.cyan,"[tool/end]")} [${t}] [${X(e)}] Exiting Tool run with output: "${e.outputs?.output?.trim()}"`)}onToolError(e){let t=this.getBreadcrumbs(e);console.log(`${T(C.red,"[tool/error]")} [${t}] [${X(e)}] Tool run errored with error: ${K(e.error,"[error]")}`)}onAgentAction(e){let t=e,r=this.getBreadcrumbs(e);console.log(`${T(C.blue,"[agent/action]")} [${r}] Agent selected action: ${K(t.actions[t.actions.length-1],"[action]")}`)}}});async function Dt(){return it===void 0&&(it={library:"langchain-js",runtime:qr()}),it}function _(i){try{return typeof __Process$<"u"?__Process$.env?.[i]:void 0}catch{return}}var Vr,zr,Dr,zt,at,qr,it,pe=p(()=>{Vr=()=>typeof document<"u"&&typeof window.document<"u",zr=()=>typeof globalThis=="object"&&globalThis.constructor&&globalThis.constructor.name==="DedicatedWorkerGlobalScope",Dr=()=>typeof document<"u"&&window.name==="nodejs"||typeof navigator<"u"&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom")),zt=()=>typeof Deno<"u",at=()=>typeof __Process$<"u"&&typeof __Process$.versions<"u"&&typeof __Process$.versions.node<"u"&&!zt(),qr=()=>{let i;return Vr()?i="browser":at()?i="node":zr()?i="webworker":Dr()?i="jsdom":zt()?i="deno":i="other",i}});import{LangChainPlusClient as Hr}from"/v126/langchainplus-sdk@0.0.11/deno/langchainplus-sdk.mjs";var he,st=p(()=>{pe();ke();he=class extends ${constructor(e={}){super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"langchain_tracer"}),Object.defineProperty(this,"sessionName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let{exampleId:t,sessionName:r,client:n}=e;this.sessionName=r??_("LANGCHAIN_SESSION"),this.exampleId=t,this.client=n??new Hr({})}async _convertToCreate(e,t=void 0){return{...e,extra:{...e.extra,runtime:await Dt()},child_runs:void 0,session_name:this.sessionName,reference_example_id:e.parent_run_id?void 0:t}}async persistRun(e){}async _persistRunSingle(e){let t=await this._convertToCreate(e,this.exampleId);await this.client.createRun(t)}async _updateRunSingle(e){let t={end_time:e.end_time,error:e.error,outputs:e.outputs,events:e.events};await this.client.updateRun(e.id,t)}async onLLMStart(e){await this._persistRunSingle(e)}async onLLMEnd(e){await this._updateRunSingle(e)}async onLLMError(e){await this._updateRunSingle(e)}async onChainStart(e){await this._persistRunSingle(e)}async onChainEnd(e){await this._updateRunSingle(e)}async onChainError(e){await this._updateRunSingle(e)}async onToolStart(e){await this._persistRunSingle(e)}async onToolEnd(e){await this._updateRunSingle(e)}async onToolError(e){await this._updateRunSingle(e)}}});function Me(i,e="Human",t="AI"){let r=[];for(let n of i){let a;if(n._getType()==="human")a=e;else if(n._getType()==="ai")a=t;else if(n._getType()==="system")a="System";else if(n._getType()==="generic")a=n.role;else throw new Error(`Got unsupported message type: ${n}`);r.push(`${a}: ${n.text}`)}return r.join(`
`)}var ot=p(()=>{});var Le,qt=p(()=>{ot();pe();ke();Le=class extends ${constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"langchain_tracer"}),Object.defineProperty(this,"endpoint",{enumerable:!0,configurable:!0,writable:!0,value:_("LANGCHAIN_ENDPOINT")||"http://localhost:1984"}),Object.defineProperty(this,"headers",{enumerable:!0,configurable:!0,writable:!0,value:{"Content-Type":"application/json"}}),Object.defineProperty(this,"session",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let e=_("LANGCHAIN_API_KEY");e&&(this.headers["x-api-key"]=e)}async newSession(e){let t={start_time:Date.now(),name:e},r=await this.persistSession(t);return this.session=r,r}async loadSession(e){let t=`${this.endpoint}/sessions?name=${e}`;return this._handleSessionResponse(t)}async loadDefaultSession(){let e=`${this.endpoint}/sessions?name=default`;return this._handleSessionResponse(e)}async convertV2RunToRun(e){let t=this.session??await this.loadDefaultSession(),r=e.serialized,n;if(e.run_type==="llm"){let a=e.inputs.prompts?e.inputs.prompts:e.inputs.messages.map(o=>Me(o));n={uuid:e.id,start_time:e.start_time,end_time:e.end_time,execution_order:e.execution_order,child_execution_order:e.child_execution_order,serialized:r,type:e.run_type,session_id:t.id,prompts:a,response:e.outputs}}else if(e.run_type==="chain"){let a=await Promise.all(e.child_runs.map(o=>this.convertV2RunToRun(o)));n={uuid:e.id,start_time:e.start_time,end_time:e.end_time,execution_order:e.execution_order,child_execution_order:e.child_execution_order,serialized:r,type:e.run_type,session_id:t.id,inputs:e.inputs,outputs:e.outputs,child_llm_runs:a.filter(o=>o.type==="llm"),child_chain_runs:a.filter(o=>o.type==="chain"),child_tool_runs:a.filter(o=>o.type==="tool")}}else if(e.run_type==="tool"){let a=await Promise.all(e.child_runs.map(o=>this.convertV2RunToRun(o)));n={uuid:e.id,start_time:e.start_time,end_time:e.end_time,execution_order:e.execution_order,child_execution_order:e.child_execution_order,serialized:r,type:e.run_type,session_id:t.id,tool_input:e.inputs.input,output:e.outputs?.output,action:JSON.stringify(r),child_llm_runs:a.filter(o=>o.type==="llm"),child_chain_runs:a.filter(o=>o.type==="chain"),child_tool_runs:a.filter(o=>o.type==="tool")}}else throw new Error(`Unknown run type: ${e.run_type}`);return n}async persistRun(e){let t,r;e.run_type!==void 0?r=await this.convertV2RunToRun(e):r=e,r.type==="llm"?t=`${this.endpoint}/llm-runs`:r.type==="chain"?t=`${this.endpoint}/chain-runs`:t=`${this.endpoint}/tool-runs`;let n=await fetch(t,{method:"POST",headers:this.headers,body:JSON.stringify(r)});n.ok||console.error(`Failed to persist run: ${n.status} ${n.statusText}`)}async persistSession(e){let t=`${this.endpoint}/sessions`,r=await fetch(t,{method:"POST",headers:this.headers,body:JSON.stringify(e)});return r.ok?{id:(await r.json()).id,...e}:(console.error(`Failed to persist session: ${r.status} ${r.statusText}, using default session.`),{id:1,...e})}async _handleSessionResponse(e){let t=await fetch(e,{method:"GET",headers:this.headers}),r;if(!t.ok)return console.error(`Failed to load session: ${t.status} ${t.statusText}`),r={id:1,start_time:Date.now()},this.session=r,r;let n=await t.json();return n.length===0?(r={id:1,start_time:Date.now()},this.session=r,r):([r]=n,this.session=r,r)}}});async function Ht(i){let e=new Le;return i?await e.loadSession(i):await e.loadDefaultSession(),e}async function Ft(){return new he}var Ut=p(()=>{st();qt()});import ut from"/v126/p-queue@6.6.2/deno/p-queue.mjs";function Fr(){let i="default"in ut?ut.default:ut;return new i({autoStart:!0,concurrency:1})}async function x(i,e){e===!0?await i():(typeof lt>"u"&&(lt=Fr()),lt.add(i))}var lt,Bt=p(()=>{});import{v4 as me}from"/v126/uuid@9.0.0/deno/uuid.mjs";function Jt(i){return"name"in i?i:k.fromMethods(i)}var ct,de,Ne,pt,ht,E,mt=p(()=>{nt();Vt();Ut();ot();pe();st();Bt();ct=class{setHandler(e){return this.setHandlers([e])}},de=class{constructor(e,t,r,n,a,s){Object.defineProperty(this,"runId",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:s})}async handleText(e){await Promise.all(this.handlers.map(t=>x(async()=>{try{await t.handleText?.(e,this.runId,this._parentRunId)}catch(r){console.error(`Error in handler ${t.constructor.name}, handleText: ${r}`)}},t.awaitHandlers)))}},Ne=class extends de{async handleLLMNewToken(e){await Promise.all(this.handlers.map(t=>x(async()=>{if(!t.ignoreLLM)try{await t.handleLLMNewToken?.(e,this.runId,this._parentRunId)}catch(r){console.error(`Error in handler ${t.constructor.name}, handleLLMNewToken: ${r}`)}},t.awaitHandlers)))}async handleLLMError(e){await Promise.all(this.handlers.map(t=>x(async()=>{if(!t.ignoreLLM)try{await t.handleLLMError?.(e,this.runId,this._parentRunId)}catch(r){console.error(`Error in handler ${t.constructor.name}, handleLLMError: ${r}`)}},t.awaitHandlers)))}async handleLLMEnd(e){await Promise.all(this.handlers.map(t=>x(async()=>{if(!t.ignoreLLM)try{await t.handleLLMEnd?.(e,this.runId,this._parentRunId)}catch(r){console.error(`Error in handler ${t.constructor.name}, handleLLMEnd: ${r}`)}},t.awaitHandlers)))}},pt=class extends de{getChild(e){let t=new E(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),e&&t.addTags([e],!1),t}async handleChainError(e){await Promise.all(this.handlers.map(t=>x(async()=>{if(!t.ignoreChain)try{await t.handleChainError?.(e,this.runId,this._parentRunId)}catch(r){console.error(`Error in handler ${t.constructor.name}, handleChainError: ${r}`)}},t.awaitHandlers)))}async handleChainEnd(e){await Promise.all(this.handlers.map(t=>x(async()=>{if(!t.ignoreChain)try{await t.handleChainEnd?.(e,this.runId,this._parentRunId)}catch(r){console.error(`Error in handler ${t.constructor.name}, handleChainEnd: ${r}`)}},t.awaitHandlers)))}async handleAgentAction(e){await Promise.all(this.handlers.map(t=>x(async()=>{if(!t.ignoreAgent)try{await t.handleAgentAction?.(e,this.runId,this._parentRunId)}catch(r){console.error(`Error in handler ${t.constructor.name}, handleAgentAction: ${r}`)}},t.awaitHandlers)))}async handleAgentEnd(e){await Promise.all(this.handlers.map(t=>x(async()=>{if(!t.ignoreAgent)try{await t.handleAgentEnd?.(e,this.runId,this._parentRunId)}catch(r){console.error(`Error in handler ${t.constructor.name}, handleAgentEnd: ${r}`)}},t.awaitHandlers)))}},ht=class extends de{getChild(e){let t=new E(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),e&&t.addTags([e],!1),t}async handleToolError(e){await Promise.all(this.handlers.map(t=>x(async()=>{if(!t.ignoreAgent)try{await t.handleToolError?.(e,this.runId,this._parentRunId)}catch(r){console.error(`Error in handler ${t.constructor.name}, handleToolError: ${r}`)}},t.awaitHandlers)))}async handleToolEnd(e){await Promise.all(this.handlers.map(t=>x(async()=>{if(!t.ignoreAgent)try{await t.handleToolEnd?.(e,this.runId,this._parentRunId)}catch(r){console.error(`Error in handler ${t.constructor.name}, handleToolEnd: ${r}`)}},t.awaitHandlers)))}},E=class extends ct{constructor(e){super(),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"callback_manager"}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.handlers=[],this.inheritableHandlers=[],this._parentRunId=e}async handleLLMStart(e,t,r=me(),n=void 0,a=void 0){return await Promise.all(this.handlers.map(s=>x(async()=>{if(!s.ignoreLLM)try{await s.handleLLMStart?.(e,t,r,this._parentRunId,a,this.tags)}catch(o){console.error(`Error in handler ${s.constructor.name}, handleLLMStart: ${o}`)}},s.awaitHandlers))),new Ne(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this._parentRunId)}async handleChatModelStart(e,t,r=me(),n=void 0,a=void 0){let s;return await Promise.all(this.handlers.map(o=>x(async()=>{if(!o.ignoreLLM)try{o.handleChatModelStart?await o.handleChatModelStart?.(e,t,r,this._parentRunId,a,this.tags):o.handleLLMStart&&(s=t.map(u=>Me(u)),await o.handleLLMStart?.(e,s,r,this._parentRunId,a,this.tags))}catch(u){console.error(`Error in handler ${o.constructor.name}, handleLLMStart: ${u}`)}},o.awaitHandlers))),new Ne(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this._parentRunId)}async handleChainStart(e,t,r=me()){return await Promise.all(this.handlers.map(n=>x(async()=>{if(!n.ignoreChain)try{await n.handleChainStart?.(e,t,r,this._parentRunId,this.tags)}catch(a){console.error(`Error in handler ${n.constructor.name}, handleChainStart: ${a}`)}},n.awaitHandlers))),new pt(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this._parentRunId)}async handleToolStart(e,t,r=me()){return await Promise.all(this.handlers.map(n=>x(async()=>{if(!n.ignoreAgent)try{await n.handleToolStart?.(e,t,r,this._parentRunId,this.tags)}catch(a){console.error(`Error in handler ${n.constructor.name}, handleToolStart: ${a}`)}},n.awaitHandlers))),new ht(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this._parentRunId)}addHandler(e,t=!0){this.handlers.push(e),t&&this.inheritableHandlers.push(e)}removeHandler(e){this.handlers=this.handlers.filter(t=>t!==e),this.inheritableHandlers=this.inheritableHandlers.filter(t=>t!==e)}setHandlers(e,t=!0){this.handlers=[],this.inheritableHandlers=[];for(let r of e)this.addHandler(r,t)}addTags(e,t=!0){this.removeTags(e),this.tags.push(...e),t&&this.inheritableTags.push(...e)}removeTags(e){this.tags=this.tags.filter(t=>!e.includes(t)),this.inheritableTags=this.inheritableTags.filter(t=>!e.includes(t))}copy(e=[],t=!0){let r=new E(this._parentRunId);for(let n of this.handlers){let a=this.inheritableHandlers.includes(n);r.addHandler(n,a)}for(let n of this.tags){let a=this.inheritableTags.includes(n);r.addTags([n],a)}for(let n of e)r.handlers.filter(a=>a.name==="console_callback_handler").some(a=>a.name===n.name)||r.addHandler(n,t);return r}static fromHandlers(e){class t extends k{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:me()}),Object.assign(this,e)}}let r=new this;return r.addHandler(new t),r}static async configure(e,t,r,n,a){let s;(e||t)&&(Array.isArray(e)||!e?(s=new E,s.setHandlers(e?.map(Jt)??[],!0)):s=e,s=s.copy(Array.isArray(t)?t.map(Jt):t?.handlers,!1));let o=_("LANGCHAIN_VERBOSE")||a?.verbose,u=_("LANGCHAIN_TRACING_V2")??!1,c=u||(_("LANGCHAIN_TRACING")??!1);if(o||c){if(s||(s=new E),o&&!s.handlers.some(l=>l.name===ce.prototype.name)){let l=new ce;s.addHandler(l,!0)}if(c&&!s.handlers.some(l=>l.name==="langchain_tracer"))if(u)s.addHandler(await Ft(),!0);else{let l=_("LANGCHAIN_SESSION");s.addHandler(await Ht(l),!0)}}return(r||n)&&s&&(s.addTags(r??[]),s.addTags(n??[],!1)),s}}});import Ur from"/v126/p-retry@4.6.2/deno/p-retry.mjs";import dt from"/v126/p-queue@6.6.2/deno/p-queue.mjs";var Br,ee,ft=p(()=>{Br=[400,401,403,404,405,406,407,408,409],ee=class{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6;let t="default"in dt?dt.default:dt;this.queue=new t({concurrency:this.maxConcurrency})}call(e,...t){return this.queue.add(()=>Ur(()=>e(...t).catch(r=>{throw r instanceof Error?r:new Error(r)}),{onFailedAttempt(r){if(r.message.startsWith("Cancel")||r.message.startsWith("TimeoutError")||r.message.startsWith("AbortError")||r?.code==="ECONNABORTED")throw r;let n=r?.response?.status;if(n&&Br.includes(+n))throw r},retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(e,t,...r){return e.signal?Promise.race([this.call(t,...r),new Promise((n,a)=>{e.signal?.addEventListener("abort",()=>{a(new Error("AbortError"))})})]):this.call(t,...r)}fetch(...e){return this.call(()=>fetch(...e).then(t=>t.ok?t:Promise.reject(t)))}}});import{Tiktoken as Jr,getEncodingNameForModel as Wr}from"/v126/js-tiktoken@1.0.6/deno/lite.js";async function Qr(i,e){return i in Re||(Re[i]=Gr.fetch(`https://tiktoken.pages.dev/js/${i}.json`,{signal:e?.signal}).then(t=>t.json()).catch(t=>{throw delete Re[i],t})),new Jr(await Re[i],e?.extendedSpecialTokens)}async function bt(i,e){return Qr(Wr(i),e)}var Re,Gr,yt=p(()=>{ft();Re={},Gr=new ee({})});var fe,$e=p(()=>{yt();fe=i=>i.startsWith("gpt-3.5-turbo-")?"gpt-3.5-turbo":i.startsWith("gpt-4-32k-")?"gpt-4-32k":i.startsWith("gpt-4-")?"gpt-4":i});async function Wt(i,e){let t=i.getReader();for(;;){let r=await t.read();if(r.done){e(new Uint8Array,!0);break}e(r.value)}}function Gt(i){let e,t,r,n=!1;return function(s,o){if(o){i(s,0,!0);return}e===void 0?(e=s,t=0,r=-1):e=Yr(e,s);let u=e.length,c=0;for(;t<u;){n&&(e[t]===10&&(c=++t),n=!1);let l=-1;for(;t<u&&l===-1;++t)switch(e[t]){case 58:r===-1&&(r=t-c);break;case 13:n=!0;case 10:l=t;break}if(l===-1)break;i(e.subarray(c,l),r),c=t,r=-1}c===u?e=void 0:c!==0&&(e=e.subarray(c),t-=c)}}function Qt(i,e,t){let r=gt(),n=new TextDecoder;return function(s,o,u){if(u){Zr(r)||(i?.(r),r=gt());return}if(s.length===0)i?.(r),r=gt();else if(o>0){let c=n.decode(s.subarray(0,o)),l=o+(s[o+1]===32?2:1),h=n.decode(s.subarray(l));switch(c){case"data":r.data=r.data?r.data+`
`+h:h;break;case"event":r.event=h;break;case"id":e?.(r.id=h);break;case"retry":{let m=parseInt(h,10);Number.isNaN(m)||t?.(r.retry=m);break}}}}}function Yr(i,e){let t=new Uint8Array(i.length+e.length);return t.set(i),t.set(e,i.length),t}function gt(){return{data:"",event:"",id:"",retry:void 0}}function Zr(i){return i.data===""&&i.event===""&&i.id===""&&i.retry===void 0}var Ke,Yt=p(()=>{Ke="text/event-stream"});import Ve from"/v126/axios@1.4.0/deno/axios.mjs";function Xr(i){try{return JSON.stringify(i)}catch{return i}}function en(i,e,t){let{validateStatus:r}=t.config;!t.status||!r||r(t.status)?i(t):e(ze(`Request failed with status code ${t.status} and body ${typeof t.data=="string"?t.data:Xr(t.data)}`,t.config,null,t.request,t))}function tn(i){return/^([a-z][a-z\d+\-.]*:)?\/\//i.test(i)}function rn(i,e){return e?i.replace(/\/+$/,"")+"/"+e.replace(/^\/+/,""):i}function Zt(i){return encodeURIComponent(i).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}function nn(i,e,t){if(!e)return i;var r;if(t)r=t(e);else if(ln(e))r=e.toString();else{var n=[];Xt(e,function(o,u){o===null||typeof o>"u"||(er(o)?u=`${u}[]`:o=[o],Xt(o,function(l){un(l)?l=l.toISOString():on(l)&&(l=JSON.stringify(l)),n.push(`${Zt(u)}=${Zt(l)}`)}))}),r=n.join("&")}if(r){var a=i.indexOf("#");a!==-1&&(i=i.slice(0,a)),i+=(i.indexOf("?")===-1?"?":"&")+r}return i}function an(i,e){return i&&!tn(e)?rn(i,e):e}function sn(i){return typeof i>"u"}function on(i){return i!==null&&typeof i=="object"}function un(i){return toString.call(i)==="[object Date]"}function ln(i){return toString.call(i)==="[object URLSearchParams]"}function er(i){return Array.isArray(i)}function Xt(i,e){if(!(i===null||typeof i>"u"))if(typeof i!="object"&&(i=[i]),er(i))for(var t=0,r=i.length;t<r;t++)e.call(null,i[t],t,i);else for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&e.call(null,i[n],n,i)}function cn(i){return toString.call(i)==="[object FormData]"}function pn(){return typeof navigator<"u"&&(navigator.product==="ReactNative"||navigator.product==="NativeScript"||navigator.product==="NS")?!1:typeof document<"u"&&typeof document<"u"}async function De(i){let e=mn(i),t=await hn(e,i);return new Promise((r,n)=>{t instanceof Error?n(t):Object.prototype.toString.call(i.settle)==="[object Function]"?i.settle(r,n,t):en(r,n,t)})}async function hn(i,e){let t;try{t=await fetch(i)}catch(a){return a&&a.name==="AbortError"?ze("Request aborted",e,"ECONNABORTED",i):a&&a.name==="TimeoutError"?ze("Request timeout",e,"ECONNABORTED",i):ze("Network Error",e,"ERR_NETWORK",i)}let r={};t.headers.forEach((a,s)=>{r[s]=a});let n={ok:t.ok,status:t.status,statusText:t.statusText,headers:r,config:e,request:i};if(t.status>=200&&t.status!==204)if(e.responseType==="stream"){let a=t.headers.get("content-type");if(!a?.startsWith(Ke)){if(t.status>=400)return a?.startsWith("application/json")?(n.data=await t.json(),n):(n.data=await t.text(),n);throw new Error(`Expected content-type to be ${Ke}, Actual: ${a}`)}await Wt(t.body,Gt(Qt(e.onmessage)))}else switch(e.responseType){case"arraybuffer":n.data=await t.arrayBuffer();break;case"blob":n.data=await t.blob();break;case"json":n.data=await t.json();break;case"formData":n.data=await t.formData();break;default:n.data=await t.text();break}return n}function mn(i){let e=new Headers(i.headers);if(i.auth){let s=i.auth.username||"",o=i.auth.password?decodeURI(encodeURIComponent(i.auth.password)):"";e.set("Authorization",`Basic ${btoa(`${s}:${o}`)}`)}let t=i.method.toUpperCase(),r={headers:e,method:t};t!=="GET"&&t!=="HEAD"&&(r.body=i.data,cn(r.body)&&pn()&&e.delete("Content-Type")),typeof r.body=="string"&&(r.body=new TextEncoder().encode(r.body)),i.mode&&(r.mode=i.mode),i.cache&&(r.cache=i.cache),i.integrity&&(r.integrity=i.integrity),i.redirect&&(r.redirect=i.redirect),i.referrer&&(r.referrer=i.referrer),i.timeout&&i.timeout>0&&(r.signal=AbortSignal.timeout(i.timeout)),i.signal&&(r.signal=i.signal),sn(i.withCredentials)||(r.credentials=i.withCredentials?"include":"omit"),i.responseType==="stream"&&r.headers.set("Accept",Ke);let n=an(i.baseURL,i.url),a=nn(n,i.params,i.paramsSerializer);return new Request(a,r)}function ze(i,e,t,r,n){if(Ve.AxiosError&&typeof Ve.AxiosError=="function")return new Ve.AxiosError(i,Ve.AxiosError[t],e,r,n);let a=new Error(i);return dn(a,e,t,r,n)}function dn(i,e,t,r,n){return i.config=e,t&&(i.code=t),i.request=r,i.response=n,i.isAxiosError=!0,i.toJSON=function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:this.config,code:this.code,status:this.response&&this.response.status?this.response.status:null}},i}var tr=p(()=>{Yt()});var qe,rr=p(()=>{Z();He();mt();qe=class extends te{constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","chat_models",this._llmType()]})}async generate(e,t,r){let n=[],a=[],s;Array.isArray(t)?s={stop:t}:t?.timeout&&!t.signal?s={...t,signal:AbortSignal.timeout(t.timeout)}:s=t??{};let o=await E.configure(r,this.callbacks,s.tags,this.tags,{verbose:this.verbose}),u={options:s,invocation_params:this?.invocationParams()},c=await o?.handleChatModelStart(this.toJSON(),e,void 0,void 0,u);try{let h=await Promise.all(e.map(m=>this._generate(m,s,c)));for(let m of h)m.llmOutput&&a.push(m.llmOutput),n.push(m.generations)}catch(h){throw await c?.handleLLMError(h),h}let l={generations:n,llmOutput:a.length?this._combineLLMOutput?.(...a):void 0};return await c?.handleLLMEnd(l),Object.defineProperty(l,Se,{value:c?{runId:c?.runId}:void 0,configurable:!0}),l}invocationParams(){return{}}_modelType(){return"base_chat_model"}async generatePrompt(e,t,r){let n=e.map(a=>a.toChatMessages());return this.generate(n,t,r)}async call(e,t,r){return(await this.generate([e],t,r)).generations[0][0].message}async callPrompt(e,t,r){let n=e.toChatMessages();return this.call(n,t,r)}async predictMessages(e,t,r){return this.call(e,t,r)}async predict(e,t,r){let n=new S(e);return(await this.call([n],t,r)).text}}});var nr,ir=p(()=>{nr=async(i,e,t,r,n,a,s,o,u)=>(await i.call(fetch,"https://api.promptlayer.com/track-request",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({function_name:e,provider:"langchain",args:t,kwargs:r,tags:n,request_response:a,request_start_time:Math.floor(s/1e3),request_end_time:Math.floor(o/1e3),api_key:u})})).json()});import{zodToJsonSchema as fn}from"/v126/zod-to-json-schema@3.21.1/deno/zod-to-json-schema.mjs";function ar(i){return{name:i.name,description:i.description,parameters:fn(i.schema)}}var sr=p(()=>{});var or={};R(or,{ChatOpenAI:()=>Fe,PromptLayerChatOpenAI:()=>_t});import{Configuration as bn,OpenAIApi as yn}from"/v126/openai@3.3.0/deno/openai.mjs";function wt(i){switch(i){case"system":return"system";case"ai":return"assistant";case"human":return"user";case"function":return"function";default:throw new Error(`Unknown message type: ${i}`)}}function gn(i){switch(i.role){case"user":return new S(i.content||"");case"assistant":return new G(i.content||"",{function_call:i.function_call});case"system":return new Q(i.content||"");default:return new le(i.content||"",i.role??"unknown")}}var Fe,_t,ur=p(()=>{pe();tr();rr();Z();$e();ir();sr();Fe=class extends qe{get callKeys(){return["stop","signal","timeout","options","functions","tools"]}get lc_secrets(){return{openAIApiKey:"OPENAI_API_KEY",azureOpenAIApiKey:"AZURE_OPENAI_API_KEY"}}get lc_aliases(){return{modelName:"model",openAIApiKey:"openai_api_key",azureOpenAIApiVersion:"azure_openai_api_version",azureOpenAIApiKey:"azure_openai_api_key",azureOpenAIApiInstanceName:"azure_openai_api_instance_name",azureOpenAIApiDeploymentName:"azure_openai_api_deployment_name"}}constructor(e,t){super(e??{}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"frequencyPenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"presencePenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"logitBias",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:"gpt-3.5-turbo"}),Object.defineProperty(this,"modelKwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiVersion",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiInstanceName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiDeploymentName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"clientConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let r=e?.openAIApiKey??_("OPENAI_API_KEY"),n=e?.azureOpenAIApiKey??_("AZURE_OPENAI_API_KEY");if(!n&&!r)throw new Error("(Azure) OpenAI API key not found");let a=e?.azureOpenAIApiInstanceName??_("AZURE_OPENAI_API_INSTANCE_NAME"),s=e?.azureOpenAIApiDeploymentName??_("AZURE_OPENAI_API_DEPLOYMENT_NAME"),o=e?.azureOpenAIApiVersion??_("AZURE_OPENAI_API_VERSION");if(this.modelName=e?.modelName??this.modelName,this.modelKwargs=e?.modelKwargs??{},this.timeout=e?.timeout,this.temperature=e?.temperature??this.temperature,this.topP=e?.topP??this.topP,this.frequencyPenalty=e?.frequencyPenalty??this.frequencyPenalty,this.presencePenalty=e?.presencePenalty??this.presencePenalty,this.maxTokens=e?.maxTokens,this.n=e?.n??this.n,this.logitBias=e?.logitBias,this.stop=e?.stop,this.streaming=e?.streaming??!1,this.azureOpenAIApiVersion=o,this.azureOpenAIApiKey=n,this.azureOpenAIApiInstanceName=a,this.azureOpenAIApiDeploymentName=s,this.streaming&&this.n>1)throw new Error("Cannot stream results when n > 1");if(this.azureOpenAIApiKey){if(!this.azureOpenAIApiInstanceName)throw new Error("Azure OpenAI API instance name not found");if(!this.azureOpenAIApiDeploymentName)throw new Error("Azure OpenAI API deployment name not found");if(!this.azureOpenAIApiVersion)throw new Error("Azure OpenAI API version not found")}this.clientConfig={apiKey:r,...t,...e?.configuration}}invocationParams(){return{model:this.modelName,temperature:this.temperature,top_p:this.topP,frequency_penalty:this.frequencyPenalty,presence_penalty:this.presencePenalty,max_tokens:this.maxTokens===-1?void 0:this.maxTokens,n:this.n,logit_bias:this.logitBias,stop:this.stop,stream:this.streaming,...this.modelKwargs}}_identifyingParams(){return{model_name:this.modelName,...this.invocationParams(),...this.clientConfig}}identifyingParams(){return this._identifyingParams()}async _generate(e,t,r){let n={};if(this.stop&&t?.stop)throw new Error("Stop found in input and default params");let a=this.invocationParams();a.stop=t?.stop??a.stop,a.functions=t?.functions??(t?.tools?t?.tools.map(ar):void 0),a.function_call=t?.function_call;let s=e.map(m=>({role:wt(m._getType()),content:m.text,name:m.name})),o=a.stream?await new Promise((m,j)=>{let f,N=!1,oe=!1;this.completionWithRetry({...a,messages:s},{signal:t?.signal,...t?.options,adapter:De,responseType:"stream",onmessage:Ce=>{if(Ce.data?.trim?.()==="[DONE]"){if(oe)return;oe=!0,m(f)}else{let B=JSON.parse(Ce.data);f||(f={id:B.id,object:B.object,created:B.created,model:B.model,choices:[]});for(let P of B.choices)if(P!=null){let A=f.choices.find(Nr=>Nr.index===P.index);A||(A={index:P.index,finish_reason:P.finish_reason??void 0},f.choices[P.index]=A),A.message||(A.message={role:P.delta?.role,content:""}),P.delta.function_call&&!A.message.function_call&&(A.message.function_call={name:"",arguments:""}),A.message.content+=P.delta?.content??"",A.message.function_call&&(A.message.function_call.name+=P.delta?.function_call?.name??"",A.message.function_call.arguments+=P.delta?.function_call?.arguments??""),r?.handleLLMNewToken(P.delta?.content??"")}!oe&&B.choices.every(P=>P.finish_reason!=null)&&(oe=!0,m(f))}}}).catch(Ce=>{N||(N=!0,j(Ce))})}):await this.completionWithRetry({...a,messages:s},{signal:t?.signal,...t?.options}),{completion_tokens:u,prompt_tokens:c,total_tokens:l}=o.usage??{};u&&(n.completionTokens=(n.completionTokens??0)+u),c&&(n.promptTokens=(n.promptTokens??0)+c),l&&(n.totalTokens=(n.totalTokens??0)+l);let h=[];for(let m of o.choices){let j=m.message?.content??"";h.push({text:j,message:gn(m.message??{role:"assistant"})})}return{generations:h,llmOutput:{tokenUsage:n}}}async getNumTokensFromMessages(e){let t=0,r=0,n=0;fe(this.modelName)==="gpt-3.5-turbo"?(r=4,n=-1):fe(this.modelName).startsWith("gpt-4")&&(r=3,n=1);let a=await Promise.all(e.map(async s=>{let o=await this.getNumTokens(s.text),u=await this.getNumTokens(wt(s._getType())),c=s.name!==void 0?n+await this.getNumTokens(s.name):0,l=o+r+u+c;return t+=l,l}));return t+=3,{totalCount:t,countPerMessage:a}}async completionWithRetry(e,t){if(!this.client){let n=this.azureOpenAIApiKey?`https://${this.azureOpenAIApiInstanceName}.openai.azure.com/openai/deployments/${this.azureOpenAIApiDeploymentName}`:this.clientConfig.basePath,a=new bn({...this.clientConfig,basePath:n,baseOptions:{timeout:this.timeout,...this.clientConfig.baseOptions}});this.client=new yn(a)}let r={adapter:at()?void 0:De,...this.clientConfig.baseOptions,...t};return this.azureOpenAIApiKey&&(r.headers={"api-key":this.azureOpenAIApiKey,...r.headers},r.params={"api-version":this.azureOpenAIApiVersion,...r.params}),this.caller.call(this.client.createChatCompletion.bind(this.client),e,r).then(n=>n.data)}_llmType(){return"openai"}_combineLLMOutput(...e){return e.reduce((t,r)=>(r&&r.tokenUsage&&(t.tokenUsage.completionTokens+=r.tokenUsage.completionTokens??0,t.tokenUsage.promptTokens+=r.tokenUsage.promptTokens??0,t.tokenUsage.totalTokens+=r.tokenUsage.totalTokens??0),t),{tokenUsage:{completionTokens:0,promptTokens:0,totalTokens:0}})}},_t=class extends Fe{constructor(e){super(e),Object.defineProperty(this,"promptLayerApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"plTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"returnPromptLayerId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.promptLayerApiKey=e?.promptLayerApiKey??(typeof __Process$<"u"?__Process$.env?.PROMPTLAYER_API_KEY:void 0),this.plTags=e?.plTags??[],this.returnPromptLayerId=e?.returnPromptLayerId??!1}async _generate(e,t,r){let n=Date.now(),a;Array.isArray(t)?a={stop:t}:t?.timeout&&!t.signal?a={...t,signal:AbortSignal.timeout(t.timeout)}:a=t??{};let s=await super._generate(e,a,r),o=Date.now(),u=l=>{let h;if(l._getType()==="human")h={role:"user",content:l.text};else if(l._getType()==="ai")h={role:"assistant",content:l.text};else if(l._getType()==="system")h={role:"system",content:l.text};else if(l._getType()==="generic")h={role:l.role,content:l.text};else throw new Error(`Got unknown type ${l}`);return h},c=(l,h)=>{let m={...this.invocationParams(),model:this.modelName};if(h?.stop&&Object.keys(m).includes("stop"))throw new Error("`stop` found in both the input and default params.");return l.map(f=>u(f))};for(let l=0;l<s.generations.length;l+=1){let h=s.generations[l],m=c(e,a),j,f=[{content:h.text,role:wt(h.message._getType())}],N=await nr(this.caller,"langchain.PromptLayerChatOpenAI",m,this._identifyingParams(),this.plTags,f,n,o,this.promptLayerApiKey);this.returnPromptLayerId===!0&&(N.success===!0&&(j=N.request_id),(!h.generationInfo||typeof h.generationInfo!="object")&&(h.generationInfo={}),h.generationInfo.promptLayerRequestId=j)}return s}}});var wn,be,te,He=p(()=>{ft();$e();yt();z();$e();wn=()=>!1,be=class extends g{get lc_attributes(){return{callbacks:void 0,verbose:void 0}}constructor(e){super(e),Object.defineProperty(this,"verbose",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"callbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.verbose=e.verbose??wn(),this.callbacks=e.callbacks,this.tags=e.tags??[]}},te=class extends be{get callKeys(){return["stop","timeout","signal"]}constructor({callbacks:e,callbackManager:t,...r}){super({callbacks:e??t,...r}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_encoding",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.caller=new ee(r??{})}async getNumTokens(e){let t=Math.ceil(e.length/4);if(!this._encoding)try{this._encoding=await bt("modelName"in this?fe(this.modelName):"gpt2")}catch(r){console.warn("Failed to calculate number of tokens, falling back to approximate count",r)}return this._encoding&&(t=this._encoding.encode(e).length),t}_identifyingParams(){return{}}serialize(){return{...this._identifyingParams(),_type:this._llmType(),_model:this._modelType()}}static async deserialize(e){let{_type:t,_model:r,...n}=e;if(r&&r!=="base_chat_model")throw new Error(`Cannot load LLM with model ${r}`);let a={openai:(await Promise.resolve().then(()=>(ur(),or))).ChatOpenAI}[t];if(a===void 0)throw new Error(`Cannot load  LLM with type ${t}`);return new a(n)}}});function xt(i,e){let t=new Set;for(let r of e)i.has(r)&&t.add(r);return t}function lr(i,e){let t=new Set(i);for(let r of e)t.add(r);return t}function Ue(i,e){let t=new Set(i);for(let r of e)t.delete(r);return t}var cr=p(()=>{});var Pt={};R(Pt,{SequentialChain:()=>ge,SimpleSequentialChain:()=>we});function ye(i){return Array.from(i).map(e=>`"${e}"`).join(", ")}var ge,we,vt=p(()=>{re();cr();ge=class extends y{get inputKeys(){return this.inputVariables}get outputKeys(){return this.outputVariables}constructor(e){if(super(e),Object.defineProperty(this,"chains",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inputVariables",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputVariables",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"returnAll",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.chains=e.chains,this.inputVariables=e.inputVariables,this.outputVariables=e.outputVariables??[],this.outputVariables.length>0&&e.returnAll)throw new Error("Either specify variables to return using `outputVariables` or use `returnAll` param. Cannot apply both conditions at the same time.");this.returnAll=e.returnAll??!1,this._validateChains()}_validateChains(){if(this.chains.length===0)throw new Error("Sequential chain must have at least one chain.");let e=this.memory?.memoryKeys??[],t=new Set(this.inputKeys),r=new Set(e),n=xt(t,r);if(n.size>0)throw new Error(`The following keys: ${ye(n)} are overlapping between memory and input keys of the chain variables. This can lead to unexpected behaviour. Please use input and memory keys that don't overlap.`);let a=lr(t,r);for(let s of this.chains){let o=Ue(new Set(s.inputKeys),a);if(o.size>0)throw new Error(`Missing variables for chain "${s._chainType()}": ${ye(o)}. Only got the following variables: ${ye(a)}.`);let u=new Set(s.outputKeys),c=xt(a,u);if(c.size>0)throw new Error(`The following output variables for chain "${s._chainType()}" are overlapping: ${ye(c)}. This can lead to unexpected behaviour.`);for(let l of u)a.add(l)}if(this.outputVariables.length===0)if(this.returnAll){let s=Ue(a,t);this.outputVariables=Array.from(s)}else this.outputVariables=this.chains[this.chains.length-1].outputKeys;else{let s=Ue(new Set(this.outputVariables),new Set(a));if(s.size>0)throw new Error(`The following output variables were expected to be in the final chain output but were not found: ${ye(s)}.`)}}async _call(e,t){let r={},n=e,a=0;for(let o of this.chains){a+=1,r=await o.call(n,t?.getChild(`step_${a}`));for(let u of Object.keys(r))n[u]=r[u]}let s={};for(let o of this.outputVariables)s[o]=n[o];return s}_chainType(){return"sequential_chain"}static async deserialize(e){let t=[],r=e.input_variables,n=e.output_variables,a=e.chains;for(let s of a){let o=await y.deserialize(s);t.push(o)}return new ge({chains:t,inputVariables:r,outputVariables:n})}serialize(){let e=[];for(let t of this.chains)e.push(t.serialize());return{_type:this._chainType(),input_variables:this.inputVariables,output_variables:this.outputVariables,chains:e}}},we=class extends y{get inputKeys(){return[this.inputKey]}get outputKeys(){return[this.outputKey]}constructor(e){super(e),Object.defineProperty(this,"chains",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inputKey",{enumerable:!0,configurable:!0,writable:!0,value:"input"}),Object.defineProperty(this,"outputKey",{enumerable:!0,configurable:!0,writable:!0,value:"output"}),Object.defineProperty(this,"trimOutputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.chains=e.chains,this.trimOutputs=e.trimOutputs??!1,this._validateChains()}_validateChains(){for(let e of this.chains){if(e.inputKeys.length!==1)throw new Error(`Chains used in SimpleSequentialChain should all have one input, got ${e.inputKeys.length} for ${e._chainType()}.`);if(e.outputKeys.length!==1)throw new Error(`Chains used in SimpleSequentialChain should all have one output, got ${e.outputKeys.length} for ${e._chainType()}.`)}}async _call(e,t){let r=e[this.inputKey],n=0;for(let a of this.chains)n+=1,r=await a.run(r,t?.getChild(`step_${n}`)),this.trimOutputs&&(r=r.trim()),await t?.handleText(r);return{[this.outputKey]:r}}_chainType(){return"simple_sequential_chain"}static async deserialize(e){let t=[],r=e.chains;for(let n of r){let a=await y.deserialize(n);t.push(a)}return new we({chains:t})}serialize(){let e=[];for(let t of this.chains)e.push(t.serialize());return{_type:this._chainType(),chains:e}}}});var pr,_n,Ot,xn,ne,Tt,_e,Be=p(()=>{pr=i=>{let e=i.split(""),t=[],r=(a,s)=>{for(let o=s;o<e.length;o+=1)if(a.includes(e[o]))return o;return-1},n=0;for(;n<e.length;)if(e[n]==="{"&&n+1<e.length&&e[n+1]==="{")t.push({type:"literal",text:"{"}),n+=2;else if(e[n]==="}"&&n+1<e.length&&e[n+1]==="}")t.push({type:"literal",text:"}"}),n+=2;else if(e[n]==="{"){let a=r("}",n);if(a<0)throw new Error("Unclosed '{' in template.");t.push({type:"variable",name:e.slice(n+1,a).join("")}),n=a+1}else{if(e[n]==="}")throw new Error("Single '}' in template.");{let a=r("{}",n),s=(a<0?e.slice(n):e.slice(n,a)).join("");t.push({type:"literal",text:s}),n=a<0?e.length:a}}return t},_n=(i,e)=>pr(i).reduce((t,r)=>{if(r.type==="variable"){if(r.name in e)return t+e[r.name];throw new Error(`Missing value for input ${r.name}`)}return t+r.text},""),Ot={"f-string":_n,jinja2:(i,e)=>""},xn={"f-string":pr,jinja2:i=>[]},ne=(i,e,t)=>Ot[e](i,t),Tt=(i,e)=>xn[e](i),_e=(i,e,t)=>{if(!(e in Ot)){let r=Object.keys(Ot);throw new Error(`Invalid template format. Got \`${e}\`;
                         should be one of ${r}`)}try{let r=t.reduce((n,a)=>(n[a]="foo",n),{});ne(i,e,r)}catch{throw new Error("Invalid prompt schema.")}}});var hr={};R(hr,{FewShotPromptTemplate:()=>D});var D,Et=p(()=>{M();Be();I();D=class extends q{constructor(e){if(super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"examples",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleSelector",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"examplePrompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"suffix",{enumerable:!0,configurable:!0,writable:!0,value:""}),Object.defineProperty(this,"exampleSeparator",{enumerable:!0,configurable:!0,writable:!0,value:`

`}),Object.defineProperty(this,"prefix",{enumerable:!0,configurable:!0,writable:!0,value:""}),Object.defineProperty(this,"templateFormat",{enumerable:!0,configurable:!0,writable:!0,value:"f-string"}),Object.defineProperty(this,"validateTemplate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.assign(this,e),this.examples!==void 0&&this.exampleSelector!==void 0)throw new Error("Only one of 'examples' and 'example_selector' should be provided");if(this.examples===void 0&&this.exampleSelector===void 0)throw new Error("One of 'examples' and 'example_selector' should be provided");if(this.validateTemplate){let t=this.inputVariables;this.partialVariables&&(t=t.concat(Object.keys(this.partialVariables))),_e(this.prefix+this.suffix,this.templateFormat,t)}}_getPromptType(){return"few_shot"}async getExamples(e){if(this.examples!==void 0)return this.examples;if(this.exampleSelector!==void 0)return this.exampleSelector.selectExamples(e);throw new Error("One of 'examples' and 'example_selector' should be provided")}async partial(e){let t={...this};return t.inputVariables=this.inputVariables.filter(r=>!(r in e)),t.partialVariables={...this.partialVariables??{},...e},new D(t)}async format(e){let t=await this.mergePartialAndUserVariables(e),r=await this.getExamples(t),n=await Promise.all(r.map(s=>this.examplePrompt.format(s))),a=[this.prefix,...n,this.suffix].join(this.exampleSeparator);return ne(a,this.templateFormat,t)}serialize(){if(this.exampleSelector||!this.examples)throw new Error("Serializing an example selector is not currently supported");if(this.outputParser!==void 0)throw new Error("Serializing an output parser is not currently supported");return{_type:this._getPromptType(),input_variables:this.inputVariables,example_prompt:this.examplePrompt.serialize(),example_separator:this.exampleSeparator,suffix:this.suffix,prefix:this.prefix,template_format:this.templateFormat,examples:this.examples}}static async deserialize(e){let{example_prompt:t}=e;if(!t)throw new Error("Missing example prompt");let r=await d.deserialize(t),n;if(Array.isArray(e.examples))n=e.examples;else throw new Error("Invalid examples format. Only list or string are supported.");return new D({inputVariables:e.input_variables,examplePrompt:r,examples:n,exampleSeparator:e.example_separator,prefix:e.prefix,suffix:e.suffix,templateFormat:e.template_format})}}});var Je,L,q,M=p(()=>{Z();z();Je=class extends Y{constructor(e){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","prompts","base"]}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.value=e}toString(){return this.value}toChatMessages(){return[new S(this.value)]}},L=class extends g{get lc_attributes(){return{partialVariables:void 0}}constructor(e){super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","prompts",this._getPromptType()]}),Object.defineProperty(this,"inputVariables",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputParser",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"partialVariables",{enumerable:!0,configurable:!0,writable:!0,value:{}});let{inputVariables:t}=e;if(t.includes("stop"))throw new Error("Cannot have an input variable named 'stop', as it is used internally, please rename.");Object.assign(this,e)}async mergePartialAndUserVariables(e){let t=this.partialVariables??{},r={};for(let[a,s]of Object.entries(t))typeof s=="string"?r[a]=s:r[a]=await s();return{...r,...e}}serialize(){throw new Error("Use .toJSON() instead")}static async deserialize(e){switch(e._type){case"prompt":{let{PromptTemplate:t}=await Promise.resolve().then(()=>(I(),At));return t.deserialize(e)}case void 0:{let{PromptTemplate:t}=await Promise.resolve().then(()=>(I(),At));return t.deserialize({...e,_type:"prompt"})}case"few_shot":{let{FewShotPromptTemplate:t}=await Promise.resolve().then(()=>(Et(),hr));return t.deserialize(e)}default:throw new Error(`Invalid prompt type in config: ${e._type}`)}}},q=class extends L{async formatPromptValue(e){let t=await this.format(e);return new Je(t)}}});var At={};R(At,{PromptTemplate:()=>d});var d,I=p(()=>{M();Be();d=class extends q{constructor(e){if(super(e),Object.defineProperty(this,"template",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"templateFormat",{enumerable:!0,configurable:!0,writable:!0,value:"f-string"}),Object.defineProperty(this,"validateTemplate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.assign(this,e),this.validateTemplate){let t=this.inputVariables;this.partialVariables&&(t=t.concat(Object.keys(this.partialVariables))),_e(this.template,this.templateFormat,t)}}_getPromptType(){return"prompt"}async format(e){let t=await this.mergePartialAndUserVariables(e);return ne(this.template,this.templateFormat,t)}static fromExamples(e,t,r,n=`

`,a=""){let s=[a,...e,t].join(n);return new d({inputVariables:r,template:s})}static fromTemplate(e,{templateFormat:t="f-string",...r}={}){let n=new Set;return Tt(e,t).forEach(a=>{a.type==="variable"&&n.add(a.name)}),new d({inputVariables:[...n],templateFormat:t,template:e,...r})}async partial(e){let t={...this};return t.inputVariables=this.inputVariables.filter(r=>!(r in e)),t.partialVariables={...this.partialVariables??{},...e},new d(t)}serialize(){if(this.outputParser!==void 0)throw new Error("Cannot serialize a prompt template with an output parser");return{_type:this._getPromptType(),input_variables:this.inputVariables,template:this.template,template_format:this.templateFormat}}static async deserialize(e){if(!e.template)throw new Error("Prompt template must have a template");return new d({inputVariables:e.input_variables,template:e.template,templateFormat:e.template_format})}}});var We={};R(We,{MapReduceDocumentsChain:()=>ie,RefineDocumentsChain:()=>ae,StuffDocumentsChain:()=>V});var V,ie,ae,xe=p(()=>{re();se();I();V=class extends y{get inputKeys(){return[this.inputKey,...this.llmChain.inputKeys].filter(e=>e!==this.documentVariableName)}get outputKeys(){return this.llmChain.outputKeys}constructor(e){super(e),Object.defineProperty(this,"llmChain",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inputKey",{enumerable:!0,configurable:!0,writable:!0,value:"input_documents"}),Object.defineProperty(this,"documentVariableName",{enumerable:!0,configurable:!0,writable:!0,value:"context"}),this.llmChain=e.llmChain,this.documentVariableName=e.documentVariableName??this.documentVariableName,this.inputKey=e.inputKey??this.inputKey}_prepInputs(e){if(!(this.inputKey in e))throw new Error(`Document key ${this.inputKey} not found.`);let{[this.inputKey]:t,...r}=e,a=t.map(({pageContent:s})=>s).join(`

`);return{...r,[this.documentVariableName]:a}}async _call(e,t){return await this.llmChain.call(this._prepInputs(e),t?.getChild("combine_documents"))}_chainType(){return"stuff_documents_chain"}static async deserialize(e){if(!e.llm_chain)throw new Error("Missing llm_chain");return new V({llmChain:await b.deserialize(e.llm_chain)})}serialize(){return{_type:this._chainType(),llm_chain:this.llmChain.serialize()}}},ie=class extends y{get inputKeys(){return[this.inputKey,...this.combineDocumentChain.inputKeys]}get outputKeys(){return this.combineDocumentChain.outputKeys}constructor(e){super(e),Object.defineProperty(this,"llmChain",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inputKey",{enumerable:!0,configurable:!0,writable:!0,value:"input_documents"}),Object.defineProperty(this,"documentVariableName",{enumerable:!0,configurable:!0,writable:!0,value:"context"}),Object.defineProperty(this,"returnIntermediateSteps",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:3e3}),Object.defineProperty(this,"maxIterations",{enumerable:!0,configurable:!0,writable:!0,value:10}),Object.defineProperty(this,"ensureMapStep",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"combineDocumentChain",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.llmChain=e.llmChain,this.combineDocumentChain=e.combineDocumentChain,this.documentVariableName=e.documentVariableName??this.documentVariableName,this.ensureMapStep=e.ensureMapStep??this.ensureMapStep,this.inputKey=e.inputKey??this.inputKey,this.maxTokens=e.maxTokens??this.maxTokens,this.maxIterations=e.maxIterations??this.maxIterations,this.returnIntermediateSteps=e.returnIntermediateSteps??!1}async _call(e,t){if(!(this.inputKey in e))throw new Error(`Document key ${this.inputKey} not found.`);let{[this.inputKey]:r,...n}=e,a=r,s=[];for(let c=0;c<this.maxIterations;c+=1){let l=a.map(f=>({[this.documentVariableName]:f.pageContent,...n}));if(c!==0||!this.ensureMapStep){let f=await this.combineDocumentChain.llmChain.prompt.format(this.combineDocumentChain._prepInputs({[this.combineDocumentChain.inputKey]:a,...n}));if(await this.combineDocumentChain.llmChain.llm.getNumTokens(f)<this.maxTokens)break}let m=await this.llmChain.apply(l,t?Array.from({length:l.length},(f,N)=>t.getChild(`map_${N+1}`)):void 0),{outputKey:j}=this.llmChain;this.returnIntermediateSteps&&(s=s.concat(m.map(f=>f[j]))),a=m.map(f=>({pageContent:f[j],metadata:{}}))}let o={[this.combineDocumentChain.inputKey]:a,...n},u=await this.combineDocumentChain.call(o,t?.getChild("combine_documents"));return this.returnIntermediateSteps?{...u,intermediateSteps:s}:u}_chainType(){return"map_reduce_documents_chain"}static async deserialize(e){if(!e.llm_chain)throw new Error("Missing llm_chain");if(!e.combine_document_chain)throw new Error("Missing combine_document_chain");return new ie({llmChain:await b.deserialize(e.llm_chain),combineDocumentChain:await V.deserialize(e.combine_document_chain)})}serialize(){return{_type:this._chainType(),llm_chain:this.llmChain.serialize(),combine_document_chain:this.combineDocumentChain.serialize()}}},ae=class extends y{get defaultDocumentPrompt(){return new d({inputVariables:["page_content"],template:"{page_content}"})}get inputKeys(){return[...new Set([this.inputKey,...this.llmChain.inputKeys,...this.refineLLMChain.inputKeys])].filter(e=>e!==this.documentVariableName&&e!==this.initialResponseName)}get outputKeys(){return[this.outputKey]}constructor(e){super(e),Object.defineProperty(this,"llmChain",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inputKey",{enumerable:!0,configurable:!0,writable:!0,value:"input_documents"}),Object.defineProperty(this,"outputKey",{enumerable:!0,configurable:!0,writable:!0,value:"output_text"}),Object.defineProperty(this,"documentVariableName",{enumerable:!0,configurable:!0,writable:!0,value:"context"}),Object.defineProperty(this,"initialResponseName",{enumerable:!0,configurable:!0,writable:!0,value:"existing_answer"}),Object.defineProperty(this,"refineLLMChain",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"documentPrompt",{enumerable:!0,configurable:!0,writable:!0,value:this.defaultDocumentPrompt}),this.llmChain=e.llmChain,this.refineLLMChain=e.refineLLMChain,this.documentVariableName=e.documentVariableName??this.documentVariableName,this.inputKey=e.inputKey??this.inputKey,this.outputKey=e.outputKey??this.outputKey,this.documentPrompt=e.documentPrompt??this.documentPrompt,this.initialResponseName=e.initialResponseName??this.initialResponseName}async _constructInitialInputs(e,t){let r={page_content:e.pageContent,...e.metadata},n={};return this.documentPrompt.inputVariables.forEach(o=>{n[o]=r[o]}),{...{[this.documentVariableName]:await this.documentPrompt.format({...n})},...t}}async _constructRefineInputs(e,t){let r={page_content:e.pageContent,...e.metadata},n={};this.documentPrompt.inputVariables.forEach(o=>{n[o]=r[o]});let a={[this.documentVariableName]:await this.documentPrompt.format({...n})};return{[this.initialResponseName]:t,...a}}async _call(e,t){if(!(this.inputKey in e))throw new Error(`Document key ${this.inputKey} not found.`);let{[this.inputKey]:r,...n}=e,a=r,s=await this._constructInitialInputs(a[0],n),o=await this.llmChain.predict({...s},t?.getChild("answer")),u=[o];for(let c=1;c<a.length;c+=1){let h={...await this._constructRefineInputs(a[c],o),...n};o=await this.refineLLMChain.predict({...h},t?.getChild("refine")),u.push(o)}return{[this.outputKey]:o}}_chainType(){return"refine_documents_chain"}static async deserialize(e){let t=e.llm_chain;if(!t)throw new Error("Missing llm_chain");let r=e.refine_llm_chain;if(!r)throw new Error("Missing refine_llm_chain");return new ae({llmChain:await b.deserialize(t),refineLLMChain:await b.deserialize(r)})}serialize(){return{_type:this._chainType(),llm_chain:this.llmChain.serialize(),refine_llm_chain:this.refineLLMChain.serialize()}}}});var Ct,It,Ge,Qe,H,F,O,Pe=p(()=>{Z();z();M();I();Ct=class extends g{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","prompts","chat"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0})}},It=class extends Y{constructor(e){Array.isArray(e)&&(e={messages:e}),super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","prompts","chat"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"messages",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.messages=e.messages}toString(){return JSON.stringify(this.messages)}toChatMessages(){return this.messages}},Ge=class extends Ct{constructor(e){"prompt"in e||(e={prompt:e}),super(e),Object.defineProperty(this,"prompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.prompt=e.prompt}get inputVariables(){return this.prompt.inputVariables}async formatMessages(e){return[await this.format(e)]}},Qe=class extends L{constructor(e){super(e)}async format(e){return(await this.formatPromptValue(e)).toString()}async formatPromptValue(e){let t=await this.formatMessages(e);return new It(t)}},H=class extends Ge{async format(e){return new S(await this.prompt.format(e))}static fromTemplate(e){return new this(d.fromTemplate(e))}},F=class extends Ge{async format(e){return new Q(await this.prompt.format(e))}static fromTemplate(e){return new this(d.fromTemplate(e))}},O=class extends Qe{get lc_aliases(){return{promptMessages:"messages"}}constructor(e){if(super(e),Object.defineProperty(this,"promptMessages",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"validateTemplate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.assign(this,e),this.validateTemplate){let t=new Set;for(let s of this.promptMessages)for(let o of s.inputVariables)t.add(o);let r=new Set(this.partialVariables?this.inputVariables.concat(Object.keys(this.partialVariables)):this.inputVariables),n=new Set([...r].filter(s=>!t.has(s)));if(n.size>0)throw new Error(`Input variables \`${[...n]}\` are not used in any of the prompt messages.`);let a=new Set([...t].filter(s=>!r.has(s)));if(a.size>0)throw new Error(`Input variables \`${[...a]}\` are used in prompt messages but not in the prompt template.`)}}_getPromptType(){return"chat"}async formatMessages(e){let t=await this.mergePartialAndUserVariables(e),r=[];for(let n of this.promptMessages){let a=n.inputVariables.reduce((o,u)=>{if(!(u in t))throw new Error(`Missing value for input variable \`${u}\``);return o[u]=t[u],o},{}),s=await n.formatMessages(a);r=r.concat(s)}return r}async partial(e){let t={...this};return t.inputVariables=this.inputVariables.filter(r=>!(r in e)),t.partialVariables={...this.partialVariables??{},...e},new O(t)}static fromPromptMessages(e){let t=e.reduce((a,s)=>a.concat(s instanceof O?s.promptMessages:[s]),[]),r=e.reduce((a,s)=>s instanceof O?Object.assign(a,s.partialVariables):a,Object.create(null)),n=new Set;for(let a of t)for(let s of a.inputVariables)s in r||n.add(s);return new O({inputVariables:[...n],promptMessages:t,partialVariables:r})}}});function ve(i){return i._modelType()==="base_chat_model"}var Ye,U,Oe=p(()=>{Ye=class{async getPromptAsync(e,t){return this.getPrompt(e).partial(t?.partialVariables??{})}},U=class extends Ye{constructor(e,t=[]){super(),Object.defineProperty(this,"defaultPrompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"conditionals",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.defaultPrompt=e,this.conditionals=t}getPrompt(e){for(let[t,r]of this.conditionals)if(t(e))return r;return this.defaultPrompt}}});var Pn,vn,On,Tn,mr,dr=p(()=>{I();Pe();Oe();Pn=new d({template:`Use the following pieces of context to answer the question at the end. If you don't know the answer, just say that you don't know, don't try to make up an answer.

{context}

Question: {question}
Helpful Answer:`,inputVariables:["context","question"]}),vn=`Use the following pieces of context to answer the users question. 
If you don't know the answer, just say that you don't know, don't try to make up an answer.
----------------
{context}`,On=[F.fromTemplate(vn),H.fromTemplate("{question}")],Tn=O.fromPromptMessages(On),mr=new U(Pn,[[ve,Tn]])});var fr=p(()=>{I();Pe();Oe()});var yr=p(()=>{M()});var gr=p(()=>{});var wr=p(()=>{gr();M()});var _r=p(()=>{M();Pe()});var xr=p(()=>{M();I();Oe();yr();wr();Et();Pe();Be();_r()});var Pr=p(()=>{xr();Oe()});function vr(i,e={}){let{prompt:t=mr.getPrompt(i),verbose:r}=e,n=new b({prompt:t,llm:i,verbose:r});return new V({llmChain:n,verbose:r})}var Or=p(()=>{se();xe();dr();fr();Pr()});var Tr={};R(Tr,{VectorDBQAChain:()=>Te});var Te,Er=p(()=>{re();Or();Te=class extends y{get inputKeys(){return[this.inputKey]}get outputKeys(){return this.combineDocumentsChain.outputKeys.concat(this.returnSourceDocuments?["sourceDocuments"]:[])}constructor(e){super(e),Object.defineProperty(this,"k",{enumerable:!0,configurable:!0,writable:!0,value:4}),Object.defineProperty(this,"inputKey",{enumerable:!0,configurable:!0,writable:!0,value:"query"}),Object.defineProperty(this,"vectorstore",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"combineDocumentsChain",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"returnSourceDocuments",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.vectorstore=e.vectorstore,this.combineDocumentsChain=e.combineDocumentsChain,this.inputKey=e.inputKey??this.inputKey,this.k=e.k??this.k,this.returnSourceDocuments=e.returnSourceDocuments??this.returnSourceDocuments}async _call(e,t){if(!(this.inputKey in e))throw new Error(`Question key ${this.inputKey} not found.`);let r=e[this.inputKey],n=await this.vectorstore.similaritySearch(r,this.k,e.filter),a={question:r,input_documents:n},s=await this.combineDocumentsChain.call(a,t?.getChild("combine_documents"));return this.returnSourceDocuments?{...s,sourceDocuments:n}:s}_chainType(){return"vector_db_qa"}static async deserialize(e,t){if(!("vectorstore"in t))throw new Error("Need to pass in a vectorstore to deserialize VectorDBQAChain");let{vectorstore:r}=t;if(!e.combine_documents_chain)throw new Error("VectorDBQAChain must have combine_documents_chain in serialized data");return new Te({combineDocumentsChain:await y.deserialize(e.combine_documents_chain),k:e.k,vectorstore:r})}serialize(){return{_type:this._chainType(),combine_documents_chain:this.combineDocumentsChain.serialize(),k:this.k}}static fromLLM(e,t,r){let n=vr(e);return new this({vectorstore:t,combineDocumentsChain:n,...r})}}});var Ar,Cr,An,Ir,jr=p(()=>{I();Ar=`You are given the below API Documentation:
{api_docs}
Using this documentation, generate the full API url to call for answering the user question.
You should build the API url in order to get a response that is as short as possible, while still getting the necessary information to answer the question. Pay attention to deliberately exclude any unnecessary pieces of data in the API call.

Question:{question}
API url:`,Cr=new d({inputVariables:["api_docs","question"],template:Ar}),An=`${Ar} {api_url}

Here is the response from the API:

{api_response}

Summarize this response to answer the original question.

Summary:`,Ir=new d({inputVariables:["api_docs","question","api_url","api_response"],template:An})});var Sr={};R(Sr,{APIChain:()=>Ee});var Ee,kr=p(()=>{re();se();jr();Ee=class extends y{get inputKeys(){return[this.inputKey]}get outputKeys(){return[this.outputKey]}constructor(e){super(e),Object.defineProperty(this,"apiAnswerChain",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiRequestChain",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiDocs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"headers",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"inputKey",{enumerable:!0,configurable:!0,writable:!0,value:"question"}),Object.defineProperty(this,"outputKey",{enumerable:!0,configurable:!0,writable:!0,value:"output"}),this.apiRequestChain=e.apiRequestChain,this.apiAnswerChain=e.apiAnswerChain,this.apiDocs=e.apiDocs,this.inputKey=e.inputKey??this.inputKey,this.outputKey=e.outputKey??this.outputKey,this.headers=e.headers??this.headers}async _call(e,t){let r=e[this.inputKey],n=await this.apiRequestChain.predict({question:r,api_docs:this.apiDocs},t?.getChild("request")),s=await(await fetch(n,{headers:this.headers})).text(),o=await this.apiAnswerChain.predict({question:r,api_docs:this.apiDocs,api_url:n,api_response:s},t?.getChild("response"));return{[this.outputKey]:o}}_chainType(){return"api_chain"}static async deserialize(e){let{api_request_chain:t,api_answer_chain:r,api_docs:n}=e;if(!t)throw new Error("LLMChain must have api_request_chain");if(!r)throw new Error("LLMChain must have api_answer_chain");if(!n)throw new Error("LLMChain must have api_docs");return new Ee({apiAnswerChain:await b.deserialize(r),apiRequestChain:await b.deserialize(t),apiDocs:n})}serialize(){return{_type:this._chainType(),api_answer_chain:this.apiAnswerChain.serialize(),api_request_chain:this.apiRequestChain.serialize(),api_docs:this.apiDocs}}static fromLLMAndAPIDocs(e,t,r={}){let{apiUrlPrompt:n=Cr,apiResponsePrompt:a=Ir}=r,s=new b({prompt:n,llm:e}),o=new b({prompt:a,llm:e});return new this({apiAnswerChain:o,apiRequestChain:s,apiDocs:t,...r})}}});var y,re=p(()=>{Z();mt();He();y=class extends be{get lc_namespace(){return["langchain","chains",this._chainType()]}constructor(e,t,r){if(arguments.length===1&&typeof e=="object"&&!("saveContext"in e)){let{memory:n,callbackManager:a,...s}=e;super({...s,callbacks:a??s.callbacks}),this.memory=n}else super({verbose:t,callbacks:r}),this.memory=e}serialize(){throw new Error("Method not implemented.")}async run(e,t){let r=this.inputKeys.filter(u=>!this.memory?.memoryKeys.includes(u));if(!(r.length<=1))throw new Error(`Chain ${this._chainType()} expects multiple inputs, cannot use 'run' `);let a=r.length?{[r[0]]:e}:{},s=await this.call(a,t),o=Object.keys(s);if(o.length===1)return s[o[0]];throw new Error("return values have multiple keys, `run` only supported when one key currently")}async call(e,t,r){let n={...e};if(this.memory!=null){let u=await this.memory.loadMemoryVariables(e);for(let[c,l]of Object.entries(u))n[c]=l}let s=await(await E.configure(t,this.callbacks,r,this.tags,{verbose:this.verbose}))?.handleChainStart(this.toJSON(),n),o;try{o=await this._call(n,s)}catch(u){throw await s?.handleChainError(u),u}return this.memory!=null&&await this.memory.saveContext(e,o),await s?.handleChainEnd(o),Object.defineProperty(o,Se,{value:s?{runId:s?.runId}:void 0,configurable:!0}),o}async apply(e,t){return Promise.all(e.map(async(r,n)=>this.call(r,t?.[n])))}static async deserialize(e,t={}){switch(e._type){case"llm_chain":{let{LLMChain:r}=await Promise.resolve().then(()=>(se(),Mr));return r.deserialize(e)}case"sequential_chain":{let{SequentialChain:r}=await Promise.resolve().then(()=>(vt(),Pt));return r.deserialize(e)}case"simple_sequential_chain":{let{SimpleSequentialChain:r}=await Promise.resolve().then(()=>(vt(),Pt));return r.deserialize(e)}case"stuff_documents_chain":{let{StuffDocumentsChain:r}=await Promise.resolve().then(()=>(xe(),We));return r.deserialize(e)}case"map_reduce_documents_chain":{let{MapReduceDocumentsChain:r}=await Promise.resolve().then(()=>(xe(),We));return r.deserialize(e)}case"refine_documents_chain":{let{RefineDocumentsChain:r}=await Promise.resolve().then(()=>(xe(),We));return r.deserialize(e)}case"vector_db_qa":{let{VectorDBQAChain:r}=await Promise.resolve().then(()=>(Er(),Tr));return r.deserialize(e,t)}case"api_chain":{let{APIChain:r}=await Promise.resolve().then(()=>(kr(),Sr));return r.deserialize(e)}default:throw new Error(`Invalid prompt type in config: ${e._type}`)}}}});var Mr={};R(Mr,{LLMChain:()=>b});var b,se=p(()=>{re();M();He();b=class extends y{get inputKeys(){return this.prompt.inputVariables}get outputKeys(){return[this.outputKey]}constructor(e){if(super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"prompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"llm",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputKey",{enumerable:!0,configurable:!0,writable:!0,value:"text"}),Object.defineProperty(this,"outputParser",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.prompt=e.prompt,this.llm=e.llm,this.outputKey=e.outputKey??this.outputKey,this.outputParser=e.outputParser??this.outputParser,this.prompt.outputParser){if(this.outputParser)throw new Error("Cannot set both outputParser and prompt.outputParser");this.outputParser=this.prompt.outputParser}}async _getFinalOutput(e,t,r){let n=e[0].text,a;return this.outputParser?a=await this.outputParser.parseWithPrompt(n,t,r?.getChild()):a=n,a}call(e,t){return super.call(e,t)}async _call(e,t){let r={...e},n={};for(let o of this.llm.callKeys)o in e&&(n[o]=e[o],delete r[o]);let a=await this.prompt.formatPromptValue(r),{generations:s}=await this.llm.generatePrompt([a],n,t?.getChild());return{[this.outputKey]:await this._getFinalOutput(s[0],a,t)}}async predict(e,t){return(await this.call(e,t))[this.outputKey]}_chainType(){return"llm"}static async deserialize(e){let{llm:t,prompt:r}=e;if(!t)throw new Error("LLMChain must have llm");if(!r)throw new Error("LLMChain must have prompt");return new b({llm:await te.deserialize(t),prompt:await L.deserialize(r)})}serialize(){return{_type:`${this._chainType()}_chain`,llm:this.llm.serialize(),prompt:this.prompt.serialize()}}}});z();var v=class extends g{async parseWithPrompt(e,t,r){return this.parse(e,r)}_type(){throw new Error("_type not implemented")}},w=class extends Error{constructor(e,t){super(e),Object.defineProperty(this,"output",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.output=t}};var ue=class extends v{},Ze=class extends ue{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","list"]})}async parse(e){try{return e.trim().split(",").map(t=>t.trim())}catch{throw new w(`Could not parse output: ${e}`,e)}}getFormatInstructions(){return"Your response should be a list of comma separated values, eg: `foo, bar, baz`"}},Xe=class extends ue{constructor({length:e,separator:t}){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","list"]}),Object.defineProperty(this,"length",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"separator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.length=e,this.separator=t||","}async parse(e){try{let t=e.trim().split(this.separator).map(r=>r.trim());if(this.length!==void 0&&t.length!==this.length)throw new w(`Incorrect number of items. Expected ${this.length}, got ${t.length}.`);return t}catch(t){throw Object.getPrototypeOf(t)===w.prototype?t:new w(`Could not parse output: ${e}`)}}getFormatInstructions(){return`Your response should be a list of ${this.length} items separated by "${this.separator}" (eg: \`foo${this.separator} bar${this.separator} baz\`)`}};var et=class extends v{constructor(e,t,r){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","regex"]}),Object.defineProperty(this,"regex",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputKeys",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"defaultOutputKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.regex=typeof e=="string"?new RegExp(e):e,this.outputKeys=t,this.defaultOutputKey=r}_type(){return"regex_parser"}async parse(e){let t=e.match(this.regex);if(t)return this.outputKeys.reduce((r,n,a)=>(r[n]=t[a+1],r),{});if(this.defaultOutputKey===void 0)throw new w(`Could not parse output: ${e}`,e);return this.outputKeys.reduce((r,n)=>(r[n]=n===this.defaultOutputKey?e:"",r),{})}getFormatInstructions(){return`Your response should match the following regex: ${this.regex}`}};import{z as Ie}from"/v126/zod@3.21.4/deno/zod.mjs";import{zodToJsonSchema as Rt}from"/v126/zod-to-json-schema@3.21.1/deno/zod-to-json-schema.mjs";var je=class extends v{toJSON(){return this.toJSONNotImplemented()}constructor(e){super(e),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","structured"]})}static fromZodSchema(e){return new this(e)}static fromNamesAndDescriptions(e){let t=Ie.object(Object.fromEntries(Object.entries(e).map(([r,n])=>[r,Ie.string().describe(n)])));return new this(t)}getFormatInstructions(){return`You must format your output as a JSON value that adheres to a given "JSON Schema" instance.

"JSON Schema" is a declarative language that allows you to annotate and validate JSON documents.

For example, the example "JSON Schema" instance {{"properties": {{"foo": {{"description": "a list of test words", "type": "array", "items": {{"type": "string"}}}}}}, "required": ["foo"]}}}}
would match an object with one required property, "foo". The "type" property specifies "foo" must be an "array", and the "description" property semantically describes it as "a list of test words". The items within "foo" must be strings.
Thus, the object {{"foo": ["bar", "baz"]}} is a well-formatted instance of this example "JSON Schema". The object {{"properties": {{"foo": ["bar", "baz"]}}}} is not well-formatted.

Your output will be parsed and type-checked according to the provided schema instance, so make sure all fields in your output match the schema exactly and there are no trailing commas!

Here is the JSON Schema instance your output must adhere to. Include the enclosing markdown codeblock:
\`\`\`json
${JSON.stringify(Rt(this.schema))}
\`\`\`
`}async parse(e){try{let t=e.includes("```")?e.trim().split(/```(?:json)?/)[1]:e.trim();return this.schema.parseAsync(JSON.parse(t))}catch(t){throw new w(`Failed to parse. Text: "${e}". Error: ${t}`,e)}}},J=class extends je{getFormatInstructions(e){let t=e?.interpolationDepth??1;if(t<1)throw new Error("f string interpolation depth must be at least 1");return`Return a markdown code snippet with a JSON object formatted to look like:
\`\`\`json
${this._schemaToInstruction(Rt(this.schema)).replaceAll("{","{".repeat(t)).replaceAll("}","}".repeat(t))}
\`\`\``}_schemaToInstruction(e,t=2){let r=e;if("type"in r){let n=!1,a;if(Array.isArray(r.type)){let u=r.type.findIndex(c=>c==="null");u!==-1&&(n=!0,r.type.splice(u,1)),a=r.type.join(" | ")}else a=r.type;if(r.type==="object"&&r.properties){let u=r.description?` // ${r.description}`:"";return`{
${Object.entries(r.properties).map(([l,h])=>{let m=r.required?.includes(l)?"":" (optional)";return`${" ".repeat(t)}"${l}": ${this._schemaToInstruction(h,t+2)}${m}`}).join(`
`)}
${" ".repeat(t-2)}}${u}`}if(r.type==="array"&&r.items){let u=r.description?` // ${r.description}`:"";return`array[
${" ".repeat(t)}${this._schemaToInstruction(r.items,t+2)}
${" ".repeat(t-2)}] ${u}`}let s=n?" (nullable)":"",o=r.description?` // ${r.description}`:"";return`${a}${o}${s}`}if("anyOf"in r)return r.anyOf.map(n=>this._schemaToInstruction(n,t)).join(`
${" ".repeat(t-2)}`);throw new Error("unsupported schema type")}static fromZodSchema(e){return new this(e)}static fromNamesAndDescriptions(e){let t=Ie.object(Object.fromEntries(Object.entries(e).map(([r,n])=>[r,Ie.string().describe(n)])));return new this(t)}},tt=class extends v{constructor({inputSchema:e}){super(...arguments),Object.defineProperty(this,"structuredInputParser",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.structuredInputParser=new J(e)}async parse(e){let t;try{t=await this.structuredInputParser.parse(e)}catch(r){throw new w(`Failed to parse. Text: "${e}". Error: ${r}`,e)}return this.outputProcessor(t)}getFormatInstructions(){return this.structuredInputParser.getFormatInstructions()}};se();I();var Cn=`Instructions:
--------------
{instructions}
--------------
Completion:
--------------
{completion}
--------------

Above, the Completion did not satisfy the constraints given in the Instructions.
Error:
--------------
{error}
--------------

Please try again. Please only respond with an answer that satisfies the constraints laid out in the Instructions:`,Lr=d.fromTemplate(Cn);var Ae=class extends v{static fromLLM(e,t,r){let n=r?.prompt??Lr,a=new b({llm:e,prompt:n});return new Ae({parser:t,retryChain:a})}constructor({parser:e,retryChain:t}){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","fix"]}),Object.defineProperty(this,"parser",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"retryChain",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.parser=e,this.retryChain=t}async parse(e,t){try{return await this.parser.parse(e,t)}catch(r){if(r instanceof w){let a=(await this.retryChain.call({instructions:this.parser.getFormatInstructions(),completion:e,error:r},t))[this.retryChain.outputKey];return this.parser.parse(a)}throw r}}getFormatInstructions(){return this.parser.getFormatInstructions()}};var jt=class extends v{constructor(...e){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","combining"]}),Object.defineProperty(this,"parsers",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputDelimiter",{enumerable:!0,configurable:!0,writable:!0,value:"-----"}),this.parsers=e}async parse(e,t){let r=e.trim().split(new RegExp(`${this.outputDelimiter}Output \\d+${this.outputDelimiter}`)).slice(1),n={};for(let[a,s]of this.parsers.entries()){let o;try{let u=r[a].includes("```")?r[a].trim().split(/```/)[1]:r[a].trim();u.endsWith(this.outputDelimiter)&&(u=u.slice(0,-this.outputDelimiter.length)),o=await s.parse(u,t)}catch{o=await s.parse(e.trim(),t)}Object.assign(n,o)}return n}getFormatInstructions(){return`${[`Return the following ${this.parsers.length} outputs, each formatted as described below. Include the delimiter characters "${this.outputDelimiter}" in your response:`,...this.parsers.map((e,t)=>`${this.outputDelimiter}Output ${t+1}${this.outputDelimiter}
${e.getFormatInstructions().trim()}
${this.outputDelimiter}`)].join(`

`)}
`}};var St=class extends J{constructor(e,t){super(e),Object.defineProperty(this,"defaultDestination",{enumerable:!0,configurable:!0,writable:!0,value:"DEFAULT"}),this.defaultDestination=t?.defaultDestination??this.defaultDestination}async parse(e){try{let t=await super.parse(e);return t.destination?.toLowerCase()===this.defaultDestination.toLowerCase()&&(t.destination=null),t}catch(t){throw new w(`Failed to parse. Text: "${e}". Error: ${t}`,e)}}};export{tt as AsymmetricStructuredOutputParser,jt as CombiningOutputParser,Ze as CommaSeparatedListOutputParser,Xe as CustomListOutputParser,J as JsonMarkdownStructuredOutputParser,ue as ListOutputParser,Ae as OutputFixingParser,et as RegexParser,St as RouterOutputParser,je as StructuredOutputParser};
//# sourceMappingURL=output_parsers.js.map