/* esm.sh - esbuild bundle(@supabase/realtime-js@2.7.2/dist/module/RealtimeClient) deno production */
import{w3cwebsocket as _}from"/v124/websocket@1.0.34/deno/websocket.mjs";import{VSN as b,CHANNEL_EVENTS as m,TRANSPORTS as C,SOCKET_STATES as u,DEFAULT_TIMEOUT as T,WS_CLOSE_NORMAL as p,DEFAULT_HEADERS as E,CONNECTION_STATE as c}from"/v124/@supabase/realtime-js@2.7.2/deno/dist/module/lib/constants.js";import S from"/v124/@supabase/realtime-js@2.7.2/deno/dist/module/lib/timer.js";import R from"/v124/@supabase/realtime-js@2.7.2/deno/dist/module/lib/serializer.js";import O from"/v124/@supabase/realtime-js@2.7.2/deno/dist/module/RealtimeChannel.js";var f=function(g,t,e,n){function r(i){return i instanceof e?i:new e(function(s){s(i)})}return new(e||(e=Promise))(function(i,s){function h(a){try{l(n.next(a))}catch(d){s(d)}}function o(a){try{l(n.throw(a))}catch(d){s(d)}}function l(a){a.done?i(a.value):r(a.value).then(h,o)}l((n=n.apply(g,t||[])).next())})},y=()=>{},v=class{constructor(t,e){var n;this.accessToken=null,this.channels=[],this.endPoint="",this.headers=E,this.params={},this.timeout=T,this.transport=_,this.heartbeatIntervalMs=3e4,this.heartbeatTimer=void 0,this.pendingHeartbeatRef=null,this.ref=0,this.logger=y,this.conn=null,this.sendBuffer=[],this.serializer=new R,this.stateChangeCallbacks={open:[],close:[],error:[],message:[]},this.eventsPerSecondLimitMs=100,this.inThrottle=!1,this.endPoint=`${t}/${C.websocket}`,e?.params&&(this.params=e.params),e?.headers&&(this.headers=Object.assign(Object.assign({},this.headers),e.headers)),e?.timeout&&(this.timeout=e.timeout),e?.logger&&(this.logger=e.logger),e?.transport&&(this.transport=e.transport),e?.heartbeatIntervalMs&&(this.heartbeatIntervalMs=e.heartbeatIntervalMs);let r=(n=e?.params)===null||n===void 0?void 0:n.eventsPerSecond;r&&(this.eventsPerSecondLimitMs=Math.floor(1e3/r)),this.reconnectAfterMs=e?.reconnectAfterMs?e.reconnectAfterMs:i=>[1e3,2e3,5e3,1e4][i-1]||1e4,this.encode=e?.encode?e.encode:(i,s)=>s(JSON.stringify(i)),this.decode=e?.decode?e.decode:this.serializer.decode.bind(this.serializer),this.reconnectTimer=new S(()=>f(this,void 0,void 0,function*(){this.disconnect(),this.connect()}),this.reconnectAfterMs)}connect(){this.conn||(this.conn=new this.transport(this._endPointURL(),[],null,this.headers),this.conn&&(this.conn.binaryType="arraybuffer",this.conn.onopen=()=>this._onConnOpen(),this.conn.onerror=t=>this._onConnError(t),this.conn.onmessage=t=>this._onConnMessage(t),this.conn.onclose=t=>this._onConnClose(t)))}disconnect(t,e){this.conn&&(this.conn.onclose=function(){},t?this.conn.close(t,e??""):this.conn.close(),this.conn=null,this.heartbeatTimer&&clearInterval(this.heartbeatTimer),this.reconnectTimer.reset())}getChannels(){return this.channels}removeChannel(t){return f(this,void 0,void 0,function*(){let e=yield t.unsubscribe();return this.channels.length===0&&this.disconnect(),e})}removeAllChannels(){return f(this,void 0,void 0,function*(){let t=yield Promise.all(this.channels.map(e=>e.unsubscribe()));return this.disconnect(),t})}log(t,e,n){this.logger(t,e,n)}connectionState(){switch(this.conn&&this.conn.readyState){case u.connecting:return c.Connecting;case u.open:return c.Open;case u.closing:return c.Closing;default:return c.Closed}}isConnected(){return this.connectionState()===c.Open}channel(t,e={config:{}}){this.isConnected()||this.connect();let n=new O(`realtime:${t}`,e,this);return this.channels.push(n),n}push(t){let{topic:e,event:n,payload:r,ref:i}=t,s=()=>{this.encode(t,h=>{var o;(o=this.conn)===null||o===void 0||o.send(h)})};if(this.log("push",`${e} ${n} (${i})`,r),this.isConnected())if(["broadcast","presence","postgres_changes"].includes(n)){if(this._throttle(s)())return"rate limited"}else s();else this.sendBuffer.push(s)}setAuth(t){this.accessToken=t,this.channels.forEach(e=>{t&&e.updateJoinPayload({access_token:t}),e.joinedOnce&&e._isJoined()&&e._push(m.access_token,{access_token:t})})}_makeRef(){let t=this.ref+1;return t===this.ref?this.ref=0:this.ref=t,this.ref.toString()}_leaveOpenTopic(t){let e=this.channels.find(n=>n.topic===t&&(n._isJoined()||n._isJoining()));e&&(this.log("transport",`leaving duplicate topic "${t}"`),e.unsubscribe())}_remove(t){this.channels=this.channels.filter(e=>e._joinRef()!==t._joinRef())}_endPointURL(){return this._appendParams(this.endPoint,Object.assign({},this.params,{vsn:b}))}_onConnMessage(t){this.decode(t.data,e=>{let{topic:n,event:r,payload:i,ref:s}=e;(s&&s===this.pendingHeartbeatRef||r===i?.type)&&(this.pendingHeartbeatRef=null),this.log("receive",`${i.status||""} ${n} ${r} ${s&&"("+s+")"||""}`,i),this.channels.filter(h=>h._isMember(n)).forEach(h=>h._trigger(r,i,s)),this.stateChangeCallbacks.message.forEach(h=>h(e))})}_onConnOpen(){this.log("transport",`connected to ${this._endPointURL()}`),this._flushSendBuffer(),this.reconnectTimer.reset(),this.heartbeatTimer&&clearInterval(this.heartbeatTimer),this.heartbeatTimer=setInterval(()=>this._sendHeartbeat(),this.heartbeatIntervalMs),this.stateChangeCallbacks.open.forEach(t=>t())}_onConnClose(t){this.log("transport","close",t),this._triggerChanError(),this.heartbeatTimer&&clearInterval(this.heartbeatTimer),this.reconnectTimer.scheduleTimeout(),this.stateChangeCallbacks.close.forEach(e=>e(t))}_onConnError(t){this.log("transport",t.message),this._triggerChanError(),this.stateChangeCallbacks.error.forEach(e=>e(t))}_triggerChanError(){this.channels.forEach(t=>t._trigger(m.error))}_appendParams(t,e){if(Object.keys(e).length===0)return t;let n=t.match(/\?/)?"&":"?",r=new URLSearchParams(e);return`${t}${n}${r}`}_flushSendBuffer(){this.isConnected()&&this.sendBuffer.length>0&&(this.sendBuffer.forEach(t=>t()),this.sendBuffer=[])}_sendHeartbeat(){var t;if(this.isConnected()){if(this.pendingHeartbeatRef){this.pendingHeartbeatRef=null,this.log("transport","heartbeat timeout. Attempting to re-establish connection"),(t=this.conn)===null||t===void 0||t.close(p,"hearbeat timeout");return}this.pendingHeartbeatRef=this._makeRef(),this.push({topic:"phoenix",event:"heartbeat",payload:{},ref:this.pendingHeartbeatRef}),this.setAuth(this.accessToken)}}_throttle(t,e=this.eventsPerSecondLimitMs){return()=>this.inThrottle?!0:(t(),e>0&&(this.inThrottle=!0,setTimeout(()=>{this.inThrottle=!1},e)),!1)}};export{v as default};
//# sourceMappingURL=RealtimeClient.js.map